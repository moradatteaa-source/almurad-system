<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø©</title>

  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f6f6f6;
      margin: 0; padding: 0;
    }
    .container {
      padding: 20px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .btn {
      width: 100%;
      padding: 14px;
      text-align: center;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    .btn-primary {
      background: #043B64;
      color: #fff;
    }
    .log-box {
      background: #fff;
      padding: 15px;
      min-height: 200px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      overflow-y: auto;
      max-height: 350px;
    }
    .log-item {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .ok { color: green; font-weight: bold; }
    .err { color: red; font-weight: bold; }
  </style>
</head>
<!-- ğŸ§¾ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØµÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="printArea" style="display:none; font-family: 'Tajawal', sans-serif;">

  <div style="width: 100%; max-width: 380px; margin: auto; padding:20px; border:1px solid #000;">

    <h3 style="text-align:center; margin:0 0 10px;">Shipping Label</h3>

    <div style="font-size:14px; line-height:1.6;">
      <b>Order Nr:</b> <span id="p_orderId"></span><br>
      <b>Tracking Nr:</b> <span id="p_tracking"></span><br>
      <b>Date:</b> <span id="p_date"></span><br><br>

      <b>Shipping Address:</b><br>
      <span id="p_name"></span><br>
      <span id="p_city"></span><br>
      <span id="p_region"></span><br>
      <span id="p_phone"></span><br><br>

      <b>Sender:</b><br>
      eng-murad-organization<br><br>

      <b>Total:</b> <span id="p_total"></span> Ø¯.Ø¹<br>
      <b>Items Quantity:</b> <span id="p_qty"></span><br>
    </div>

    <table style="width:100%; margin-top:15px; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border:1px solid #000; padding:5px;">Item</th>
          <th style="border:1px solid #000; padding:5px;">Qty</th>
          <th style="border:1px solid #000; padding:5px;">Price</th>
        </tr>
      </thead>
      <tbody id="p_items"></tbody>
    </table>

  </div>

</div>

<body>
<header class="header-fixed">
  <span id="backArrow" class="back-arrow">â®</span>
  <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø©</span>
</header>

<style>
.header-fixed {
  position: fixed;
  top: 0;
  right: 0;
  left: 0;
  background: #043B64;
  color: #fff;
  padding: 14px;
  text-align: center;
  font-size: 18px;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.back-arrow {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 22px;
  cursor: pointer;
}

body {
  padding-top: 70px !important; /* Ø­ØªÙ‰ Ù„Ø§ ØªØºØ·ÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„ØµÙØ­Ø© */
}
</style>

<div class="container">
  
  <div class="card">
    <div class="title">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‡ÙŠØ¦Ø© Ù„Ù„Ø±ÙØ¹: <span id="ordersCount">0</span></div>
  </div>

  <button id="startUpload" class="btn btn-primary">
    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø©
  </button>

  <button id="viewLogs" class="btn" style="border:1px solid #043B64;color:#043B64">
    Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø´Ø­Ù†
  </button>

  <h3 style="margin-top:20px;">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h3>
  <div id="logs" class="log-box">
    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯
  </div>

</div>
<script src="./waseetCities.js"></script>
<script src="./waseetRegions.js"></script>




<!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± -->
<script type="module">

import { 
  sendOrdersToWaseet,
  loginToWaseet
} from "./deliveryService.js";

// ğŸ”¥ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Firebase
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";

import {
  getDatabase, ref, get
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
import { update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com",
  projectId: "almurad-system",
  storageBucket: "almurad-system.appspot.com",
  messagingSenderId: "911755824405",
  appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let readyOrders = [];

// ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©
async function loadOrders() {
  const snapshot = await get(ref(db, "orders"));
  if (!snapshot.exists()) return;

  const data = snapshot.val();
  readyOrders = Object.entries(data)
    .map(([id, o]) => ({ id, ...o }))
    .filter(o => o.status === "Ù…Ø«Ø¨Øª");

  document.getElementById("ordersCount").textContent = readyOrders.length;
}

loadOrders();

// ğŸ”¥ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
function addLog(text, cls = "") {
  const box = document.getElementById("logs");
  if (box.innerHTML.includes("Ù„Ø§ ØªÙˆØ¬Ø¯")) box.innerHTML = "";
  box.innerHTML += `<div class="log-item ${cls}">${text}</div>`;
  box.scrollTop = box.scrollHeight;
}

// ğŸ”¥ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø©
document.getElementById("startUpload").onclick = async () => {

  if (readyOrders.length === 0) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ø¨ØªØ© Ù„Ù„Ø±ÙØ¹.");
    return;
  }

  addLog("ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ³ÙŠØ·...");
  const token = await loginToWaseet();

  if (!token) {
    addLog("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "err");
    return;
  }

  addLog("âœ”ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª");
  addLog("ğŸ“¦ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...");

  const result = await sendOrdersToWaseet(
    readyOrders,
    window.waseetCities,
    window.waseetRegions
  );

  addLog(`ğŸ” Ø§Ù„Ù†ØªØ§Ø¦Ø¬:`);
  addLog(`ğŸŸ¢ Ø§Ù„Ù†Ø§Ø¬Ø­: ${result.success} | ğŸ”´ Ø§Ù„ÙØ§Ø´Ù„: ${result.failed}`);
// â­â­â­ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø­Ù†Ø© ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ â­â­â­

// Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø³Ø¬Ù„
const logId = Date.now();

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const user = JSON.parse(localStorage.getItem("loggedInUser") || "{}");

const uploadedBy =
  sessionStorage.getItem("userName") ||
  user.name ||
  user.displayName ||
  user.username ||
  "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

// Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹
const logData = {
  provider: "alwaseet_iq",
  createdAt: new Date().toISOString(),
  uploadedBy: uploadedBy,
  total: result.success + result.failed,
  successCount: result.success,
  failCount: result.failed
};


// Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
await update(ref(db, `shippingLogs/${logId}`), logData);

// Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¬Ù„
for (const entry of result.results) {

const orderKey = entry.receiptNum 
  ? entry.receiptNum.toString() 
  : `${entry.orderId}_${Date.now()}`;

await update(
  ref(db, `shippingLogs/${logId}/orders/${orderKey}`),
  {
    orderId: entry.orderId,
    status: entry.success ? "success" : "fail",
    receiptNum: entry.receiptNum || "",
    reason: entry.reason || extractReason(entry)
  }
);

}


addLog("ğŸ“ ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø­Ù†Ø© Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");

result.results.forEach(async r => {

  if (r.success) {

    addLog(`âœ” Ø§Ù„Ø·Ù„Ø¨ #${r.orderId} â€” Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„: ${r.receiptNum}`, "ok");

    await update(ref(db, `orders/${r.orderId}`), {
      status: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²",
      receiptNum: r.receiptNum.toString(),
      waseet_link: r.qrLink || ""
    });

  } else {

    addLog(`âœ– Ø§Ù„Ø·Ù„Ø¨ #${r.orderId} â€” Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„: ${extractReason(r)}`, "err");

  }

});




};


function extractReason(r) {

  // 1 â€” Ø£Ø®Ø·Ø§Ø¡ ØªØ­Ø¯Ø¯Ù‡Ø§ Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯
  if (r.reason) return r.reason;

  // 2 â€” Ø£Ø®Ø·Ø§Ø¡ ØªØ£ØªÙŠ Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ· Ø¨ØµÙŠØº Ù…Ø®ØªÙ„ÙØ©
  if (r.response?.message) return r.response.message;
  if (r.response?.msg) return r.response.msg;
  if (r.response?.error) return r.response.error;
  if (r.error?.message) return r.error.message;
  if (r.error?.msg) return r.error.msg;

  // 3 â€” Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©
  if (r.cityError) return r.cityError;
  if (r.regionError) return r.regionError;

  // 4 â€” Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙ… Ù†Ø§Ù‚ØµØ© Ø£Ùˆ ØµÙØ±ÙŠØ©
  if (r.missingField) return r.missingField;

  // 5 â€” fallback
  return JSON.stringify(r.response || r.error || r, null, 2);
}

document.getElementById("viewLogs").onclick = () => {
  window.location.href = "shipping-logs.html";
};

document.getElementById("backArrow").onclick = () => {
  window.location.href = "orders-cards.html?status=Ù…Ø«Ø¨Øª";
};
// â­ ØªØ¬Ù‡ÙŠØ² Ø·Ø¨Ø§Ø¹Ø© ÙˆØµÙ„ ÙˆØ§Ø­Ø¯
function printSingleOrder(orderData) {

  document.getElementById("p_orderId").textContent = orderData.orderId || "--";
  document.getElementById("p_tracking").textContent = orderData.receiptNum || "--";
  document.getElementById("p_date").textContent = new Date().toLocaleDateString();

  document.getElementById("p_name").textContent = orderData.name || "";
  document.getElementById("p_city").textContent = orderData.city || "";
  document.getElementById("p_region").textContent = orderData.region || "";
  document.getElementById("p_phone").textContent = orderData.phone || "";

  document.getElementById("p_total").textContent = orderData.total || 0;
  document.getElementById("p_qty").textContent = orderData.items?.length || 1;

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  let html = "";
  if (orderData.items) {
    orderData.items.forEach(i => {
      html += `
        <tr>
          <td style="border:1px solid #000; padding:5px;">${i.name}</td>
          <td style="border:1px solid #000; padding:5px;">${i.qty}</td>
          <td style="border:1px solid #000; padding:5px;">${i.price}</td>
        </tr>
      `;
    });
  }
  document.getElementById("p_items").innerHTML = html;

  printDiv();
}


// â­ ØªØ¬Ù‡ÙŠØ² Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function printAllOrders(ordersArray) {

  document.getElementById("p_orderId").textContent = "Multiple";
  document.getElementById("p_tracking").textContent = "--";
  document.getElementById("p_date").textContent = new Date().toLocaleDateString();

  document.getElementById("p_name").textContent = "";
  document.getElementById("p_city").textContent = "";
  document.getElementById("p_region").textContent = "";
  document.getElementById("p_phone").textContent = "";

  let html = "";
  ordersArray.forEach(o => {
    html += `
      <tr>
        <td style="border:1px solid #000; padding:5px;">Ø·Ù„Ø¨ #${o.orderId}</td>
        <td style="border:1px solid #000; padding:5px;">${o.items?.length || 1}</td>
        <td style="border:1px solid #000; padding:5px;">${o.total || 0}</td>
      </tr>
    `;
  });

  document.getElementById("p_items").innerHTML = html;

  printDiv();
}


// â­ Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
function printDiv() {
  const content = document.getElementById("printArea").innerHTML;
  const original = document.body.innerHTML;

  document.body.innerHTML = content;
  window.print();
  document.body.innerHTML = original;

  location.reload();
}

</script>

</body>
</html>

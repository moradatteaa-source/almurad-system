<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ—‚ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --blue: #043B64;
      --orange: #FF6B2D;
      --bg: #f4f6fa;
      --card-bg: #fff;
      --shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--blue);
    }

    header {
      background: var(--blue);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      box-shadow: var(--shadow);
    }

    header h2 {
      margin: 0;
      font-size: 20px;
    }

    .reset-btn {
      background: var(--orange);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      transition: 0.3s;
    }

    .reset-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .container {
      padding: 25px;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .month-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .month-card:hover {
      transform: translateY(-3px);
    }

    .month-header {
      font-size: 18px;
      font-weight: bold;
      color: var(--blue);
      margin-bottom: 8px;
    }

    .month-stats {
      font-size: 14px;
      color: #333;
      line-height: 1.8;
    }

    .month-stats strong {
      color: var(--orange);
    }

    .details-btn {
      display: inline-block;
      margin-top: 10px;
      background: var(--blue);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: 0.3s;
    }

    .details-btn:hover {
      opacity: 0.9;
    }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ */
    .popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .popup-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: var(--shadow);
      position: relative;
      overflow-y: auto;
      max-height: 90vh;
    }

    .popup h3 {
      margin-top: 0;
      color: var(--blue);
      font-size: 18px;
      border-bottom: 2px solid var(--orange);
      padding-bottom: 6px;
    }

    .close-popup {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--orange);
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      header h2 { font-size: 18px; }
      .reset-btn { font-size: 13px; padding: 8px 16px; }
      .month-card { padding: 15px; }
      .month-header { font-size: 16px; }
    }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ—‚ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</h2>
    <button class="reset-btn" id="resetMonthly">ğŸ§¹ ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
  </header>

  <div class="container">
    <div class="month-grid" id="monthGrid">
      <!-- Ø§Ù„ÙƒØ±ÙˆØª ØªÙÙ†Ø´Ø£ Ù‡Ù†Ø§ -->
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
  <div class="popup" id="detailsPopup">
    <div class="popup-content">
      <button class="close-popup" onclick="closePopup()">Ã—</button>
      <h3 id="popupTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±</h3>
      <div id="popupData"></div>
    </div>
  </div>

  <!-- ğŸ”¹ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø§ÙØ§ Ø³ÙƒØ±Ø¨Øª -->
  <script type="module">
    // ğŸ”¢ Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
function toEnglish(num) {
  if (num === undefined || num === null || isNaN(num)) return "0";
  return Number(num).toLocaleString('en-US');
}
// ğŸ”  ÙØ±Ø¶ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©
function fixEnglishNumbers(text) {
  return text.toString().replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));
}


import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, child, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
  projectId: "almurad-system",
  storageBucket: "almurad-system.appspot.com",
  messagingSenderId: "911755824405",
  appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ğŸŸ  ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©
async function loadArchivedMonths() {
  const grid = document.getElementById("monthGrid");
  grid.innerHTML = "<p style='text-align:center;color:#555;'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ...</p>";

  const dbRef = ref(db);
  const snap = await get(child(dbRef, "archive"));
  if (!snap.exists()) {
    grid.innerHTML = "<p style='text-align:center;color:#999;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø±Ø´ÙØ© Ø¨Ø¹Ø¯.</p>";
    return;
  }

  const data = snap.val();
  const months = Object.keys(data).sort((a,b)=>b.localeCompare(a));
  grid.innerHTML = "";

  for (const month of months) {
    const m = data[month];
    const report = m.report || {};
    report.totalOrders = report.totalOrders || (m.orders ? Object.keys(m.orders).length : 0);

   const card = document.createElement("div");
card.className = "month-card";
card.onclick = () => openMonthDetails(month); // âœ… Ø§Ù„ÙƒØ§Ø±Øª Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·
card.innerHTML = `
  <div class="month-header">ğŸ“… ${month}</div>
  <div class="month-stats">
    âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <strong>${report.totalOrders}</strong><br>
    ğŸ§¾ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: <strong>${(report.totalPurchaseAmount || 0).toLocaleString()} Ø¯.Ø¹</strong><br>
    ğŸ¬ Ø±Ø£Ø³ Ù…Ø§Ù„ Ø§Ù„Ù…Ø®Ø²Ù† (Ø´Ø±Ø§Ø¡): <strong>${(report.totalBuyCapital || 0).toLocaleString()} Ø¯.Ø¹</strong>
  </div>
`;


    grid.appendChild(card);
  }
}

// ğŸŸ¢ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
window.openMonthDetails = async function(month) {
  const popup = document.getElementById("detailsPopup");
  const popupData = document.getElementById("popupData");
  const title = document.getElementById("popupTitle");
  popup.style.display = "flex";
  title.textContent = `ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø´Ù‡Ø± ${month}`;

  const snap = await get(child(ref(db), `archive/${month}`));
  if (!snap.exists()) {
    popupData.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</p>";
    return;
  }

  const d = snap.val();
  const r = d.report || {};
  const stats = d.stats || {}; // âœ… Ø£Ø®Ø° Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
  const purchases = d.purchases || {};
  const orders = d.orders || {};

  // ğŸ§¾ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
  const purchasesCount = Object.keys(purchases).length;
  const totalPurchaseAmount = Object.values(purchases).reduce((a, p) => a + (+p.totalAmount || 0), 0);

  // ğŸ¬ Ø§Ù„Ù…Ø®Ø²Ù† (Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± stats ÙÙ‚Ø·)
  const warehouseCount = stats.totalProducts || 0;
  const totalStockQty = stats.totalQtyAll || 0;
  const totalBuy = stats.totalBuyValue || 0;
  const totalSell = stats.totalSellValue || 0;

  // ğŸšš Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  const totalOrders = r.totalOrders || 0;
  const delivered = r.delivered || 0;
  const returned = r.returned || 0;
  const rejected = r.rejected || 0;

  popupData.innerHTML = `
  <h3>ğŸšš ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
  <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <strong>${totalOrders}</strong></p>
  <p>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…: <strong>${delivered}</strong></p>
  <p>Ø±Ø§Ø¬Ø¹: <strong>${returned}</strong></p>
  <p>Ø±ÙØ¶: <strong>${rejected}</strong></p>

  <h3>ğŸ§¾ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
  <p>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <strong>${purchasesCount}</strong></p>
  <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: <strong>${fixEnglishNumbers(totalPurchaseAmount.toLocaleString('en-US'))} Ø¯.Ø¹</strong></p>
  <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª: <strong>${Object.values(purchases).reduce((a,p)=>a+(+p.totalQty||+p.quantity||0),0)}</strong></p>

  <h3>ğŸ¬ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø²Ù†</h3>
  <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <strong>${warehouseCount}</strong></p>
  <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª: <strong>${totalStockQty}</strong></p>
  <p>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡): <strong>${totalBuy.toLocaleString()} Ø¯.Ø¹</strong></p>
  <p>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø±Ø¯ (Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹): <strong>${totalSell.toLocaleString()} Ø¯.Ø¹</strong></p>

  <h3>ğŸ“… Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</h3>
  <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©: <strong>${r.delivered||0}</strong></p>
  <p>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: <strong>${(r.profitEstimate||0).toLocaleString()} Ø¯.Ø¹</strong></p>
  <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©: ${new Date(r.createdAt || stats.lastUpdate || Date.now()).toLocaleString()}</p>
  `;
};


window.closePopup = function(){ document.getElementById("detailsPopup").style.display="none"; };
// ğŸ”„ Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
async function monthlySmartReset() {
  const dbRef = ref(db);
  const monthKey = new Date().toISOString().slice(0,7); // Ù…Ø«Ù„ 2025-11
  const confirmReset = confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØŸ Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.");

  if (!confirmReset) return;

  try {
 // ğŸ§¾ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø£Ø±Ø´ÙØ© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙ‚Ø·)
const ordersSnap = await get(child(dbRef, "orders"));
let allOrders = {};
if (ordersSnap.exists()) {
  const data = ordersSnap.val();
  for (const [id, o] of Object.entries(data)) {
    if (["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹", "Ø±ÙØ¶"].includes(o.status)) {
      allOrders[id] = o;
    }
  }
}

// Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©
await set(ref(db, `archive/${monthKey}/orders`), allOrders);

// ğŸ”¥ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ (orders)
if (Object.keys(allOrders).length > 0) {
  const remainingOrders = {};
  for (const [id, o] of Object.entries(ordersSnap.val() || {})) {
    if (!["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹", "Ø±ÙØ¶"].includes(o.status)) {
      remainingOrders[id] = o; // Ù†Ø­ØªÙØ¸ ÙÙ‚Ø· Ø¨Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    }
  }
  await set(ref(db, "orders"), remainingOrders);
  console.log("ğŸ§¹ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© Ù…Ù† orders Ø¨Ù†Ø¬Ø§Ø­.");
} else {
  console.log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©.");
}



    // ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    const invoicesSnap = await get(child(dbRef, "invoices"));
    const invoices = invoicesSnap.exists() ? invoicesSnap.val() : {};
    await set(ref(db, `archive/${monthKey}/invoices`), invoices);

    // ğŸ’µ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    const accountsSnap = await get(child(dbRef, "accounts"));
    const accounts = accountsSnap.exists() ? accountsSnap.val() : {};
    await set(ref(db, `archive/${monthKey}/accounts`), accounts);
// ğŸ§¾ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
const purchasesSnap = await get(child(dbRef, "purchases"));
const purchases = purchasesSnap.exists() ? purchasesSnap.val() : {};
await set(ref(db, `archive/${monthKey}/purchases`), purchases);
await set(ref(db, "purchases"), {});
// ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù† (ÙŠÙØ¤Ø±Ø´Ù ÙˆÙ„Ø§ ÙŠÙØµÙÙ‘Ø±)
const warehouseSnap = await get(child(dbRef, "warehouse"));
const warehouseData = warehouseSnap.exists() ? warehouseSnap.val() : {};
await set(ref(db, `archive/${monthKey}/warehouse`), warehouseData);

// ğŸ¬ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± stats/warehouse
let totalProducts = 0, totalStockQty = 0, totalBuyCapital = 0, totalSellCapital = 0, lastUpdate = "";

try {
  const statsSnap = await get(child(dbRef, "stats/warehouse"));
  if (statsSnap.exists()) {
    const stats = statsSnap.val();

    totalProducts = stats.totalProducts || 0;
    totalStockQty = stats.totalQtyAll || 0;
    totalBuyCapital = stats.totalBuyValue || 0;
    totalSellCapital = stats.totalSellValue || 0;
    lastUpdate = stats.lastUpdate || "";

    console.log("ğŸ“¦ ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± stats/warehouse Ø¨Ù†Ø¬Ø§Ø­:", stats);
  } else {
    console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± stats/warehouseØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØµÙØ±ÙŠØ©.");
  }
} catch (err) {
  console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± stats/warehouse:", err);
}




// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø±Ø´ÙŠÙ
const totalOrders = Object.keys(allOrders).length;
let delivered = 0, returned = 0, rejected = 0;

// ğŸ”¸ Ù†Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©
for (const o of Object.values(allOrders)) {
  if (o.status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") delivered++;
  if (["Ø±Ø§Ø¬Ø¹", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"].includes(o.status)) returned++;
  if (o.status === "Ø±ÙØ¶") rejected++;
}

const totalInvoices = Object.keys(invoices).length;
const totalAccounts = Object.keys(accounts).length;
const totalPurchases = Object.keys(purchases).length;
const totalPurchaseAmount = Object.values(purchases).reduce((a,p)=>a+(+p.totalAmount||0),0);
const totalPurchaseQty = Object.values(purchases).reduce((a,p)=>a+(+p.totalQty||+p.quantity||0),0);

await set(ref(db, `archive/${monthKey}/report`), {
  createdAt: new Date().toISOString(),
  delivered,              // âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù„Ù‘Ù…Ø©
  returned,               // âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©
  rejected,               // âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©
  totalOrders,
  totalInvoices,
  totalAccounts,
  totalPurchases,
  totalPurchaseAmount,
  totalPurchaseQty,
  totalProducts,       // âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†
  totalStockQty,       // âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
  totalBuyCapital,     // âœ… Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø´Ø±Ø§Ø¡)
  totalSellCapital,    // âœ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø±Ø¯ (Ø¨ÙŠØ¹)
  lastUpdate,          // âœ… ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ø®Ø²Ù†

  summary: `ğŸ“¦ ØªÙ…Øª Ø£Ø±Ø´ÙØ© ${totalOrders} Ø·Ù„Ø¨ (${delivered} ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŒ ${returned} Ø±Ø§Ø¬Ø¹ØŒ ${rejected} Ø±ÙØ¶)ØŒ ${totalInvoices} ÙØ§ØªÙˆØ±Ø©ØŒ ${totalAccounts} Ø­Ø³Ø§Ø¨ØŒ ${totalPurchases} Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­.`
});

// ğŸ§¾ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ archive/{monthKey}/stats
await set(ref(db, `archive/${monthKey}/stats`), {
  totalProducts,
  totalQtyAll: totalStockQty,
  totalBuyValue: totalBuyCapital,
  totalSellValue: totalSellCapital,
  lastUpdate
});




    alert("âœ… ØªÙ… ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± ÙˆØ£Ø±Ø´ÙØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");
    loadArchivedMonths(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙÙŠØ±:", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙÙŠØ±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
  }
}
// ğŸ§¹ Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
document.getElementById("resetMonthly").addEventListener("click", monthlySmartReset);

// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
loadArchivedMonths();

// ğŸ§¹ Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
document.getElementById("resetMonthly").addEventListener("click", monthlySmartReset);
// âœ… ÙƒÙˆØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: ÙŠØ­ÙˆÙ„ ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© Ø¥Ù„Ù‰ Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±
function convertArabicDigitsToEnglish(element) {
  const arabicDigits = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
  const englishDigits = "0123456789";
  if (element.nodeType === Node.TEXT_NODE) {
    element.textContent = element.textContent.replace(/[Ù -Ù©]/g, d => englishDigits[arabicDigits.indexOf(d)]);
  } else {
    for (const child of element.childNodes) {
      convertArabicDigitsToEnglish(child);
    }
  }
}

// ğŸ” Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙØ­Ø© ÙˆØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ø£Ø±Ù‚Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
const observer = new MutationObserver(() => convertArabicDigitsToEnglish(document.body));
observer.observe(document.body, { childList: true, subtree: true });

// ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£ÙŠØ¶Ù‹Ø§
document.addEventListener("DOMContentLoaded", () => {
  convertArabicDigitsToEnglish(document.body);
});

</script> 
</body> 
</html>

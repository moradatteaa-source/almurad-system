<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f5f6fa;
}
body{font-family:'Tajawal',sans-serif;background:var(--bg);margin:0;color:#222}
header{background:var(--blue);color:#fff;text-align:center;padding:14px;font-weight:700}
.container{max-width:1200px;margin:20px auto;padding:16px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:center;justify-content:center}
select,input{padding:8px;border:1px solid #ccc;border-radius:8px}
button{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
.card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);text-align:center;transition:0.3s}
.card:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.card h3{margin:0;color:var(--blue);font-size:14px}
.card p{margin:6px 0 0;font-weight:700;font-size:20px}
.chart-container{background:#fff;border-radius:10px;padding:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
canvas{width:100%!important;height:auto!important}
.table-wrap{background:#fff;border-radius:8px;padding:10px;margin-top:18px;box-shadow:0 2px 8px rgba(0,0,0,0.05);overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:700px}
th,td{padding:8px;text-align:center;border-bottom:1px solid #eee}
th{background:#f9fafc;color:var(--blue)}
.tips{background:#fff;margin-top:16px;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
.hidden{display:none!important}
@media(max-width:768px){
  .charts{display:flex;flex-direction:column}
  .cards{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<header>ğŸ‘¨â€ğŸ’¼ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</header>

<div class="container">
  <div class="controls">
    <label>Ø§Ù„Ù…ÙˆØ¸Ù:</label>
    <select id="userSelect"></select>
    <label>Ù…Ù†:</label>
    <input type="date" id="fromDate">
    <label>Ø¥Ù„Ù‰:</label>
    <input type="date" id="toDate">
    <button id="applyBtn">ØªØ·Ø¨ÙŠÙ‚</button>
  </div>

  <!-- ğŸ”¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª -->
  <div class="table-wrap" id="commissionSection">
    <h3 style="color:var(--blue)">ğŸ’° ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù</h3>
    <table id="commissionTable">
      <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ù„ÙƒÙ„ Ø·Ù„Ø¨ (Ø¯ÙŠÙ†Ø§Ø±)</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="saveCommission">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</button>
  </div>

  <div class="cards" id="statusCards"></div>
  
  <div class="chart-container">
    <canvas id="mainChart"></canvas>
  </div>

  <div class="table-wrap" id="summaryTableWrap">
    <h3 style="color:var(--blue)">ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
          <th>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
          <th>Ø±Ø§Ø¬Ø¹</th>
          <th>Ø±ÙØ¶</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
          <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø§Ø¬Ø¹</th>
          <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø¯ÙŠÙ†Ø§Ø±)</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><th colspan="7" style="text-align:right">ğŸ’° Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</th><th id="totalCommissionCell">0</th></tr>
      </tfoot>
    </table>
  </div>

  <div class="table-wrap" id="ordersWrap">
    <h3 style="color:var(--blue)">ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>#</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="tips" id="tipsBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const config = {
  apiKey:"AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain:"almurad-system.firebaseapp.com",
  databaseURL:"https://almurad-system-default-rtdb.firebaseio.com/",
  projectId:"almurad-system"
};
const app = initializeApp(config);
const db = getDatabase(app);

// ğŸ§® Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª (ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§)
let commissionRates = JSON.parse(localStorage.getItem("commissionRates") || "{}");

const selectEl=document.getElementById('userSelect');
const fromEl=document.getElementById('fromDate');
const toEl=document.getElementById('toDate');
const applyBtn=document.getElementById('applyBtn');
const tbody=document.querySelector('#ordersTable tbody');
const summaryBody=document.querySelector('#summaryTable tbody');
const totalCommissionCell=document.getElementById('totalCommissionCell');
const cards=document.getElementById('statusCards');
const tipsBox=document.getElementById('tipsBox');
const commissionBody=document.querySelector('#commissionTable tbody');
const saveCommissionBtn=document.getElementById('saveCommission');
const commissionSection=document.getElementById('commissionSection');
const summaryTableWrap=document.getElementById('summaryTableWrap');
let chart;
let allOrders=[];

onValue(ref(db,'orders'),snap=>{
  if(!snap.exists())return;
  allOrders=Object.values(snap.val());
  populateUsers();
  render();
});

function populateUsers(){
  const users=[...new Set(allOrders.map(o=>o.fixedBy||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))];
  selectEl.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>`;
  commissionBody.innerHTML="";
  users.forEach(u=>{
    const opt=document.createElement('option');
    opt.value=u;opt.textContent=u;
    selectEl.appendChild(opt);

    // ğŸ”¸ ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª
    const rate=commissionRates[u]||250;
    commissionBody.innerHTML+=`
      <tr>
        <td>${u}</td>
        <td><input type="number" id="rate_${u}" value="${rate}" style="width:100px"></td>
      </tr>`;
  });
}

saveCommissionBtn.onclick=()=>{
  const rows=document.querySelectorAll('#commissionTable tbody tr');
  rows.forEach(r=>{
    const name=r.cells[0].textContent;
    const rate=Number(r.querySelector('input').value)||0;
    commissionRates[name]=rate;
  });
  localStorage.setItem("commissionRates",JSON.stringify(commissionRates));
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
  render();
};

applyBtn.onclick=()=>render();

function toDateObj(d){if(!d)return null;const n=new Date(d);return isNaN(n)?null:n;}

function render(){
  const from=fromEl.value?new Date(fromEl.value+'T00:00:00'):null;
  const to=toEl.value?new Date(toEl.value+'T23:59:59'):null;
  const user=selectEl.value;
  
  const filtered=allOrders.filter(o=>{
    const dt=toDateObj(o.updatedAt||o.orderDate)||new Date();
    if(from&&dt<from)return false;
    if(to&&dt>to)return false;
    if(user&&(o.fixedBy)!==user)return false;
    return true;
  });

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  if(user===""){
    commissionSection.classList.remove('hidden');
    summaryTableWrap.classList.remove('hidden');
    renderAllEmployees(filtered);
  } else {
    commissionSection.classList.add('hidden');
    summaryTableWrap.classList.add('hidden');
    renderSingleUser(filtered,user);
  }
}

function renderAllEmployees(filtered){
  const usersData={};
  filtered.forEach(o=>{
    const u=o.fixedBy||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    usersData[u]=usersData[u]||{del:0,ret:0,rej:0,total:0};
    usersData[u].total++;
    if(o.status==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…")usersData[u].del++;
    if(o.status==="Ø±Ø§Ø¬Ø¹")usersData[u].ret++;
    if(o.status==="Ø±ÙØ¶")usersData[u].rej++;
  });

  const summary=[];
  for(const u in usersData){
    const d=usersData[u];
    const rate=d.total?((d.del/d.total)*100).toFixed(1):0;
    const retRate=d.total?((d.ret/d.total)*100).toFixed(1):0;
    const commission=(d.del*(commissionRates[u]||250));
    summary.push({u,rate,retRate,commission,...d});
  }
  summary.sort((a,b)=>b.rate-a.rate);

  const totalCommission=summary.reduce((a,b)=>a+b.commission,0);
  totalCommissionCell.textContent=totalCommission.toLocaleString();

  const ctx=document.getElementById('mainChart').getContext('2d');
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:summary.map(s=>s.u),
      datasets:[
        {label:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',data:summary.map(s=>s.del),backgroundColor:'#198754'},
        {label:'Ø±Ø§Ø¬Ø¹',data:summary.map(s=>s.ret),backgroundColor:'#FF6B2D'},
        {label:'Ø±ÙØ¶',data:summary.map(s=>s.rej),backgroundColor:'#DC3545'}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
  });

  summaryBody.innerHTML=summary.map(s=>`
    <tr>
      <td>${s.u}</td>
      <td>${s.del}</td>
      <td>${s.ret}</td>
      <td>${s.rej}</td>
      <td>${s.total}</td>
      <td>${s.rate}%</td>
      <td>${s.retRate}%</td>
      <td>${s.commission.toLocaleString()}</td>
    </tr>
  `).join('');

  cards.innerHTML=`
    <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><p>${filtered.length}</p></div>
    <div class="card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3><p>${Object.keys(usersData).length}</p></div>
    <div class="card"><h3>Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡</h3><p>${summary[0]?.u||'-'}</p></div>
    <div class="card"><h3>ğŸ’° Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</h3><p>${totalCommission.toLocaleString()}</p></div>
  `;

  tbody.innerHTML="";
  tipsBox.innerHTML=`<h3 style="color:var(--blue)">ğŸ’¡ ØªÙˆØµÙŠØ§Øª Ø¹Ø§Ù…Ø©</h3>
  <p>ØªÙ… Ø¹Ø±Ø¶ ${summary.length} Ù…ÙˆØ¸Ù.</p>
  <p>Ø£Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø²: <b>${summary[0]?.u}</b> (${summary[0]?.rate}%)</p>`;
}

function renderSingleUser(filtered,user){
  const counts={Ù…Ø«Ø¨Øª:0,"ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…":0,Ø±Ø§Ø¬Ø¹:0,Ø±ÙØ¶:0,total:0};
  filtered.forEach(o=>{const st=(o.status||"").trim();counts[st]=(counts[st]||0)+1;counts.total++;});
  const delivered=counts["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"]||0;
  const returned=counts.Ø±Ø§Ø¬Ø¹||0;
  const rejected=counts.Ø±ÙØ¶||0;
  const rate=counts.total?((delivered/counts.total)*100).toFixed(1):0;
  const returnRate=counts.total?((returned/counts.total)*100).toFixed(1):0;
  const commission=(delivered*(commissionRates[user]||250));

  cards.innerHTML=`
    <div class="card"><h3>ğŸ“¦ Ù…Ø«Ø¨Øª</h3><p>${counts.Ù…Ø«Ø¨Øª}</p></div>
    <div class="card"><h3>ğŸšš ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</h3><p>${delivered}</p></div>
    <div class="card"><h3>ğŸ” Ø±Ø§Ø¬Ø¹</h3><p>${returned}</p></div>
    <div class="card"><h3>âŒ Ø±ÙØ¶</h3><p>${rejected}</p></div>
    <div class="card"><h3>â­ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h3><p>${rate}%</p></div>
    <div class="card"><h3>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø§Ø¬Ø¹</h3><p>${returnRate}%</p></div>
    <div class="card"><h3>ğŸ’° Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</h3><p>${commission.toLocaleString()}</p></div>
  `;

  const ctx=document.getElementById('mainChart').getContext('2d');
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…','Ø±Ø§Ø¬Ø¹','Ø±ÙØ¶'],
      datasets:[{data:[delivered,returned,rejected],backgroundColor:['#198754','#FF6B2D','#DC3545']}]
    },
    options:{plugins:{legend:{position:'bottom'}}}
  });

  tbody.innerHTML="";
  filtered.sort((a,b)=>new Date(b.updatedAt||b.orderDate)-new Date(a.updatedAt||a.orderDate))
  .forEach((o,i)=>{
    const d=toDateObj(o.updatedAt||o.orderDate);
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${o.code||'-'}</td><td>${o.productName||'-'}</td>
    <td>${o.price||0}</td><td>${o.city||'-'}</td><td>${o.status||'-'}</td><td>${d?d.toLocaleString():'-'}</td><td>${o.fixedBy||'-'}</td></tr>`;
  });

  tipsBox.innerHTML=`<h3 style="color:var(--blue)">ğŸ’¡ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù</h3>
  <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <b>${counts.total}</b></p>
  <p>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…: <b>${delivered}</b> | Ø§Ù„Ø±Ø§Ø¬Ø¹: <b>${returned}</b> | Ø§Ù„Ø±ÙØ¶: <b>${rejected}</b></p>
  <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: <b>${rate}%</b> | Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø§Ø¬Ø¹: <b>${returnRate}%</b></p>
  <p>ğŸ’° Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: <b>${commission.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</b></p>
  ${rate>85?'<p style="color:#198754">ğŸ† Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²!</p>':''}
  ${returnRate>20?'<p style="color:#DC3545">âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù…Ø±ØªÙØ¹Ø©.</p>':''}`;
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <style>
    :root {
      --main-blue: #043B64;
      --accent-orange: #FF6B2D;
      --background-gray: #f2f3f5;
      --border-radius: 12px;
    }

    body {
      font-family: Tahoma, Arial;
      background: var(--background-gray);
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: var(--main-blue);
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 18px;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .container {
      max-width: 800px;
      margin: 25px auto;
      padding: 10px;
    }

    .card {
      background: var(--background-gray);
      border-radius: var(--border-radius);
      box-shadow: none;
      padding: 15px 20px;
      margin-bottom: 15px;
    }

    .row {
      display: flex;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .field.small {
      flex: none;
      width: 140px;
    }

    .field.single {
      max-width: 280px;
      margin: 0 auto 15px auto;
    }

    label {
      color: var(--main-blue);
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 13px;
    }

    input, textarea {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 9px 10px;
      font-size: 13px;
      width: 100%;
      background: #fff;
      transition: all 0.2s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-orange);
      box-shadow: 0 0 4px rgba(255,107,45,0.3);
    }

    textarea {
      resize: vertical;
      height: 60px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      width: 100%;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      transition: all 0.2s;
    }

    #saveBtn {
      background: var(--accent-orange);
      color: white;
    }

    #backBtn {
      background: var(--main-blue);
      color: white;
    }

    #saveBtn:hover, #backBtn:hover {
      opacity: 0.9;
      transform: scale(1.01);
    }

    #savedMsg {
      text-align: center;
      color: green;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }

    .add-small-btn {
      background: rgba(4,59,100,0.08);
      color: #043B64;
      border: 1px dashed #043B64;
      border-radius: 8px;
      padding: 6px 10px;
      width: 55%;
      font-size: 13px;
      cursor: pointer;
      margin: 8px auto;
      display: block;
      font-weight: 600;
      transition: all 0.2s;
    }

    .add-small-btn:hover {
      background: #043B64;
      color: #fff;
      transform: scale(1.03);
    }

   /* ğŸ”¹ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© */
.extra-product {
  background: #fff;
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  position: relative;
}


/* ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
.extra-product:hover {
  transform: scale(1.01);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}


    .delete-btn {
      color: red;
      cursor: pointer;
      font-size: 20px;
      text-align: left;
    }

    #productTagsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .container { margin: 10px; }
      .card { padding: 10px; }
      .field.small { width: 130px; }
      .field.single { max-width: 100%; }
    }

    input, select, textarea { font-size: 16px !important; }
    /* âœ… Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØªØºØ·ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
@media (max-width: 768px) {
  html, body {
    touch-action: manipulation; /* âœ… Ù‡Ø°Ø§ ÙÙ‚Ø· ÙŠØ¨Ù‚Ù‰ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ */
  }

  input, select, textarea, button {
    font-size: 16px !important;
  }
}

/* âœ… Ø¬Ø¹Ù„ Ø§Ù„ØµÙØ­Ø© ØªØºØ·ÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© */
html, body {
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  background: var(--background-gray);
  box-sizing: border-box;
}


  </style>
</head>

<body>
  <header>â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</header>

  <div class="container">

    <div class="card">
      <div class="field single">
        <label>Ø§Ù„ÙƒÙˆØ¯:</label>
        <input id="code" type="text">
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="field small">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£ÙˆÙ„:</label>
          <input id="phone1" type="text">
        </div>
        <div class="field small">
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ:</label>
          <input id="phone2" type="text">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="field small">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
          <div id="city"></div>
        </div>
        <div class="field small">
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
          <div id="area"></div>
        </div>
      </div>

      <div class="field single">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„:</label>
        <textarea id="address"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="field single">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
        <div id="product"></div>
      </div>

      <div id="productTagsContainer"></div>
        <!-- ğŸŸ¢ Ù…ÙƒØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬ -->
  <div id="variantsContainer"></div>


      <div class="row">
        <div class="field small">
          <label>Ø§Ù„Ø³Ø¹Ø±:</label>
<input id="price" type="text" inputmode="numeric" pattern="[0-9,]*">
        </div>
        <div class="field small">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</label>
          <input id="quantity" type="number">
        </div>
      </div>
    </div>

    <div id="extraProducts"></div>
    <button id="addProductBtn" class="add-small-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</button>

    <div id="totalsCard" style="display:none;">
      <div class="row">
        <div class="field small">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯:</label>
          <input id="totalQty" readonly>
        </div>
        <div class="field small">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±:</label>
          <input id="totalPrice" readonly>
        </div>
      </div>
    </div>

    <div class="field single">
      <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
      <textarea id="notes"></textarea>
    </div>

    <div class="card">
      <div class="row">
        <div class="field small">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label>
          <div id="status"></div>
        </div>
        <div class="field small">
          <label>Ø§Ù„Ù…Ø¹Ù„Ù†:</label>
          <input id="advertiser" type="text">
        </div>
      </div>
    </div>

    <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="backBtn">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
    <div id="savedMsg">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­</div>
  </div>
    <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    import { citiesData, allCities } from "./citiesData.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

    const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let mainProductObj = {}; // âœ… ØªØ¹Ø±ÙŠÙ Ø¹Ø§Ù…


    // ğŸ”¹ Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø³Ø¯Ù„Ø©
    function createDropdown(options, selected, onChange) {
      const wrapper = document.createElement("div");
      const input = document.createElement("input");
      input.type = "text";
      input.value = selected || "";
      input.placeholder = "Ø§Ø®ØªØ±...";
      input.style.cursor = "pointer";

      const dropdown = document.createElement("div");
      Object.assign(dropdown.style, {
        position: "absolute",
        background: "#fff",
        border: "1px solid #ccc",
        borderRadius: "6px",
        boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
        maxHeight: "200px",
        overflowY: "auto",
        zIndex: "9999",
        display: "none",
        fontSize: "12px"
      });

      function renderList(filter = "") {
        dropdown.innerHTML = "";
        options.filter(o => o.includes(filter)).forEach(o => {
          const opt = document.createElement("div");
          opt.textContent = o;
          opt.style.padding = "5px 8px";
          opt.style.cursor = "pointer";
          opt.addEventListener("click", () => {
            input.value = o;
            dropdown.style.display = "none";
            onChange(o);
          });
          dropdown.appendChild(opt);
        });
      }

      input.addEventListener("focus", () => {
        dropdown.style.display = "block";
        renderList();
      });

      input.addEventListener("input", e => renderList(e.target.value.trim()));
      document.addEventListener("click", e => {
        if (!wrapper.contains(e.target)) dropdown.style.display = "none";
      });

      wrapper.style.position = "relative";
      wrapper.appendChild(input);
      wrapper.appendChild(dropdown);
      return wrapper;
    }

   // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† "warehouse"
let allProducts = [];

onValue(ref(db, "warehouse"), (snap) => {
  if (snap.exists()) {
    const data = snap.val();

    // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒÙ…ÙØ§ØªÙŠØ­ Ù…Ø¨Ø§Ø´Ø±Ø©
    allProducts = Object.keys(data);

    // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    setupDropdowns();
  } else {
    allProducts = [];
  }
});

// ğŸŸ¦ ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙ‚Ø· (ØªØµÙÙŠØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
async function loadVariantsForProduct(container, productName, productObj) {
  // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
  const existingVariants = container.querySelector(".variants-container");
  if (existingVariants) existingVariants.remove();

  const variantsDiv = document.createElement("div");
  variantsDiv.className = "variants-container";
  variantsDiv.style.marginTop = "10px";

  const snap = await get(ref(db, `warehouse/${productName}`));
  if (!snap.exists()) return;
  const productData = snap.val();

  const stock = productData.stock || {};
  const activeKeys = Object.entries(stock)
    .filter(([key, val]) => Number(val) > 0 && key !== "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©")
    .map(([key]) => key);

  if (activeKeys.length === 0) return;

  // ğŸ§© Ø¨Ù†Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  const variantsMap = {};
  activeKeys.forEach(key => {
    const parts = key.split("|").map(s => s.trim());
    for (let i = 0; i < parts.length; i += 2) {
      const name = parts[i];
      const value = parts[i + 1];
      if (!variantsMap[name]) variantsMap[name] = new Set();
      variantsMap[name].add(value);
    }
  });

  productObj.selectedVariants = {};
  const selectedVariants = productObj.selectedVariants;

  // ğŸ” ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ø´ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ø¹ Ø§Ù„ØªØµÙÙŠØ©
  const addVariantDropdown = (variantName, possibleValues) => {
    const label = document.createElement("label");
    label.textContent = variantName + ":";
    label.style.color = "#043B64";
    label.style.fontWeight = "600";
    label.style.marginTop = "6px";

    const dropdown = createDropdown(possibleValues, "", val => {
      selectedVariants[variantName] = val;

      // ğŸ”„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
      const allFields = Array.from(variantsDiv.querySelectorAll(".field.single"));
      const index = allFields.findIndex(f => f.querySelector("label")?.textContent.includes(variantName));
      allFields.slice(index + 1).forEach(el => el.remove());

      // ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      const filteredKeys = activeKeys.filter(key =>
        Object.entries(selectedVariants).every(([k, v]) => key.includes(`${k} | ${v}`))
      );

      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
      const nextMap = {};
      filteredKeys.forEach(k => {
        const parts = k.split("|").map(s => s.trim());
        for (let i = 0; i < parts.length; i += 2) {
          const name = parts[i];
          const value = parts[i + 1];
          if (!nextMap[name]) nextMap[name] = new Set();
          nextMap[name].add(value);
        }
      });

      const variantNames = Object.keys(variantsMap);
      const nextIndex = variantNames.indexOf(variantName) + 1;
      if (nextIndex < variantNames.length) {
        const nextName = variantNames[nextIndex];
        if (nextMap[nextName]) {
          addVariantDropdown(nextName, Array.from(nextMap[nextName]));
        }
      }
    });

    const fieldDiv = document.createElement("div");
    fieldDiv.className = "field single";
    fieldDiv.appendChild(label);
    fieldDiv.appendChild(dropdown);
    variantsDiv.appendChild(fieldDiv);
  };

  // ğŸŸ¢ Ø£ÙˆÙ„ Ù…ØªØºÙŠØ± ÙÙ‚Ø· Ø¨Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  const firstVariant = Object.keys(variantsMap)[0];
  if (firstVariant) {
    addVariantDropdown(firstVariant, Array.from(variantsMap[firstVariant]));
  }

  // ğŸ”¸ Ø¹Ø±Ø¶ ÙÙŠ Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„ØµØ­ÙŠØ­ (Ø±Ø¦ÙŠØ³ÙŠ Ø£Ùˆ Ø¥Ø¶Ø§ÙÙŠ)
  const mainVariantsDiv = document.getElementById("variantsContainer");
  if (container.id === "product" || container.classList.contains("card")) {
    mainVariantsDiv.innerHTML = "";
    mainVariantsDiv.appendChild(variantsDiv);
  } else {
    container.appendChild(variantsDiv);
  }
}



    // ğŸŸ  Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let extraProducts = [];

    // ğŸ”¹ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ø¶Ø§ÙÙŠ
    function addExtraProduct(product = { name: "", price: 0, qty: 0 }) {
      const card = document.createElement("div");
      card.className = "extra-product";

      const nameField = document.createElement("div");
      nameField.className = "field single";
      const nameLabel = document.createElement("label");
      nameLabel.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:";
      const dropdownContainer = document.createElement("div");
      const dropdown = createDropdown(allProducts, product.name, async val => {
  product.name = val;
  renderProductTags();
  await loadVariantsForProduct(card, val, product); // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
});

      dropdownContainer.appendChild(dropdown);
      nameField.appendChild(nameLabel);
      nameField.appendChild(dropdownContainer);

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="field small">
          <label>Ø§Ù„Ø³Ø¹Ø±:</label>
          <input type="number" class="price-input" value="${product.price || ""}">
        </div>
        <div class="field small">
          <label>Ø§Ù„Ø¹Ø¯Ø¯:</label>
          <input type="number" class="qty-input" value="${product.qty || ""}">
        </div>
      `;

      const del = document.createElement("span");
del.className = "delete-btn";
del.textContent = "ğŸ—‘";
del.style.cursor = "pointer";
del.style.fontSize = "20px";
del.title = "Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬";

// âœ… Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
del.addEventListener("click", (e) => {
  e.stopPropagation(); // ÙŠÙ…Ù†Ø¹ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø¯Ø« Ø«Ø§Ù†ÙŠ
  card.remove();
  extraProducts = extraProducts.filter(p => p !== product);
  updateTotals();
  renderProductTags();
});


      card.appendChild(nameField);
      card.appendChild(row);
      card.appendChild(del);
      document.getElementById("extraProducts").appendChild(card);

      const priceInput = row.querySelector(".price-input");
      const qtyInput = row.querySelector(".qty-input");

      priceInput.addEventListener("input", () => {
        product.price = parseFloat(priceInput.value) || 0;
        updateTotals();
      });
      qtyInput.addEventListener("input", () => {
        product.qty = parseFloat(qtyInput.value) || 0;
        updateTotals();
      });

      extraProducts.push(product);
      updateTotals();
      document.getElementById("totalsCard").style.display = "block";
      renderProductTags();
    }

function updateTotals() {
  // ğŸ”¹ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¶Ø±Ø¨
  const mainQty = parseFloat(document.getElementById("quantity").value) || 0;
  const mainPriceRaw = document.getElementById("price").value.replace(/,/g, "");
  const mainPrice = parseFloat(mainPriceRaw) || 0;

  // ğŸ”¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ØªÙØ¬Ù…Ø¹ Ø£Ø³Ø¹Ø§Ø±Ù‡Ø§ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¶Ø±Ø¨ Ø¨Ø§Ù„ÙƒÙ…ÙŠØ©)
  const extraQty = extraProducts.reduce((sum, p) => sum + (p.qty || 0), 0);
  const extraTotal = extraProducts.reduce((sum, p) => sum + (p.price || 0), 0);

  // âœ… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ Ù‡Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª
  const totalQty = mainQty + extraQty;
  const totalPrice = mainPrice + extraTotal;

  // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const totalQtyInput = document.getElementById("totalQty");
  const totalPriceInput = document.getElementById("totalPrice");
  const totalsCard = document.getElementById("totalsCard");

  if ((mainPrice === 0 && mainQty === 0) && extraProducts.length === 0)
 {
    totalQtyInput.value = "";
    totalPriceInput.value = "";
    totalsCard.style.display = "none";
  } else {
    totalQtyInput.value = totalQty;
    totalPriceInput.value = totalPrice.toLocaleString("en-US");
    totalsCard.style.display = "block";
  }
}





    // ğŸ”¸ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById("addProductBtn").addEventListener("click", () => {
      addExtraProduct();
    });

    // ğŸŸ¦ Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒÙÙ‚Ø§Ø¹Ø§Øª
    function renderProductTags() {
      const container = document.getElementById("productTagsContainer");
      container.innerHTML = "";

      const mainName = document.getElementById("product").querySelector("input")?.value.trim();
      if (mainName) {
        const chip = createTagChip(mainName, () => {
          document.getElementById("product").querySelector("input").value = "";
          renderProductTags();
        });
        container.appendChild(chip);
      }

      extraProducts.forEach((p, i) => {
        if (p.name) {
          const chip = createTagChip(p.name, () => {
            extraProducts.splice(i, 1);
            renderProductTags();
          });
          container.appendChild(chip);
        }
      });
    }

    // ğŸŸ§ ÙÙ‚Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
    function createTagChip(name, onRemove) {
      const chip = document.createElement("div");
      chip.textContent = name;
      chip.style.cssText = `
        background:#043B64;
        color:white;
        padding:5px 12px;
        border-radius:20px;
        display:flex;
        align-items:center;
        gap:6px;
        font-size:13px;
      `;
      const removeBtn = document.createElement("span");
      removeBtn.textContent = "âœ–";
      removeBtn.style.cssText = "cursor:pointer;font-weight:bold;";
      removeBtn.onclick = onRemove;
      chip.appendChild(removeBtn);
      return chip;
    }

    // ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    function setupDropdowns() {
  // ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ù…Ù†Ø³Ø¯Ù„Ø© Ù…ÙƒØ±Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
  ["city", "area", "product", "status"].forEach(id => {
    const div = document.getElementById(id);
    if (div) div.innerHTML = "";
  });

  const cityDiv = document.getElementById("city");
  const areaDiv = document.getElementById("area");
  const productDiv = document.getElementById("product");
  const statusDiv = document.getElementById("status");

      const cityDropdown = createDropdown(allCities, "", val => {
        areaDiv.innerHTML = "";
        const newAreas = citiesData[val] || [];
        const areaDropdown = createDropdown(newAreas, "", () => {});
        areaDiv.appendChild(areaDropdown);
      });
      cityDiv.appendChild(cityDropdown);

      const areaDropdown = createDropdown([], "", () => {});
      areaDiv.appendChild(areaDropdown);

      const productDropdown = createDropdown(allProducts, "", async val => {
  renderProductTags();

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
const mainCard = document.querySelector("#product").closest(".card");
await loadVariantsForProduct(mainCard, val, mainProductObj);


});

      productDiv.appendChild(productDropdown);

     // âœ… Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ ÙÙ‚Ø·
const statusOptions = ["Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©", "Ø±ÙØ¶"];
const statusDropdown = createDropdown(statusOptions, "", () => {});
statusDiv.appendChild(statusDropdown);

    }

    // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const loggedUser = JSON.parse(localStorage.getItem("loggedInUser"));

      const mainName = document.querySelector("#product input")?.value || "";
      const mainQty = parseFloat(document.getElementById("quantity").value) || 0;
const mainPrice = parseFloat(document.getElementById("price").value.replace(/,/g, "")) || 0;

// ğŸ”¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¶Ø±Ø¨ Ø¨Ø§Ù„Ø³Ø¹Ø± Ã— Ø§Ù„ÙƒÙ…ÙŠØ©
const extraQty = extraProducts.reduce((sum, p) => sum + (p.qty || 0), 0);
const extraTotal = extraProducts.reduce((sum, p) => sum + (p.price || 0), 0);

const totalQty = mainQty + extraQty; // Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙ‚Ø· ØªØ¬Ù…Ø¹
const totalPrice = mainPrice + extraTotal; // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª ÙÙ‚Ø·


console.log("ğŸŸ¢ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", mainPrice, "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:", totalPrice);





      const combinedNames = [mainName, ...extraProducts.map(p => p.name)].filter(Boolean).join("ØŒ ");
      // ğŸŸ¢ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
const notesArray = [];

// Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
if (mainName) {
  let mainText = `${mainName} Ã—${mainQty}`;
  if (Object.keys(mainProductObj?.selectedVariants || {}).length > 0) {
    const vars = Object.entries(mainProductObj.selectedVariants)
      .map(([k, v]) => `${k}: ${v}`)
      .join(", ");
    mainText += ` (${vars})`;
  }
  notesArray.push(mainText);
}

// Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
extraProducts.forEach(p => {
  let text = `${p.name} Ã—${p.qty}`;
  if (Object.keys(p.selectedVariants || {}).length > 0) {
    const vars = Object.entries(p.selectedVariants)
      .map(([k, v]) => `${k}: ${v}`)
      .join(", ");
    text += ` (${vars})`;
  }
  notesArray.push(text);
});

const autoNotes = notesArray.join(" | ");
const userNotes = document.getElementById("notes").value.trim();

// Ù„Ø§ ØªÙ…Ø³Ø­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ø¨Ø¯Ø§Ù‹  
let finalNotes = autoNotes;

if (userNotes) {
  finalNotes += " || " + userNotes;
}


      // ğŸŸ¢ Ø¨Ù†Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ù„Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹)
const productsDetailed = [];

productsDetailed.push({
  name: mainName,
  qty: mainQty,
  price: mainPrice || 0,   // â† Ø£Ø¶ÙÙ†Ø§Ù‡
  variants: mainProductObj.selectedVariants || {}
});


// Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
extraProducts.forEach(p => {
  if (p.name && p.qty > 0) {
    productsDetailed.push({
      name: p.name,
      qty: p.qty,
      price: p.price || 0,       // âœ… Ø§Ø¶ÙÙ†Ø§ Ø§Ù„Ø³Ø¹Ø±
      variants: p.selectedVariants || {}
    });
  }
});


// ğŸŸ¢ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
const order = {
  code: document.getElementById("code").value.trim(),
  phone1: document.getElementById("phone1").value.trim(),
  phone2: document.getElementById("phone2").value.trim(),
  address: document.getElementById("address").value.trim(),
  city: document.querySelector("#city input")?.value || "",
  area: document.querySelector("#area input")?.value || "",

  productName: mainName, // âœ“ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙÙ‚Ø·

  // âœ“ Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  totalQty: totalQty,           // â† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ…ÙŠØ©
  totalPrice: totalPrice,       // â† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø±
  totalProducts: combinedNames, // â† Ø£Ø³Ù…Ø§Ø¡ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª

  notes: finalNotes, // ØªØ¨Ù‚Ù‰ Ø«Ø§Ø¨ØªØ© ÙˆÙ…Ø§ØªÙ†Ù…Ø³Ø­
  status: document.querySelector("#status input")?.value || "",
  advertiser: document.getElementById("advertiser").value.trim(),
  orderDate: new Date().toISOString(),
  enterIndex: Date.now(),

  extraProducts: extraProducts,
  productsDetailed: productsDetailed
};

// ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© fixedBy Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ù‡Ø§ Ù…Ø«Ø¨Øª Ø£Ùˆ Ø±ÙØ¶
const userName =
  loggedUser?.displayName ||
  loggedUser?.name ||
  loggedUser?.username ||
  "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

if (order.status === "Ù…Ø«Ø¨Øª" || order.status === "Ø±ÙØ¶") {
  order.fixedBy = userName; // Ø«Ø§Ø¨Øª ÙˆÙ…Ø§ ÙŠØªØºÙŠØ± Ø£Ø¨Ø¯Ø§Ù‹
}

order.updatedBy = userName; // ÙŠØªØ­Ø¯Ø« Ø¯Ø§Ø¦Ù…Ù‹Ø§


// âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨ØªØ³Ù„Ø³Ù„ Ù…Ø±ØªØ¨
const ordersRef = ref(db, "orders");
const snap = await get(ordersRef);

let nextId = 1;

if (snap.exists()) {
  const allIds = Object.keys(snap.val())
    .map(k => Number(k))
    .filter(n => !isNaN(n));

  if (allIds.length > 0) {
    nextId = Math.max(...allIds) + 1;
  }
}

await set(ref(db, `orders/${nextId}`), order);

// ğŸŸ¢ Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙˆØ±Ù‹Ø§
await updateStockOnOrderCreate(productsDetailed);

// ğŸŸ¢ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚ØªØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
document.getElementById("savedMsg").style.display = "block";
setTimeout(() => {
  window.location.href = "dashboard.html";
}, 800);









    });
// âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø± ÙÙ‚Ø·ØŒ ÙˆØ§Ù„ÙƒÙ…ÙŠØ© ØªØ¨Ù‚Ù‰ Ø±Ù‚Ù… Ø·Ø¨ÙŠØ¹ÙŠ
document.addEventListener("DOMContentLoaded", () => {
  const priceInput = document.getElementById("price");
  const qtyInput = document.getElementById("quantity");

  // Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„ÙÙˆØ§ØµÙ„
  if (priceInput) {
    priceInput.addEventListener("input", e => {
      let raw = e.target.value.replace(/,/g, "");
      if (isNaN(raw)) return;
      e.target.value = Number(raw).toLocaleString("en-US");
    });
  }

  // Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¯ÙˆÙ† ÙÙˆØ§ØµÙ„ØŒ ØªÙ…Ù†Ø¹ Ø§Ù„ÙØ§ØµÙ„Ø© ØªÙ…Ø§Ù…Ù‹Ø§
  if (qtyInput) {
    qtyInput.addEventListener("input", e => {
      e.target.value = e.target.value.replace(/[^0-9]/g, ""); // ÙŠÙ‚Ø¨Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    });
  }

  // Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
  const saveBtn = document.getElementById("saveBtn");
  if (saveBtn) {
    saveBtn.addEventListener("click", () => {
      if (priceInput) {
        priceInput.value = priceInput.value.replace(/,/g, "");
      }
    });
  }
});

async function updateStockOnOrderCreate(productsDetailed) {
  const snap = await get(ref(db, "warehouse"));
  if (!snap.exists()) return;

  const warehouse = snap.val();

  for (const item of productsDetailed) {
    const { name, qty, variants } = item;
    if (!name || !qty) continue;

    const product = warehouse[name];
    if (!product || !product.stock) continue;

    const stock = product.stock;

    // ğŸŸ¢ ØµÙŠØ§ØºØ© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
    const variantValues = Object.values(variants || {}).map(v => v.trim().toLowerCase());

    let foundKey = null;

    // ğŸŸ¢ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚
    for (const key of Object.keys(stock)) {
      const keyNorm = key.toLowerCase();
      const matches = variantValues.filter(v => keyNorm.includes(v)).length;

      if (matches === variantValues.length && matches > 0) {
        foundKey = key;
        break;
      }
    }

    // ğŸŸ¢ Ø¥Ø°Ø§ Ù„Ù‚Ù‰ Ù…ØªØºÙŠØ± â†’ ÙŠÙ†Ù‚Øµ Ù…Ù†Ù‡ ÙÙ‚Ø·
    if (foundKey && stock[foundKey] !== undefined) {
      const before = Number(stock[foundKey]) || 0;
      const after = before - qty;
      stock[foundKey] = after;

      await set(ref(db, `warehouse/${name}/stock/${foundKey}`), after);
    }

    // ğŸŸ¢ Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ù…Ù†ØªØ¬ â†’ ÙŠÙ†Ù‚Øµ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
    else if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
      const before = Number(stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"]) || 0;
      const after = before - qty;
      stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = after;

      await set(ref(db, `warehouse/${name}/stock/Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©`), after);
    }

    // ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
    let totalQty = 0;
    for (const val of Object.values(stock)) {
      totalQty += Number(val) || 0;
    }

    await set(ref(db, `warehouse/${name}/totalQty`), totalQty);
  }
}


  </script>
</body>
</html>

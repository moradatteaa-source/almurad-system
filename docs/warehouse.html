<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 0;
      color: #043B64;
    }
/* âœ… Ø¬Ø¹Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© */
* {
  font-variant-numeric: lining-nums;
}

.num-en {
  direction: ltr !important;
  unicode-bidi: plaintext !important;
  font-family: 'Tajawal', sans-serif;
}

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: #043B64;
      color: white;
    }

    header h2 {
      margin: 0;
      font-size: 20px;
    }

    header button {
      background: #FF6B2D;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    header button:hover {
      opacity: 0.9;
    }

    table {
      width: 95%;
      margin: 25px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #043B64;
      color: white;
    }

    tr:hover td {
      background: #f9f9f9;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

   .popup {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(15px);
  border-radius: 15px;
  padding: 25px;
  color: white;
  width: 90%;
  max-width: 700px;
  max-height: 90vh; /* âœ… ÙŠØ­Ø¯Ø¯ Ø§Ø±ØªÙØ§Ø¹ Ø£Ù‚ØµÙ‰ 90% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
  overflow-y: auto; /* âœ… ÙŠØ®Ù„ÙŠÙ‡Ø§ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ± */
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  animation: fadeIn 0.5s ease;
}


    .popup input, .popup button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      font-family: 'Tajawal';
    }

    .popup input {
      background: rgba(255,255,255,0.9);
      color: #043B64;
    }

    .popup button {
      background: #FF6B2D;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .popup table {
      width: 100%;
      margin-top: 15px;
      background: rgba(255,255,255,0.1);
      color: white;
      border-radius: 8px;
      border-collapse: collapse;
    }

    .popup th, .popup td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .delete-btn {
      background: crimson;
      border: none;
      color: white;
      border-radius: 6px;
      padding: 5px 8px;
      cursor: pointer;
    }

    .success {
      background: #28a745;
      color: white;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>

  <header>

    <h2>ğŸ¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
    <button onclick="togglePopup(true)">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
  </header>
  <!-- ğŸ“¤ Ø²Ø± Ø±ÙØ¹ Ù…Ù„Ù Excel -->
<div style="text-align:center;margin-top:15px;">
  <input type="file" id="excelFile" accept=".xlsx,.xls" style="padding:8px;border-radius:6px;border:1px solid #ccc;">
  <button onclick="uploadExcel()" style="background:#FF6B2D;color:white;border:none;padding:8px 15px;border-radius:8px;cursor:pointer;">
    ğŸ“¤ Ø±ÙØ¹ Ø­Ø²Ù…Ø© Ù…Ù†ØªØ¬Ø§Øª Excel
  </button>
</div>

<!-- ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
<div id="statsContainer" style="
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap:15px;
  margin:25px;
">
  <div style="background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:15px;text-align:center;">
    <h4 style="margin:0;color:#043B64;">ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
    <p id="totalProducts" class="num-en" style="font-size:20px;font-weight:bold;color:#FF6B2D;">0</p>
  </div>

  <div style="background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:15px;text-align:center;">
    <h4 style="margin:0;color:#043B64;">ğŸ§® Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</h4>
    <p id="totalQtyAll" class="num-en" style="font-size:20px;font-weight:bold;color:#FF6B2D;">0</p>
  </div>

  <div style="background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:15px;text-align:center;">
    <h4 style="margin:0;color:#043B64;">ğŸ’° Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø§Ù„Ø´Ø±Ø§Ø¡)</h4>
    <p id="totalBuyValue" class="num-en" style="font-size:20px;font-weight:bold;color:#FF6B2D;">0</p>
  </div>

  <div style="background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:15px;text-align:center;">
    <h4 style="margin:0;color:#043B64;">ğŸ’¸ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø§Øª (Ø§Ù„Ø¨ÙŠØ¹)</h4>
    <p id="totalSellValue" class="num-en" style="font-size:20px;font-weight:bold;color:#FF6B2D;">0</p>
  </div>
</div>

  <table id="warehouseTable">
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
        <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
        <th>Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th>
<th>ğŸ’¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th>
<th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>

        <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<!-- ğŸ”¹ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
<div class="overlay" id="popupOverlay">
  <div class="popup">
    <h3 id="popupTitle">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>

    <input id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
    <input id="buyPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    <input id="sellPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">

    <!-- ğŸ”¸ Ø®Ø§Ù†Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª -->
    <div id="quantitySection">
      <input id="productQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ù…ØªØºÙŠØ±Ø§Øª)">
    </div>

    <!-- Ø²Ø± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª -->
    <button id="toggleVariantsBtn" onclick="toggleVariants()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª</button>

   <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª -->
<div id="variantsSection" style="display:none;">
  <h4 style="margin-top:15px;">ğŸ§© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¨Ø¹Ø¯ØŒ Ù…Ø«Ù„ Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù‚ÙŠØ§Ø³)</h4>

  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
    <input id="variantType1" placeholder="Ø§Ù„Ø¨ÙØ¹Ø¯ Ø§Ù„Ø£ÙˆÙ„ (Ù…Ø«Ù„ Ø§Ù„Ù„ÙˆÙ†)">
    <input id="variantValue1" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© 1 (Ù…Ø«Ù„ Ø£Ø­Ù…Ø±)">
    <input id="variantType2" placeholder="Ø§Ù„Ø¨ÙØ¹Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ø«Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³)">
    <input id="variantValue2" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© 2 (Ù…Ø«Ù„ M)">
    <input id="variantQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
    <button onclick="addVariant()">â• Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <table id="variantTable">
    <thead>
      <tr><th>Ø§Ù„Ø¨ÙØ¹Ø¯ 1</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø© 1</th><th>Ø§Ù„Ø¨ÙØ¹Ø¯ 2</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø© 2</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø­Ø°Ù</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


    <button onclick="saveProduct()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
    <div id="successMsg" class="success">âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!</div>
    <button style="background:#777;margin-top:10px;" onclick="togglePopup(false)">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
    authDomain: "almurad-system.firebaseapp.com",
    databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
    projectId: "almurad-system",
    storageBucket: "almurad-system.appspot.com",
    messagingSenderId: "911755824405",
    appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const overlay = document.getElementById("popupOverlay");
  const tableBody = document.querySelector("#warehouseTable tbody");
  const popupTitle = document.getElementById("popupTitle");

  let variants = [];
  let editingProduct = null; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø¯Ù„ Ø£Ùˆ Ù†Ø¶ÙŠÙ

window.togglePopup = (show) => {
  overlay.style.display = show ? "flex" : "none";
  
  // Ø¥Ø°Ø§ Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
  if (!show) {
    if (!editingProduct) { 
      // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ø¸Ù‘Ù Ø§Ù„Ø­Ù‚ÙˆÙ„
      popupTitle.textContent = "â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
      clearFields();
    }
  }
};


  // ğŸ”¸ Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±
 window.addVariant = function() {
  const type1 = document.getElementById("variantType1").value.trim();
  const value1 = document.getElementById("variantValue1").value.trim();
  const type2 = document.getElementById("variantType2").value.trim();
  const value2 = document.getElementById("variantValue2").value.trim();
  const qty = parseInt(document.getElementById("variantQty").value.trim());

  if (!type1 || !value1 || isNaN(qty)) return alert("ğŸŸ  Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ± (Ø§Ù„Ù„ÙˆÙ† Ø£Ùˆ Ø§Ù„Ø¨ÙØ¹Ø¯ Ø§Ù„Ø£ÙˆÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ).");

  variants.push({ type1, value1, type2, value2, qty });
  renderVariantTable();

  document.getElementById("variantType1").value = "";
  document.getElementById("variantValue1").value = "";
  document.getElementById("variantType2").value = "";
  document.getElementById("variantValue2").value = "";
  document.getElementById("variantQty").value = "";
};


  function renderVariantTable() {
  const tbody = document.querySelector("#variantTable tbody");
  tbody.innerHTML = "";
  variants.forEach((v, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${v.type1 || "-"}</td>
        <td>${v.value1 || "-"}</td>
        <td>${v.type2 || "-"}</td>
        <td>${v.value2 || "-"}</td>
        <td>${v.qty}</td>
        <td><button class="delete-btn" onclick="deleteVariant(${i})">ğŸ—‘</button></td>
      </tr>
    `;
  });
}


  window.deleteVariant = function(i) {
    variants.splice(i, 1);
    renderVariantTable();
  };

  // ğŸ”¸ Ø¹Ø±Ø¶ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  window.toggleVariants = function() {
    const section = document.getElementById("variantsSection");
    const qtySection = document.getElementById("quantitySection");
    const btn = document.getElementById("toggleVariantsBtn");
    if (section.style.display === "none") {
      section.style.display = "block";
      qtySection.style.display = "none";
      btn.textContent = "ğŸ”½ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª";
    } else {
      section.style.display = "none";
      qtySection.style.display = "block";
      btn.textContent = "â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª";
    }
  };

// ğŸ§¾ Ø­ÙØ¸ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
window.saveProduct = async function() {
  const name = document.getElementById("productName").value.trim();
  const buyPrice = parseFloat(document.getElementById("buyPrice").value);
  const sellPrice = parseFloat(document.getElementById("sellPrice").value);
  const qty = parseInt(document.getElementById("productQty").value.trim()) || 0;

  if (!name || isNaN(buyPrice) || isNaN(sellPrice))
    return alert("âš ï¸ Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬.");

 // ğŸŸ¢ Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
let stock = {};

// ğŸŸ¢ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª (ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ø«Ù„ Ø§Ù„Ù„ÙˆÙ† Ø£Ùˆ Ø§Ù„Ø­Ø¬Ù…)
if (variants.length > 0) {
  variants.forEach(v => {
    let key = "";
    if (v.type1 && v.value1 && v.type2 && v.value2) {
      // Ù…Ø«Ø§Ù„: "Ø§Ù„Ù„ÙˆÙ† | Ø£Ø­Ù…Ø± | Ø§Ù„Ù‚ÙŠØ§Ø³ | M"
      key = `${v.type1} | ${v.value1} | ${v.type2} | ${v.value2}`;
    } else if (v.type1 && v.value1) {
      // Ù…Ø«Ø§Ù„: "Ø§Ù„Ù„ÙˆÙ† | Ø£Ø­Ù…Ø±"
      key = `${v.type1} | ${v.value1}`;
    } else {
      key = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©";
    }

    stock[key] = v.qty;
  });
} else {
  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª
  stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = qty;
}

// âœ… Ø¥Ø°Ø§ Ø¹Ø¯Ù‘Ù„Ù†Ø§ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ù†Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…
if (editingProduct && editingProduct !== name) {
  await remove(ref(db, "warehouse/" + editingProduct));
}

// ğŸŸ¢ Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
let variantsStructured = {};
variants.forEach(v => {
  if (v.type1 && v.value1) {
    if (!variantsStructured[v.type1]) variantsStructured[v.type1] = [];
    if (!variantsStructured[v.type1].includes(v.value1)) {
      variantsStructured[v.type1].push(v.value1);
    }
  }
  if (v.type2 && v.value2) {
    if (!variantsStructured[v.type2]) variantsStructured[v.type2] = [];
    if (!variantsStructured[v.type2].includes(v.value2)) {
      variantsStructured[v.type2].push(v.value2);
    }
  }
});


  // ğŸ§¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Firebase
  const productRef = ref(db, "warehouse/" + name);
  await set(productRef, {
    buyPrice,
    sellPrice,
    totalQty: Object.values(stock).reduce((a, b) => a + b, 0),
    lastUpdate: new Date().toISOString(),
    stock,
    variants: variantsStructured // âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ø­ØªÙ‰ ØªØ¸Ù‡Ø± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
  });

  // âœ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
  document.getElementById("successMsg").style.display = "block";
  setTimeout(() => document.getElementById("successMsg").style.display = "none", 2000);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
  loadWarehouse();
  clearFields();
  togglePopup(false);
  editingProduct = null;
};



  function clearFields() {
    document.getElementById("productName").value = "";
    document.getElementById("buyPrice").value = "";
    document.getElementById("sellPrice").value = "";
    document.getElementById("productQty").value = "";
    variants = [];
    renderVariantTable();
  }

  function loadWarehouse() {
  const warehouseRef = ref(db, "warehouse");

  onValue(warehouseRef, (snapshot) => {
    tableBody.innerHTML = "";

    if (!snapshot.exists()) {
      tableBody.innerHTML = `<tr><td colspan="7">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>`;
      return;
    }

    const data = snapshot.val();

    for (const [productName, p] of Object.entries(data)) {
      const total = Object.values(p.stock || {}).reduce((a, b) => a + b, 0);
      // âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
const invoiceValue = (p.sellPrice || 0) * total;
const buyValue = (p.buyPrice || 0) * total;


      let variantsList = "";
      if (p.stock && Object.keys(p.stock).length > 0) {
       variantsList = Object.entries(p.stock)
  .map(([key, value]) => {
    const parts = key.split("|").map(s => s.trim());
    const qtyColor = value <= 5 ? "red" : "#FF6B2D";

    // ğŸ§  Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ø­ØªÙ‰ 4 Ù…Ø³ØªÙˆÙŠØ§Øª)
    const text = parts
      .filter(p => p) // ÙŠØ­Ø°Ù Ø§Ù„ÙØ±Ø§ØºØ§Øª
      .join(" | ");

    return `
      <div style="margin:4px 0; text-align:center; line-height:1.8; direction:rtl;">
        <span style="color:#043B64; font-weight:600;">${text}</span>
        <span style="color:${qtyColor}; font-weight:600;"> â†’ ${value} Ù‚Ø·Ø¹Ø©</span>
      </div>
    `;
  })
  .join("");

      } else {
        variantsList = "â€”";
      }

     const tr = document.createElement("tr");
tr.innerHTML = `
  <td><strong>${productName}</strong></td>
  <td>${p.buyPrice || "-"}</td>
  <td>${p.sellPrice || "-"}</td>
  <td style="text-align:center; vertical-align:top;">
    <div style="display:flex; flex-direction:column; align-items:center; justify-content:flex-start;">
      ${variantsList}
    </div>
  </td>
  <td>${total}</td>
<td class="num-en" style="color:#043B64;font-weight:bold;">${invoiceValue.toLocaleString('en-US')} Ø¯.Ø¹</td>
  <td>${p.lastUpdate ? p.lastUpdate.split("T")[0] : "-"}</td>
  <td>
    <button class="delete-btn" onclick="deleteProduct('${productName}')">ğŸ—‘</button>
    <button style="background:#FF6B2D;border:none;color:white;border-radius:6px;padding:5px 8px;cursor:pointer" onclick="editProduct('${productName}')">âœï¸</button>
  </td>
`;
tableBody.appendChild(tr);

    }
    // âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    const products = Object.entries(data);
    let totalQtyAll = 0;
    let totalBuyValue = 0;
    let totalSellValue = 0;

    products.forEach(([name, p]) => {
      const totalQty = Object.values(p.stock || {}).reduce((a, b) => a + b, 0);
      totalQtyAll += totalQty;
      totalBuyValue += totalQty * (p.buyPrice || 0);
      totalSellValue += totalQty * (p.sellPrice || 0);
    });

    // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    document.getElementById("totalProducts").textContent = products.length.toLocaleString('en-US');
    document.getElementById("totalQtyAll").textContent = totalQtyAll.toLocaleString('en-US');
    document.getElementById("totalBuyValue").textContent = totalBuyValue.toLocaleString('en-US') + " Ø¯.Ø¹";
    document.getElementById("totalSellValue").textContent = totalSellValue.toLocaleString('en-US') + " Ø¯.Ø¹";

    // ğŸ§¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Firebase Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ
    const statsRef = ref(db, "stats/warehouse");
    set(statsRef, {
      totalProducts: products.length,
      totalQtyAll,
      totalBuyValue,
      totalSellValue,
      lastUpdate: new Date().toISOString()
    }).catch(err => console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:", err));
  });
}


// ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
window.deleteProduct = async function(productName) {
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ "${productName}"ØŸ`)) return;

  try {
    await remove(ref(db, "warehouse/" + productName));
    alert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ "${productName}" Ø¨Ù†Ø¬Ø§Ø­.`);
    loadWarehouse(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù:", err);
    alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
  }
};


  // âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬
  window.editProduct = async function(productName) {
    const snapshot = await get(ref(db, "warehouse/" + productName));
    if (!snapshot.exists()) return alert("âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

    const data = snapshot.val();
    editingProduct = productName; // âœ… ÙŠØ®Ø²Ù‘Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„Ù‡

    togglePopup(true);
    popupTitle.textContent = `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: ${productName}`;
    document.getElementById("productName").value = productName;
    document.getElementById("buyPrice").value = data.buyPrice || "";
    document.getElementById("sellPrice").value = data.sellPrice || "";
    document.getElementById("productQty").value = data.totalQty || "";
    variants = [];

    if (data.stock) {
  for (const [key, qty] of Object.entries(data.stock)) {
    const parts = key.split("|").map(s => s.trim());
    variants.push({
      type1: parts[0] || "",
      value1: parts[1] || "",
      type2: parts[2] || "",
      value2: parts[3] || "",
      qty
    });
  }
  renderVariantTable();

  // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
  document.getElementById("quantitySection").style.display = variants.length ? "none" : "block";
  document.getElementById("variantsSection").style.display = variants.length ? "block" : "none";
}

  };

  loadWarehouse();
  // âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù…Ù„Ù Excel
window.uploadExcel = async function () {
  const fileInput = document.getElementById("excelFile");
  const file = fileInput.files[0];
  if (!file) return alert("ğŸŸ  ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹.");

  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data);
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet);

  if (rows.length === 0) return alert("âš ï¸ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­.");

  const grouped = {};

  // ğŸ§© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
  rows.forEach(r => {
    const name = r["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"];
    if (!name) return;
    const buy = parseFloat(r["Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"]) || 0;
    const sell = parseFloat(r["Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"]) || 0;
    const qty = parseInt(r["Ø§Ù„ÙƒÙ…ÙŠØ©"]) || 0;
    const type1 = r["Ù†ÙˆØ¹ Ø§Ù„Ù…ØªØºÙŠØ± 1"] || "";
    const val1 = r["Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØºÙŠØ± 1"] || "";
    const type2 = r["Ù†ÙˆØ¹ Ø§Ù„Ù…ØªØºÙŠØ± 2"] || "";
    const val2 = r["Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØºÙŠØ± 2"] || "";

    const key = [type1, val1, type2, val2].filter(Boolean).join(" | ") || "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©";

    if (!grouped[name]) grouped[name] = { buy, sell, stock: {} };
    grouped[name].stock[key] = qty;
  });

  let count = 0;

  for (const [name, data] of Object.entries(grouped)) {
    await set(ref(db, "warehouse/" + name), {
      buyPrice: data.buy,
      sellPrice: data.sell,
      totalQty: Object.values(data.stock).reduce((a, b) => a + b, 0),
      lastUpdate: new Date().toISOString(),
      stock: data.stock
    });
    count++;
  }

  alert(`âœ… ØªÙ… Ø±ÙØ¹ ${count} Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!`);
  loadWarehouse();
};

</script>
</body>
</html>

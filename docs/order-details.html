<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  
  <style>
    .input-error {
  border: 2px solid #ff3b30 !important;
  background: #ffecec !important;
}

    .add-small-btn {
  background: rgba(4, 59, 100, 0.08);
  color: #043B64;
  border: 1px dashed #043B64;
  border-radius: 8px;
  padding: 6px 10px;
  width: 55%;
  font-size: 13px;
  cursor: pointer;
  margin: 8px auto;
  display: block;
  font-weight: 600;
  transition: all 0.2s;
}
.add-small-btn:hover {
  background: #043B64;
  color: #fff;
  transform: scale(1.03);
}

    :root {
      --main-blue: #043B64;
      --accent-orange: #FF6B2D;
      --background-gray: #f2f3f5;
      --border-radius: 12px;
    }

    body {
      font-family: Tahoma, Arial;
      background: var(--background-gray);
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: var(--main-blue);
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 18px;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .container {
      max-width: 800px;
      margin: 25px auto;
      padding: 10px;
    }

    .card {
      background: var(--background-gray);
      border-radius: var(--border-radius);
      box-shadow: none;
      padding: 15px 20px;
      margin-bottom: 15px;
    }

    .row {
      display: flex;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .field.small {
      flex: none;
      width: 140px;
    }

    .field.single {
      max-width: 280px;
      margin: 0 auto 15px auto;
    }

    label {
      color: var(--main-blue);
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 13px;
    }

    input, textarea {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 9px 10px;
      font-size: 13px;
      width: 100%;
      background: #fff;
      transition: all 0.2s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-orange);
      box-shadow: 0 0 4px rgba(255,107,45,0.3);
    }

    textarea {
      resize: vertical;
      height: 60px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      width: 100%;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      transition: all 0.2s;
    }

    #saveBtn {
      background: var(--accent-orange);
      color: white;
    }

    #saveBtn:hover {
      opacity: 0.9;
      transform: scale(1.01);
    }

    #backBtn {
      background: var(--main-blue);
      color: white;
    }

    #backBtn:hover {
      opacity: 0.9;
    }

    .bottom-actions {
      position: fixed;
      bottom: 15px;
      left: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
    }

    .contact-btn {
      background: var(--main-blue);
      color: white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 22px;
      text-align: center;
      line-height: 50px;
      text-decoration: none;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      transition: all 0.2s;
    }

    .contact-btn:hover {
      transform: scale(1.08);
    }

    .whatsapp {
      background: #25D366;
    }

    @media (max-width: 600px) {
      .container {
        margin: 10px;
      }
      .card {
        padding: 10px;
      }
      .field.small {
        width: 130px;
      }
      .field.single {
        max-width: 100%;
      }
    }

    /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    input, select, textarea {
      font-size: 16px !important;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© */
    .extra-product {
  background: var(--background-gray);
  border-radius: var(--border-radius);
  padding: 15px 20px;
  margin-top: 10px;
  box-shadow: none;
}

.extra-product .row {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 25px;
  margin-bottom: 10px;
}

.extra-product .field {
  flex: 1;
  display: flex;
  flex-direction: column;
}


    .delete-btn {
      color: red;
      cursor: pointer;
      font-size: 20px;
      text-align: left;
    }
    /* âœ… Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ + Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ */
@media (max-width: 768px) {
  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    touch-action: manipulation;
  }
  input, select, textarea, button {
    font-size: 16px !important;
  }
}

/* âœ… Ø¬Ø¹Ù„ Ø§Ù„ØµÙØ­Ø© ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© */
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  background: var(--background-gray);
}
/* âœ… ØªÙ…ÙŠÙŠØ² ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© */
.extra-product {
  background: #ffffff;
  border-radius: 12px;
  padding: 15px 20px;
  margin-top: 12px;
  border: 2px dashed #FF6B2D; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ù† Ù„ÙˆÙ† Ø§Ù„Ù†Ø¸Ø§Ù… */
  position: relative;
  transition: all 0.3s ease;
}

.extra-product::before {
  content: "Ù…Ù†ØªØ¬ Ø¥Ø¶Ø§ÙÙŠ";
  position: absolute;
  top: -10px;
  right: 12px;
  background: #FF6B2D;
  color: white;
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: bold;
}

.extra-product:hover {
  background: #fff7f3;
  transform: scale(1.01);
}
/* âœ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª */
body, html {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  background: var(--background-gray);
}

.container {
  width: 100%;
  max-width: 100%;
  margin: 0;
  padding: 10px;
}
/* âœ… Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
.card, .row, .field {
  width: 100%;
  box-sizing: border-box;
}

.container {
  max-width: 600px;
  width: 95%;
  margin: auto;
}

.top-contact-buttons {
  position: fixed;
  top: 80px;
  left: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  z-index: 10000;
}

.top-contact-buttons .contact-btn {
  width: 50px;
  height: 50px;
  line-height: 50px;
  font-size: 24px;
  border-radius: 50%;
  color: white;
  text-align: center;
  text-decoration: none;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}

.top-contact-buttons .contact-btn:hover {
  transform: scale(1.08);
}

.top-contact-buttons .whatsapp {
  background: #25D366;
}

.top-contact-buttons .contact-btn:not(.whatsapp) {
  background: #043B64;
}





.contact-btn {
  width: 55px;
  height: 55px;
  line-height: 55px;
  font-size: 24px;
}

/* âœ… ØªØµØºÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ù…Ù„Ø§Ø¡Ù…Ø© */
input, textarea {
  font-size: 15px;
}
@media (max-width: 768px) {
  .bottom-actions {
    bottom: 80px; /* Ù…Ø®ØµØµ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  }
}
.undo-redo-fixed {
  position: fixed;
  top: 15px;         /* ğŸ”¹ Ø®Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¨Ø¯Ù„ bottom */
  left: 15px;
  display: flex;
  flex-direction: row;
  gap: 8px;
  z-index: 10000;
}

.undo-redo-fixed button {
  background: #043B64;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.undo-redo-fixed button:hover {
  opacity: 0.9;
  transform: scale(1.05);
}
input, select, textarea {
  font-size: 16px !important;
  touch-action: manipulation !important;
}

  </style>
</head>

<body>

  <header>ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</header>

<div class="undo-redo-fixed">
  <button id="undoBtn">â†©ï¸</button>
  <button id="redoBtn">â†ªï¸</button>
</div>
  <div class="container">

    <div class="card">
      <div class="field single">
        <label>Ø§Ù„ÙƒÙˆØ¯:</label>
        <input id="code" type="text">
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="field small">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£ÙˆÙ„:</label>
          <input id="phone1" type="text">
        </div>
        <div class="field small">
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ:</label>
          <input id="phone2" type="text">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="field small">
          <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
          <div id="city"></div>
        </div>
        <div class="field small">
          <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
          <div id="area"></div>
        </div>
      </div>
      <div class="field single">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„:</label>
        <textarea id="address"></textarea>
      </div>
    </div>

    <div class="card">
  <div class="field single">
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
    <div id="product"></div>
  </div>
  <div id="productTagsContainer" style="
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
"></div>

  <div class="row">
    <div class="field small">
      <label>Ø§Ù„Ø³Ø¹Ø±:</label>
<input id="price" type="text" inputmode="numeric">    </div>
    <div class="field small">
      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</label>
<input id="quantity" type="text" inputmode="numeric">
    </div>
  </div>
</div>
<div id="variantsContainer"></div>


      <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
      <div id="extraProducts"></div>

      <!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
<button id="addProductBtn" class="add-small-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</button>

      <!-- Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¹Ø¯Ø¯ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬) -->
      <div id="totalsCard" style="display:none;">
        <div class="row">
          <div class="field small">
            <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯:</label>
            <input id="totalQty" readonly>
          </div>
          <div class="field small">
            <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±:</label>
            <input id="totalPrice" readonly>
          </div>
        </div>
      </div>

      <div class="field single">
        <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="field single">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</label>
        <input id="orderDate" readonly>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="field small">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label>
          <div id="status"></div>
        </div>
        <div class="field small">
          <label>Ø§Ù„Ù…Ø¹Ù„Ù†:</label>
          <input id="advertiser" type="text">
        </div>
      </div>
    </div>

    <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button id="backBtn">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>

  </div>
  </div>
    <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ -->
  <script type="module">
    window.history.pushState(null, "", location.href);

window.addEventListener("popstate", () => {
  window.location.href = "dashboard.html"; 
});

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
   import { getDatabase, ref, get, update, onValue, set }
from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    import { citiesData, allCities } from "./citiesData.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

    const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const orderId = localStorage.getItem("selectedOrder");
const loggedUser = JSON.parse(localStorage.getItem("loggedInUser") || "{}");

if (!orderId) {
  // Ù†Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ÙƒØ±ÙˆØª Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‡Ø³ØªÙˆØ±ÙŠ
  window.location.replace("orders-cards.html");
}



    // ğŸ”¹ Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø³Ø¯Ù„Ø§Øª (Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    function createDropdown(options, selected, onChange) {
      const wrapper = document.createElement("div");
      const input = document.createElement("input");
      input.type = "text";
      input.value = selected || "";
      input.placeholder = "Ø§Ø®ØªØ±...";
      input.style.cursor = "pointer";

      const dropdown = document.createElement("div");
      Object.assign(dropdown.style, {
        position: "absolute",
        background: "#fff",
        border: "1px solid #ccc",
        borderRadius: "6px",
        boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
        maxHeight: "200px",
        overflowY: "auto",
        zIndex: "9999",
        display: "none",
        fontSize: "12px"
      });

      function renderList(filter = "") {
        dropdown.innerHTML = "";
        options.filter(o => o.includes(filter)).forEach(o => {
          const opt = document.createElement("div");
          opt.textContent = o;
          opt.style.padding = "5px 8px";
          opt.style.cursor = "pointer";
          opt.addEventListener("click", () => {
            input.value = o;
            dropdown.style.display = "none";
            onChange(o);
          });
          dropdown.appendChild(opt);
        });
      }

      input.addEventListener("focus", () => {
        dropdown.style.display = "block";
        renderList();
      });

      input.addEventListener("input", e => renderList(e.target.value.trim()));
      document.addEventListener("click", e => { if (!wrapper.contains(e.target)) dropdown.style.display = "none"; });

      wrapper.style.position = "relative";
      wrapper.appendChild(input);
      wrapper.appendChild(dropdown);
      return wrapper;
    }
async function loadVariants(productName) {
  const variantsContainer = document.getElementById("variantsContainer");
  variantsContainer.innerHTML = "";

  const snap = await get(ref(db, "warehouse"));
  if (!snap.exists()) return;

  const allProducts = snap.val();
  const productData = allProducts[productName];
  if (!productData || !productData.stock) return;

  const stock = productData.stock;
  const activeKeys = Object.keys(stock).filter(k => k !== "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©" && stock[k] > 0);
  if (activeKeys.length === 0) return;

  const savedVariantsSnap = await get(ref(db, `orders/${orderId}/selectedVariants`));
  const savedVariants = savedVariantsSnap.exists() ? savedVariantsSnap.val() : {};

  const variantsMap = {};
  activeKeys.forEach(key => {
    const parts = key.split("|").map(s => s.trim());
    for (let i = 0; i < parts.length; i += 2) {
      const name = parts[i];
      const val = parts[i + 1];
      if (!variantsMap[name]) variantsMap[name] = new Set();
      variantsMap[name].add(val);
    }
  });

  const variantNames = Object.keys(variantsMap);
  let selected = { ...savedVariants };

  function renderDropdown(level = 0) {
    Array.from(variantsContainer.querySelectorAll(".variant-group"))
      .slice(level)
      .forEach(el => el.remove());

    const name = variantNames[level];
    if (!name) return;

    const filteredKeys = activeKeys.filter(key =>
      Object.entries(selected).every(([k, v]) => key.includes(`${k} | ${v}`))
    );

    const availableVals = new Set();
    filteredKeys.forEach(key => {
      const parts = key.split("|").map(s => s.trim());
      for (let i = 0; i < parts.length; i += 2) {
        const k = parts[i], val = parts[i + 1];
        if (k === name) availableVals.add(val);
      }
    });

    if (availableVals.size === 0) return;

    const wrapper = document.createElement("div");
    wrapper.className = "variant-group field single";

    const label = document.createElement("label");
    label.textContent = `${name}:`;
    wrapper.appendChild(label);

    const dropdown = createDropdown(
      [...availableVals],
      selected[name] || "",
      val => {
        selected[name] = val;
        update(ref(db, `orders/${orderId}/selectedVariants`), selected);
        renderDropdown(level + 1);
      }
    );

    wrapper.appendChild(dropdown);
    variantsContainer.appendChild(wrapper);
  }

  renderDropdown(0);
}



// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù…Ø¹ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø£ÙˆÙ„
async function loadVariantsForExtra(container, productName, productObj) {
  const existingVariants = container.querySelector(".variants-container");
  if (existingVariants) existingVariants.remove();

  const variantsDiv = document.createElement("div");
  variantsDiv.className = "variants-container";
  variantsDiv.style.marginTop = "10px";

  const snap = await get(ref(db, "warehouse"));
  if (!snap.exists()) return;

  const allProducts = snap.val();
  const productData = allProducts[productName];
  if (!productData || !productData.stock) return;

  const stock = productData.stock;
  const activeKeys = Object.keys(stock).filter(k => k !== "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©" && stock[k] > 0);
  if (activeKeys.length === 0) return;

  const variantsMap = {};
  activeKeys.forEach(key => {
    const parts = key.split("|").map(s => s.trim());
    for (let i = 0; i < parts.length; i += 2) {
      const name = parts[i];
      const val = parts[i + 1];
      if (!variantsMap[name]) variantsMap[name] = new Set();
      variantsMap[name].add(val);
    }
  });

  const selected = {};
  const variantNames = Object.keys(variantsMap);
  if (variantNames.length === 0) return;

  function renderDropdown(level = 0) {
    // Ø­Ø°Ù Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const oldNext = Array.from(variantsDiv.querySelectorAll(".variant-group"))
      .filter((_, idx) => idx >= level);
    oldNext.forEach(el => el.remove());

    const name = variantNames[level];
    if (!name) return;

    const filteredKeys = activeKeys.filter(key =>
      Object.entries(selected).every(([k, v]) => key.includes(`${k} | ${v}`))
    );

    const availableVals = new Set();
    filteredKeys.forEach(key => {
      const parts = key.split("|").map(s => s.trim());
      for (let i = 0; i < parts.length; i += 2) {
        const k = parts[i], val = parts[i + 1];
        if (k === name) availableVals.add(val);
      }
    });

    if (availableVals.size === 0) return;

    const wrapper = document.createElement("div");
    wrapper.className = "variant-group field single";

    const label = document.createElement("label");
    label.textContent = `${name}:`;
    label.style.color = "#043B64";
    label.style.fontWeight = "600";
    label.style.marginTop = "8px";
    wrapper.appendChild(label);

    const dropdown = createDropdown([...availableVals], selected[name] || "", val => {
      selected[name] = val;
      productObj.selectedVariants = selected;
      renderDropdown(level + 1);
    });
    wrapper.appendChild(dropdown);
    variantsDiv.appendChild(wrapper);
  }

  renderDropdown(0);
  container.appendChild(variantsDiv);
}



    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
    let allProducts = [];
onValue(ref(db, "warehouse"), (snap) => {
      if (snap.exists()) {
        const data = snap.val();
allProducts = Object.keys(snap.val());
      }
    });

    // ğŸŸ  Ù…Ù†ØªØ¬Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    let extraProducts = [];

function addExtraProduct(product = { id: Date.now() + Math.random(), name: "", price: 0, qty: 0 }) {
  const card = document.createElement("div");
  card.className = "extra-product";
  card.dataset.pid = product.id; // â† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ Ù‡Ù†Ø§



      const nameField = document.createElement("div");
      nameField.className = "field single";
      const nameLabel = document.createElement("label");
      nameLabel.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:";
      const dropdownContainer = document.createElement("div");
     const dropdown = createDropdown(allProducts, product.name, val => {
  product.name = val;
  loadVariantsForExtra(card, val, product); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬
  renderProductTags();

})

      dropdownContainer.appendChild(dropdown);
      nameField.appendChild(nameLabel);
      nameField.appendChild(dropdownContainer);

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="field small">
          <label>Ø§Ù„Ø³Ø¹Ø±:</label>
          <input type="number" class="price-input" value="${product.price || ""}">
        </div>
        <div class="field small">
          <label>Ø§Ù„Ø¹Ø¯Ø¯:</label>
          <input type="number" class="qty-input" value="${product.qty || ""}">
        </div>
      `;

      const del = document.createElement("div");
      del.className = "delete-btn";
      del.textContent = "ğŸ—‘";
      del.onclick = () => {
        card.remove();
        extraProducts = extraProducts.filter(p => p !== product);
        updateTotals();
        if (extraProducts.length === 0) {
          document.getElementById("totalsCard").style.display = "none";
        }
      };

      card.appendChild(nameField);
      card.appendChild(row);
      card.appendChild(del);
      document.getElementById("extraProducts").appendChild(card);

      const priceInput = row.querySelector(".price-input");
      const qtyInput = row.querySelector(".qty-input");

      priceInput.addEventListener("input", () => {
        product.price = parseFloat(priceInput.value) || 0;
        updateTotals();
      });
      qtyInput.addEventListener("input", () => {
        product.qty = parseFloat(qtyInput.value) || 0;
        updateTotals();
      });

      extraProducts.push(product);
      updateTotals();
      document.getElementById("totalsCard").style.display = "block";
    }

  function updateTotals() {
  // ğŸ§® Ù†Ù‚Ø±Ø£ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø¶Ø±Ø¨
  const mainQty = parseFloat(document.getElementById("quantity").value.replace(/,/g, "")) || 0;
  const mainPrice = parseFloat(document.getElementById("price").value.replace(/,/g, "")) || 0;

  // ğŸ”¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ØªÙØ¬Ù…Ø¹ Ø£Ø³Ø¹Ø§Ø±Ù‡Ø§ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¶Ø±Ø¨
  const extraQty = extraProducts.reduce((sum, p) => sum + (p.qty || 0), 0);
  const extraTotal = extraProducts.reduce((sum, p) => sum + (p.price || 0), 0);

  // âœ… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ Ù‡Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙ‚Ø·
  const totalQty = mainQty + extraQty;
  const totalPrice = mainPrice + extraTotal;

  document.getElementById("totalQty").value = totalQty;
  document.getElementById("totalPrice").value = totalPrice.toLocaleString("en-US");
}



    // ğŸ”¸ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById("addProductBtn").addEventListener("click", () => {
      addExtraProduct();
    });
if (!localStorage.getItem("selectedOrder")) {
  // Ù†Ù‚Ø±Ø£ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ iframe Ù„Ùˆ Ù†Ø³Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†
  const params = new URLSearchParams(window.location.search);
  const fallbackId = params.get("id");
  if (fallbackId) localStorage.setItem("selectedOrder", fallbackId);
}
// â­ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† orderId Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø®Ù„Ø§Ù„ receiptNum
async function getOrderIdByReceiptNum(receiptNum) {
  const snap = await get(ref(db, "orders"));
  if (!snap.exists()) return null;

  let found = null;

  snap.forEach(child => {
    const val = child.val();
    if (String(val.receiptNum) === String(receiptNum)) {
      found = child.key;
    }
  });

  return found;
}
// ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·
async function updateStatusFromWaseet(orderData) {
  try {
    const receipt = orderData.receiptNum;
    if (!receipt) return;

    // 1ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·
    const result = await updateOrdersStatusFromWaseet([orderData]);

    if (!result || result.length === 0) {
      console.warn("âš ï¸ Ø§Ù„ÙˆØ³ÙŠØ· Ù„Ù… ÙŠØ±Ø¬Ø¹ Ø­Ø§Ù„Ø©");
      return;
    }

    const mapped = result[0].systemStatus;
    if (!mapped) {
      console.warn("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ systemStatus");
      return;
    }

    // 2ï¸âƒ£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† orderId Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ø¨Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„
    const realOrderId = await getOrderIdByReceiptNum(receipt);

    if (!realOrderId) {
      console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ ÙŠØ·Ø§Ø¨Ù‚ Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„:", receipt);
      return;
    }

    const userName =
      loggedUser?.displayName ||
      loggedUser?.name ||
      loggedUser?.username ||
      "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    // 3ï¸âƒ£ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
    await update(ref(db, `orders/${realOrderId}`), {
      status: mapped,
      updatedBy: userName,
      enterIndex: Date.now()
    });

    console.log("ğŸ”¥ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Firebase Ø¨Ù†Ø¬Ø§Ø­:", mapped);

  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", err);
  }
}

    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
    async function loadOrder() {
      const snapshot = await get(ref(db, `orders/${orderId}`));
      if (!snapshot.exists()) return;
      const data = snapshot.val();

      document.getElementById("code").value = data.code || "";
      document.getElementById("phone1").value = data.phone1 || "";
      document.getElementById("phone2").value = data.phone2 || "";
      document.getElementById("address").value = data.address || "";
      document.getElementById("notes").value = data.notes || "";
      document.getElementById("advertiser").value = data.advertiser || "";
      document.getElementById("orderDate").value = data.orderDate || "-";
      document.getElementById("price").value = data.price || "";
      document.getElementById("quantity").value = data.quantity || "";

// Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§ØªØµØ§Ù„
const phone = String(data.phone1 || "").trim();
if (phone) {
  const callBtn = document.getElementById("callBtn");
  const waBtn = document.getElementById("whatsappBtn");
  
  callBtn.href = `tel:${phone}`;

let normalizedPhone = phone.replace(/[^\d]/g, '');

if (normalizedPhone.startsWith("00964")) {
  normalizedPhone = normalizedPhone.replace("00964", "964");
}
else if (normalizedPhone.startsWith("964")) {
  // ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
}
else if (normalizedPhone.startsWith("0")) {
  normalizedPhone = "964" + normalizedPhone.substring(1);
}
else {
  normalizedPhone = "964" + normalizedPhone;
}

waBtn.href = `https://api.whatsapp.com/send?phone=${normalizedPhone}`;

waBtn.setAttribute("target", "_blank");
waBtn.setAttribute("rel", "noopener noreferrer");

}


      // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©
      const cityDiv = document.getElementById("city");
      const areaDiv = document.getElementById("area");
      const cityDropdown = createDropdown(allCities, data.city || "", val => {
        update(ref(db, `orders/${orderId}`), { city: val, area: "" });
        areaDiv.innerHTML = "";
        const newAreas = citiesData[val] || [];
        const areaDropdown = createDropdown(newAreas, "", newA => update(ref(db, `orders/${orderId}`), { area: newA }));
        areaDiv.appendChild(areaDropdown);
      });
      cityDiv.appendChild(cityDropdown);

      const areas = citiesData[data.city] || [];
      const areaDropdown = createDropdown(areas, data.area || "", val => update(ref(db, `orders/${orderId}`), { area: val }));
      areaDiv.appendChild(areaDropdown);
      // Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      const productDiv = document.getElementById("product");
// âœ… Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†Ø¶ÙŠÙÙ‡ Ù…Ø¤Ù‚ØªØ§Ù‹
if (data.productName && !allProducts.includes(data.productName)) {
  allProducts.unshift(data.productName);
}
const productDropdown = createDropdown(
  allProducts,
  data.productName || "",
  async val => {

    // 1) ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
    await update(ref(db, `orders/${orderId}`), { productName: val });

    // 2) ØªØµÙÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ (ğŸ”¥ Ø£Ù‡Ù… Ù†Ù‚Ø·Ø©)
    await set(ref(db, `orders/${orderId}/selectedVariants`), {});

    // 3) Ù…Ø³Ø­ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById("variantsContainer").innerHTML = "";

    // 4) ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    loadVariants(val);
  }
);



      productDiv.appendChild(productDropdown);

// Ø§Ù„Ø­Ø§Ù„Ø© (Ø¥Ø¸Ù‡Ø§Ø± ÙÙ‚Ø· Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
function setupStatusDropdown(currentValue) {
  // âœ”ï¸ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  let statusOptions = ["Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©", "Ø±ÙØ¶"];

  // âœ”ï¸ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø«Ù„ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„" ÙˆØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€” Ù†Ø¶ÙŠÙÙ‡Ø§
  if (currentValue && !statusOptions.includes(currentValue)) {
    statusOptions.push(currentValue);
  }

  const statusDiv = document.getElementById("status");
  statusDiv.innerHTML = "";

  // ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ dropdown
  const dropdown = createDropdown(statusOptions, currentValue, async (val) => {
    await saveStatus(val.trim());
  });

  statusDiv.appendChild(dropdown);

  // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
  const statusInput = statusDiv.querySelector("input");
  statusInput.addEventListener("change", async () => {
    const val = statusInput.value.trim();
    if (!val) return;

    if (!statusOptions.includes(val)) {
      statusOptions.push(val);
    }

    await saveStatus(val);
  });
}



// ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
async function saveStatus(val) {

  const userName =
    loggedUser?.displayName ||
    loggedUser?.name ||
    loggedUser?.username ||
    "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const snap = await get(ref(db, `orders/${orderId}`));
  const oldData = snap.exists() ? snap.val() : {};
  const prevFixed = oldData.fixedBy || "";

  let newFixedBy = prevFixed;

  // â­ ØªØ«Ø¨ÙŠØª fixedBy Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯: Ù…Ø«Ø¨Øª / Ø±ÙØ¶
  if (!prevFixed && (val === "Ù…Ø«Ø¨Øª" || val === "Ø±ÙØ¶")) {
    newFixedBy = userName;
  }

  // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Firebase
  await update(ref(db, `orders/${orderId}`), {
    status: val,
    updatedBy: userName,
    fixedBy: newFixedBy,
    enterIndex: Date.now()
  });

  // Ø¥Ø´Ø¹Ø§Ø± ØµÙØ­Ø© Ø§Ù„ÙƒØ±ÙˆØª
  window.parent.postMessage(
    { type: "statusChanged", orderId, newStatus: val },
    "*"
  );
}




setupStatusDropdown(data.status || "");


   // ğŸ›‘ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± â€” ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
extraProducts = [];
document.getElementById("extraProducts").innerHTML = "";

// ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
if (data.extraProducts && Array.isArray(data.extraProducts)) {
  data.extraProducts.forEach(p => addExtraProduct(p));
}

    }
  // âœ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
  ["code","phone1","phone2","address","price","quantity","notes","advertiser"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.dataset.oldValue = el.value;
  });
// ==========================
//  ğŸ”¥ ÙØ­Øµ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
// ==========================
async function validateBeforeSave() {
  let valid = true;
// Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© Ø±ÙØ¶ â€” Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† ÙØ­Øµ
// â­ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† ÙØ­Øµ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¶Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
const statusVal = document.querySelector("#status input")?.value.trim();
const requiredStatuses = ["Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"];

if (!requiredStatuses.includes(statusVal)) {
  return true; // â¬…ï¸ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙØ­Øµ
}


  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  document.querySelectorAll(".input-error")
    .forEach(e => e.classList.remove("input-error"));

  function errorField(selector, msg) {
    const el = document.querySelector(selector);
    if (el) el.classList.add("input-error");
    showToast(msg);
    valid = false;
  }

  // 1) Ø§Ù„ÙƒÙˆØ¯
  if (!document.getElementById("code").value.trim()) {
    errorField("#code", "âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯");
  }

  // 2) Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
  const phone = document.getElementById("phone1").value.trim().replace(/\D/g, "");
  if (phone.length < 11) {
    errorField("#phone1", "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
  }

  // 3) Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
  if (!document.querySelector("#city input")?.value.trim()) {
    errorField("#city input", "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
  }

  // 4) Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
  if (!document.querySelector("#area input")?.value.trim()) {
    errorField("#area input", "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©");
  }

  // 5) Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
  if (!document.querySelector("#product input")?.value.trim()) {
    errorField("#product input", "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬");
  }

  // 6) Ø§Ù„Ø³Ø¹Ø±
  const price = document.getElementById("price").value.replace(/,/g, "").trim();
  if (!price || Number(price) <= 0) {
    errorField("#price", "âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¹Ø±");
  }

  // 7) Ø§Ù„Ø¹Ø¯Ø¯
  const qty = document.getElementById("quantity").value.replace(/,/g, "").trim();
  if (!qty || Number(qty) <= 0) {
    errorField("#quantity", "âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹");
  }

  // 8) Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  document.querySelectorAll("#variantsContainer .variant-group").forEach(group => {
    const label = group.querySelector("label")?.textContent.replace(":", "").trim();
    const input = group.querySelector("input");
    if (!input.value.trim()) {
      input.classList.add("input-error");
      showToast(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØºÙŠØ±: ${label}`);
      valid = false;
    }
  });

  // 9) Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  for (const p of extraProducts) {
    const card = document.querySelector(`.extra-product[data-pid="${p.id}"]`);

    if (!p.name || !p.name.trim()) {
      const input = card.querySelector(".field.single input");
input.classList.add("input-error");
showToast("âš ï¸ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");
valid = false;
    }
    if (p.qty <= 0) {
      const input = card.querySelector(".qty-input");
      input.classList.add("input-error");
      showToast(`âš ï¸ Ø§Ù„Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù†ØªØ¬: ${p.name}`);
      valid = false;
    }
    if (p.price <= 0) {
      const input = card.querySelector(".price-input");
      input.classList.add("input-error");
      showToast(`âš ï¸ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù†ØªØ¬: ${p.name}`);
      valid = false;
    }

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
    const vGroups = card.querySelectorAll(".variant-group input");
    vGroups.forEach(v => {
      const title = v.parentElement.querySelector("label")?.textContent.replace(":", "");
      if (!v.value.trim()) {
        v.classList.add("input-error");
        showToast(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ${title} Ù„Ù„Ù…Ù†ØªØ¬: ${p.name}`);
        valid = false;
      }
    });
  }

  return valid;
}


    // ğŸ”¹ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
document.getElementById("saveBtn").addEventListener("click", async () => {

  const isValid = await validateBeforeSave();
  if (!isValid) return; // ğŸ›‘ ÙˆÙ‚Ù Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ Ø£ÙƒÙˆ Ø®Ø·Ø£

  // Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  const mainProduct = {
    name: document.getElementById("product").querySelector("input").value.trim(),
    price: parseFloat(document.getElementById("price").value) || 0,
    qty: parseFloat(document.getElementById("quantity").value) || 0,
  };

  const mainSnap = await get(ref(db, `orders/${orderId}/selectedVariants`));
  const mainVariants = mainSnap.exists() ? mainSnap.val() : {};

  const notesArray = [];
  const productsDetailed = [];

  // Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ â€” Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  if (mainProduct.name) {
    const variantsContainer = document.getElementById("variantsContainer");
    let variantsObj = {};

    variantsContainer.querySelectorAll(".variant-group").forEach(group => {
      const label = group.querySelector("label")?.textContent.replace(":", "").trim();
      const input = group.querySelector("input")?.value.trim();
      if (label && input) variantsObj[label] = input;
    });

    let varsText = "";
    if (Object.keys(variantsObj).length > 0) {
      const varsArr = Object.entries(variantsObj).map(([k, v]) => `${k}: ${v}`);
      varsText = ` (${varsArr.join("ØŒ ")})`;
    }

    notesArray.push(`${mainProduct.name} Ã—${mainProduct.qty}${varsText}`);
productsDetailed.push({
  name: mainProduct.name,
  qty: mainProduct.qty,
  price: mainProduct.price,  // ğŸ”¥ Ø§Ù„Ø³Ø¹Ø± Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  variants: variantsObj
});
  }

  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  extraProducts.forEach(p => {
    const card = document.querySelector(`.extra-product[data-pid="${p.id}"]`);
    if (!card) return;

    let varsObj = {};
    card.querySelectorAll(".variant-group").forEach(group => {
      const label = group.querySelector("label")?.textContent.replace(":", "").trim();
      const input = group.querySelector("input")?.value.trim();
      if (label && input) varsObj[label] = input;
    });

    let varsText = "";
    if (Object.keys(varsObj).length > 0) {
      const varsArr = Object.entries(varsObj).map(([k, v]) => `${k}: ${v}`);
      varsText = ` (${varsArr.join("ØŒ ")})`;
    }

    notesArray.push(`${p.name} Ã—${p.qty}${varsText}`);
   productsDetailed.push({
  name: p.name,
  qty: p.qty,
  price: p.price,  // ğŸ”¥ Ø§Ù„Ø³Ø¹Ø± Ù…Ø§Ù„ ÙƒÙ„ Ù…Ù†ØªØ¬ Ø¥Ø¶Ø§ÙÙŠ
  variants: varsObj
});

  });
  
// ğŸ”¥ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
const cleanedDetails = productsDetailed.filter(p => p.name && p.name.trim() !== "");

// ğŸ”¥ Ø¬Ù…Ø¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø¶Ø±Ø¨)
const totalPrice = cleanedDetails.reduce((sum, item) => {
  return sum + (Number(item.price) || 0);
}, 0);

// ğŸ”¥ Ø¬Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” ÙÙ‚Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
const finalProductName = [
  ...new Set(cleanedDetails.map(item => item.name.trim()))
].join("ØŒ ");

// ğŸ”¥ Ø¬Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©
const totalQty = cleanedDetails.reduce((sum, item) => {
  return sum + (Number(item.qty) || 0);
}, 0);


// â­ 1 â€” Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const autoNotes = notesArray.join(" | ").trim();

// â­ 2 â€” Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙ‚Ø· (Ù†Ø­Ø°Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©)
let userNotes = document.getElementById("notes").value.trim();

// Ù†Ø­Ø°Ù Ø£ÙŠ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ (Ã— Ø£Ùˆ : Ø£Ùˆ |) Ù„Ø£Ù†Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
userNotes = userNotes
  .split("||")
  .map(p => p.trim())
  .filter(p => p && !p.includes("Ã—") && !p.includes(":") && !p.includes("|"))
  .join(" || ")
  .trim();

// â­ 3 â€” Ø¯Ù…Ø¬ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ + Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
let finalNotes = autoNotes;
if (userNotes) {
  finalNotes += " || " + userNotes;
}



const updates = {
  code: document.getElementById("code").value.trim(),
  phone1: document.getElementById("phone1").value.trim(),
  phone2: document.getElementById("phone2").value.trim(),
  address: document.getElementById("address").value.trim(),

productName: mainProduct.name,   // ÙÙ‚Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
totalProducts: finalProductName, // Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†
  totalPrice: totalPrice,
  totalQty: totalQty,

  notes: finalNotes,
  advertiser: document.getElementById("advertiser").value.trim(),

  price: mainProduct.price,
  quantity: mainProduct.qty,

  extraProducts: extraProducts,
  selectedVariants: mainVariants,
  productsDetailed: productsDetailed
};


  // ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨
  await update(ref(db, `orders/${orderId}`), updates);

  // ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù„Ùˆ Ù„Ø§Ø²Ù…)
  const newStatusInput = document.getElementById("status").querySelector("input");
  const newStatus = newStatusInput ? newStatusInput.value.trim() : "";

  if (["Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"].includes(newStatus)) {
    console.log("ğŸ”¥ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„:", newStatus);
await fetch("https://YOUR_SERVER/api/update-stock-on-status", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ orderId, status: newStatus })
});
  }

  // â­ Ø¢Ø®Ø± Ø®Ø·ÙˆØ© â€” Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†
  const lastStatus = localStorage.getItem("currentFilterStatus") || "";
  const lastScroll = localStorage.getItem("previousScrollPosition") || "0";

  localStorage.setItem("restoreScrollAfterReturn", lastScroll);

  window.location.href =
    "orders-cards.html" +
    (lastStatus ? `?status=${encodeURIComponent(lastStatus)}` : "");
});




document.addEventListener("DOMContentLoaded", async () => {
  await loadOrder();

  // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ (Ù†ÙØ³ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª)
  ["code","phone1","phone2","address","price","quantity","notes","advertiser"].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;

    // Ù†Ø®Ø²Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    el.dataset.oldValue = el.value;

    // Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ± Ù†Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
    el.addEventListener("change", () => {
      const oldVal = el.dataset.oldValue || "";
      const newVal = el.value.replace(/,/g, ""); // Ù†Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      recordChange(orderId, id, oldVal, newVal);
      el.dataset.oldValue = newVal;
    });
  });

  // âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¹Ø¯Ø¯ Ø¨ÙØ§ØµÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
  ["price", "quantity"].forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;

    input.addEventListener("input", e => {
      let val = e.target.value.replace(/[^\d]/g, ""); // Ù†Ø²ÙŠÙ„ Ø£ÙŠ Ø´ÙŠØ¡ ØºÙŠØ± Ø±Ù‚Ù…
      if (val) {
        e.target.value = new Intl.NumberFormat("en-US").format(val); // Ù†Ø¶ÙŠÙ Ø§Ù„ÙØ§ØµÙ„Ø©
      }
    });

    input.addEventListener("change", e => {
      e.target.value = e.target.value.replace(/,/g, ""); // Ù†Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    });
  });
});

    // ğŸŸ¦ Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒÙÙ‚Ø§Ø¹Ø§Øª Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"
function renderProductTags() {
  const container = document.getElementById("productTagsContainer");
  container.innerHTML = "";

  // Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  const mainName = document.getElementById("product").querySelector("input").value.trim();
  if (mainName) {
    const chip = createTagChip(mainName, () => {
      document.getElementById("product").querySelector("input").value = "";
      renderProductTags();
    });
    container.appendChild(chip);
  }

  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  extraProducts.forEach((p, i) => {
    if (p.name) {
      const chip = createTagChip(p.name, () => {
        extraProducts.splice(i, 1);
        renderProductTags();
      });
      container.appendChild(chip);
    }
  });
}

// ğŸŸ§ Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
function createTagChip(name, onRemove) {
  const chip = document.createElement("div");
  chip.textContent = name;
  chip.style.cssText = `
    background:#043B64;
    color:white;
    padding:5px 12px;
    border-radius:20px;
    display:flex;
    align-items:center;
    gap:6px;
    font-size:13px;
  `;

  const removeBtn = document.createElement("span");
  removeBtn.textContent = "âœ–";
  removeBtn.style.cssText = "cursor:pointer;font-weight:bold;";
  removeBtn.onclick = onRemove;
  chip.appendChild(removeBtn);

  return chip;
}
document.getElementById("backBtn").addEventListener("click", () => {
  // Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ…Ø±ÙŠØ±
  localStorage.setItem("restoreScrollAfterReturn", window.scrollY.toString());

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± ÙÙ„ØªØ±Ø©
  const status = localStorage.getItem("currentFilterStatus") || "";

  // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
  const url = "orders-cards.html" + (status ? `?status=${encodeURIComponent(status)}` : "");

window.location.replace(url);
});






window.adjustStockOnStatusChange = async function(orderId, newStatus) {
  const db = getDatabase();
  const orderRef = ref(db, `orders/${orderId}`);
  const orderSnap = await get(orderRef);
  if (!orderSnap.exists()) return;

  const order = orderSnap.val();
  console.log("ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© Ø£ØµÙ„ÙŠØ©):", orderId, newStatus);

  const products = [];

  function addProduct(name, qty, variants) {
    if (!name || qty <= 0) return;
    const variantKey = variants && Object.keys(variants).length > 0
      ? Object.entries(variants).map(([k, v]) => `${k} | ${v}`).join(" | ")
      : "Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±";
    products.push({ name, qty, variantKey, variants });
  }

  // Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  if (order.productName && order.quantity)
    addProduct(order.productName, Number(order.quantity), order.selectedVariants || {});

  // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  if (Array.isArray(order.extraProducts)) {
    order.extraProducts.forEach(p => {
      addProduct(p.name, Number(p.qty) || 1, p.selectedVariants || {});
    });
  }

  // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  if (Array.isArray(order.productsDetailed)) {
    order.productsDetailed.forEach(p => {
      addProduct(p.name, Number(p.qty) || 1, p.variants || {});
    });
  }

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø®ØµÙ… Ø£Ùˆ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
  for (const item of products) {
    const { name, qty, variants } = item;

    const warehouseRef = ref(db, `warehouse/${name}`);
    const warehouseSnap = await get(warehouseRef);
    if (!warehouseSnap.exists()) continue;

    const warehouse = warehouseSnap.val();
    const stock = warehouse.stock || {};
    const processed = warehouse.processedOrders || {};

    // ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    const variantValues = Object.values(variants || {}).map(v => v.trim().toLowerCase());
    let foundKey = null;

    for (const key of Object.keys(stock)) {
      const keyNorm = key.toLowerCase();
      const matches = variantValues.filter(v => keyNorm.includes(v)).length;
      if (matches === variantValues.length && matches > 0) {
        foundKey = key;
        break;
      }
    }

    const variantId = item.variantKey.replace(/\s+/g, "_");
    const uniqueKey = `${orderId}_${name}_${variantId}`;

    // Ø§Ù„Ø®ØµÙ…
    if (newStatus === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„" && !processed[`deduct_${uniqueKey}`]) {
      if (foundKey && stock[foundKey] !== undefined) {
        stock[foundKey] -= qty;
      } else if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
        stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] -= qty;
      } else {
        stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = -qty;
      }
      processed[`deduct_${uniqueKey}`] = true;
    }

    // Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
    if (newStatus === "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹" && processed[`deduct_${uniqueKey}`]) {
      if (foundKey && stock[foundKey] !== undefined) {
        stock[foundKey] += qty;
      } else if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
        stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] += qty;
      } else {
        stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = qty;
      }
      processed[`return_${uniqueKey}`] = true;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    let totalQty = 0;
    for (const val of Object.values(stock)) {
      totalQty += Number(val) || 0;
    }

    await update(warehouseRef, {
      stock,
      totalQty,
      processedOrders: processed,
      lastUpdate: new Date().toISOString(),
    });
  }
};

// ğŸ§­ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„
document.addEventListener("DOMContentLoaded", () => {
  const savedScroll = localStorage.getItem("restoreScrollAfterReturn");
  if (savedScroll) {
    window.scrollTo(0, parseInt(savedScroll));
    localStorage.removeItem("restoreScrollAfterReturn");
  }
});

  </script>
  <!-- âœ… ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† Ø§Ù„ØµÙˆØª Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØµÙˆØª ÙØ¹Ù„ÙŠ (ØµØ§Ù…Øª ØªÙ…Ø§Ù…Ù‹Ø§) -->
<script type="module">
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
window.orderId = localStorage.getItem("selectedOrder"); // âœ… ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨

// ğŸ§  Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
window.historyStack = [];
window.redoStack = [];

// âœ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„
window.recordChange = function (orderId, field, oldVal, newVal) {
  if (oldVal === newVal) return;
  window.historyStack.push({ orderId, field, oldVal, newVal });
  window.redoStack = [];
  console.log(`ğŸ•˜ ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ ${field}: Ù…Ù† "${oldVal}" Ø¥Ù„Ù‰ "${newVal}"`);
};

// âœ… ØªØ±Ø§Ø¬Ø¹
window.undoChange = async function () {
  const last = window.historyStack.pop();
  if (!last) return showToast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡");

  const { orderId, field, oldVal } = last;

  // ğŸ”¹ Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
  const input = document.getElementById(field);
  if (input) input.value = oldVal;

  // ğŸ”¹ Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£ÙŠØ¶Ù‹Ø§ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  await update(ref(db, `orders/${orderId}`), { [field]: oldVal });

  window.redoStack.push(last);
  showToast(`â†©ï¸ ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† ØªØ¹Ø¯ÙŠÙ„ ${field}`);
};

// âœ… Ø¥Ø¹Ø§Ø¯Ø©
window.redoChange = async function () {
  const last = window.redoStack.pop();
  if (!last) return showToast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ø¥Ø¹Ø§Ø¯ØªÙ‡");

  const { orderId, field, newVal } = last;

  // ğŸ”¹ Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
  const input = document.getElementById(field);
  if (input) input.value = newVal;

  // ğŸ”¹ Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£ÙŠØ¶Ù‹Ø§ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  await update(ref(db, `orders/${orderId}`), { [field]: newVal });

  window.historyStack.push(last);
  showToast(`â†ªï¸ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¯ÙŠÙ„ ${field}`);
};


// âœ… Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key === "z") undoChange();
  if (e.ctrlKey && e.key === "y") redoChange();
});

// âœ… Ù†Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø±
document.addEventListener("DOMContentLoaded", () => {
  const undoBtn = document.getElementById("undoBtn");
  const redoBtn = document.getElementById("redoBtn");
  if (undoBtn) undoBtn.onclick = () => undoChange();
  if (redoBtn) redoBtn.onclick = () => redoChange();
});


// âœ… Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ· Ø¨Ø¯Ù„ alert
function showToast(msg) {
  const toast = document.createElement("div");
  toast.textContent = msg;
  Object.assign(toast.style, {
    position: "fixed",
    bottom: "80px",
    left: "15px",
    background: "#043B64",
    color: "#fff",
    padding: "10px 15px",
    borderRadius: "8px",
    fontSize: "13px",
    boxShadow: "0 2px 8px rgba(0,0,0,0.3)",
    zIndex: 99999,
    opacity: 0,
    transition: "opacity 0.3s ease"
  });
  document.body.appendChild(toast);
  requestAnimationFrame(() => (toast.style.opacity = 1));
  setTimeout(() => {
    toast.style.opacity = 0;
    setTimeout(() => toast.remove(), 500);
  }, 1800);
}
</script>


<!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± -->
<div class="top-contact-buttons">
  <a id="callBtn" class="contact-btn" title="Ø§ØªØµØ§Ù„">ğŸ“</a>
  <a id="whatsappBtn" class="contact-btn whatsapp" title="ÙˆØ§ØªØ³Ø§Ø¨">ğŸ’¬</a>
</div>

</body>
</html> 
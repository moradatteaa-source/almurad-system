<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§¾ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #043B64;
      --orange: #FF6B2D;
      --bg: #f4f6fa;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg);
      color: var(--blue);
      margin: 0;
    }

    header {
      background: var(--blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    header h2 {
      font-size: 20px;
      margin: 0;
    }

    header button {
      background: var(--orange);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      padding: 10px 18px;
      cursor: pointer;
      transition: 0.3s;
    }

    header button:hover { opacity: 0.9; }

    .container {
      max-width: 1250px;
      margin: 25px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h3 {
      color: var(--blue);
      border-bottom: 2px solid var(--orange);
      padding-bottom: 5px;
      margin-top: 0;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      background: #f9fafc;
      padding: 10px;
      border-radius: 8px;
    }

    .filter-bar input, .filter-bar select {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px;
      flex: 1;
      min-width: 150px;
    }

    .filter-bar button {
      background: var(--orange);
      border: none;
      border-radius: 8px;
      color: white;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 25px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    th {
      background: var(--blue);
      color: white;
    }

    tr:hover td { background: #fff9f5; }

    .stat-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-card {
      flex: 1;
      min-width: 160px;
      background: var(--blue);
      color: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card span {
      display: block;
      color: var(--orange);
      font-weight: bold;
      margin-top: 4px;
    }

    /* âœ… Popup Overlay */
    .popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .popup-box h3 {
      text-align: center;
      color: var(--blue);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: 'Tajawal';
    }

    button.action {
      background: var(--orange);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 8px;
    }

    button.action:hover { background: #ff864d; }

    /* âœ… Scroll inside variant section */
    .variants-container {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      background: #fafafa;
    }

    .variant-item {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .variant-item input {
      flex: 1;
    }

    .variant-item button {
      background: #c0392b;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    .variant-item button:hover {
      background: #e74c3c;
    }

    .report-bar {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 15px;
    }

    .report-bar button {
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 600;
    }

    @media (max-width:700px) {
      header { flex-direction: column; text-align: center; gap: 10px; }
      .form-grid { grid-template-columns: 1fr; }
      table { font-size: 13px; }
      .variant-item { flex-direction: column; align-items: stretch; }
    }
    /* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ */
#productSearchInput:focus {
  outline: none;
  border-color: var(--orange);
  box-shadow: 0 0 6px rgba(255, 107, 45, 0.4);
}

  </style>
</head>
<!-- âœ… Ù†Ø§ÙØ°Ø© ØªØ¬Ø§Ø± Ø§Ù„Ø¬Ù…Ù„Ø© (Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©) -->
<div class="popup-overlay" id="wholesalersPopup">
  <div class="popup-box" style="max-width: 750px; width: 95%;">
    <h3 style="text-align:center;color:#043B64;">ğŸ¬ Ù‚Ø§Ø¦Ù…Ø© ØªØ¬Ù‘Ø§Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</h3>
    <button onclick="closeWholesalersPopup()" style="
      position:absolute;top:12px;left:12px;
      background:#c0392b;color:white;border:none;
      padding:6px 12px;border-radius:6px;cursor:pointer;">âœ–</button>

    <!-- ğŸ” Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« -->
    <input id="whSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." 
      style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:8px;" 
      oninput="filterWholesalers()">

    <!-- ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø§Ø± -->
    <div style="overflow-x:auto;max-height:60vh;">
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:#043B64;color:white;">
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>ğŸ—’ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="wholesalersTable">
          <tr><td colspan="4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<style>
  /* âœ… Ø¬Ø¹Ù„ Ø®Ù„ÙÙŠØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨ÙŠØ¶Ø§Ø¡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
table {
  width: 100%;
  border-collapse: collapse;
  background-color: #fff; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶ */
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 8px;
  overflow: hidden;
}

th, td {
  background-color: #fff; /* ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙÙˆÙ */
  border: 1px solid #e0e0e0;
  padding: 10px;
  text-align: center;
}

th {
  background-color: #f7f9fc; /* ØªÙ…ÙŠÙŠØ² ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ù„ÙˆÙ† ÙØ§ØªØ­ */
  color: #043B64;
  font-weight: bold;
}

tr:hover {
  background-color: #f9f9f9; /* ØªØ£Ø«ÙŠØ± Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ */
}

/* âœ… Ù†ÙØ³ ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ */
#wholesalersPopup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

#wholesalersPopup .popup-box {
  position: relative;
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {opacity:0; transform: scale(0.95);}
  to {opacity:1; transform: scale(1);}
}

@media (max-width:600px){
  #wholesalersPopup .popup-box{
    width: 95%;
    padding: 15px;
  }
  #wholesalersPopup table th, #wholesalersPopup table td{
    font-size: 13px;
    padding: 6px;
  }
}
</style>


<body>
  <header>
    <h2>ğŸ§¾ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ø¯</h2>
    <button onclick="openPurchasePopup()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</button>
    <button onclick="openWholesalersPopup()">ğŸ¬ ØªØ¬Ø§Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</button>

  </header>

  <div class="container">
    <div class="filter-bar">
      <input type="date" id="fromDate">
      <input type="date" id="toDate">
      <select id="timeFilter">
        <option value="">ØªØµÙÙŠØ© Ø³Ø±ÙŠØ¹Ø©</option>
        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
        <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
        <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
        <option value="lastMonth">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</option>
      </select>
      <button onclick="filterPurchases()">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©</button>
    </div>

    <div class="report-bar">
      <button onclick="downloadFullPDF()">ğŸ“„ ØªÙ‚Ø±ÙŠØ± PDF Ø´Ø§Ù…Ù„</button>
      <button onclick="downloadFullExcel()">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Excel Ø´Ø§Ù…Ù„</button>
    </div>

    <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
    <div class="stat-cards">
      <div class="stat-card">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±<span id="totalInvoices">0</span></div>
      <div class="stat-card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª<span id="totalQty">0</span></div>
      <div class="stat-card">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº<span id="totalAmount">0</span></div>
      <div class="stat-card">Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©<span id="lastPurchase">-</span></div>
    </div>
  </div>

    <h3>ğŸ“‹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„Ù…ØªØºÙŠØ±</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
          <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
          <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="purchaseTable">
        <tr><td colspan="10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯</td></tr>
      </tbody>
    </table>


  <!-- âœ… Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ -->
  <div class="popup-overlay" id="purchasePopup">
    <div class="popup-box">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <div class="form-grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
          <select id="supplierSelect"></select>
          <button class="action" onclick="openSupplierPopup()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
        </div>

        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬:</label>
          <select id="productType" onchange="handleProductTypeChange()">
            <option value="">Ø§Ø®ØªØ±...</option>
            <option value="existing">Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯</option>
            <option value="new">Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</option>
          </select>
        </div>

        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ:</label>
          <input type="text" id="buyerName" placeholder="Ù…Ø±Ø§Ø¯ / Ù…Ù‚Ø¯Ø§Ø¯ / Ø±Ù…Ø¶Ø§Ù†">
        </div>
      </div>
      <!-- âœ… Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ -->
      <div id="existingProductDiv" style="display:none;margin-top:10px;">
  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>

  <!-- ğŸ” Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« -->
  <input 
    type="text" 
    id="productSearchInput" 
    placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬..." 
    style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-bottom:6px;"
    oninput="filterProductOptions()"
  >

  <!-- ğŸ”½ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <select id="existingProductSelect" size="6" style="width:100%;padding:8px;border-radius:6px;"></select>

  <div id="variantContainer" class="variants-container" style="margin-top:10px;"></div>
</div>
<button class="action" id="addOldVariantBtn" style="display:none;margin-top:8px;">â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯</button>


      <!-- âœ… Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ -->
      <div id="newProductDiv" style="display:none;margin-top:10px;">
        <!-- ğŸŸ¢ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ + Ø§Ù„Ø£Ø³Ø¹Ø§Ø± + Ø§Ù„ÙƒÙ…ÙŠØ©) -->
        <div id="simpleFields">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
          <input type="text" id="simpleProductName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">

          <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
          <input type="number" id="simpleBuyPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">

          <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
          <input type="number" id="simpleSellPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">

          <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
          <input type="number" id="simpleQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        </div>

        <!-- ğŸŸ  Ù‡Ù†Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ Ø£Ø¶Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
        <div class="variants-container" id="newVariantContainer"></div>
        <button class="action" onclick="addNewVariant()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±</button>
      </div>

      <!-- âœ… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
      <textarea id="notes" rows="2"></textarea>
      <button class="action" onclick="savePurchase()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="action" style="background:#777;" onclick="closePurchasePopup()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>

  <!-- âœ… Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ -->
  <div class="popup-overlay" id="supplierPopup">
    <div class="popup-box">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
      <input id="supplierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯">
      <input id="supplierPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
      <input id="supplierAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
      <textarea id="supplierNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
      <button class="action" onclick="saveSupplier()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="action" style="background:#777;" onclick="closeSupplierPopup()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
 

  <script type="module">
/* =========================
   ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
  projectId: "almurad-system",
  storageBucket: "almurad-system.appspot.com",
  messagingSenderId: "911755824405",
  appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =========================
   ğŸ§© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ±
========================= */
const supplierSelect = document.getElementById("supplierSelect");
const supplierPopup = document.getElementById("supplierPopup");
const purchasePopup = document.getElementById("purchasePopup");
const purchaseTable = document.getElementById("purchaseTable");
const existingProductDiv = document.getElementById("existingProductDiv");
const newProductDiv = document.getElementById("newProductDiv");
const existingProductSelect = document.getElementById("existingProductSelect");
const variantContainer = document.getElementById("variantContainer");
const newVariantContainer = document.getElementById("newVariantContainer");

let suppliers = {};
let warehouseProducts = {};
let purchases = [];

/* =========================
   ğŸªŸ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
========================= */
window.openPurchasePopup = () => {
  purchasePopup.style.display = "flex";

  // ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ ÙƒÙ„ ÙØªØ­
  document.getElementById("productType").value = "";
  document.getElementById("supplierSelect").value = "";
  document.getElementById("buyerName").value = "";
  document.getElementById("notes").value = "";

  // ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬
  const inputFields = [
    "productSearchInput",
    "simpleProductName",
    "simpleBuyPrice",
    "simpleSellPrice",
    "simpleQty",
  ];
  inputFields.forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // ğŸ§¹ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
  document.getElementById("variantContainer").innerHTML = "";
  document.getElementById("newVariantContainer").innerHTML = "";

  // ğŸ§¹ Ø¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬
  document.getElementById("existingProductDiv").style.display = "none";
  document.getElementById("newProductDiv").style.display = "none";

  // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª
  loadSuppliers();
  loadProducts();
};

window.closePurchasePopup = () => (purchasePopup.style.display = "none");
window.openSupplierPopup = () => (supplierPopup.style.display = "flex");
// âœ… ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¬Ø§Ø± Ø§Ù„Ø¬Ù…Ù„Ø© (Popup)
window.openWholesalersPopup = () => {
  document.getElementById("wholesalersPopup").style.display = "flex";
  loadWholesalers();
};

// âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
window.closeWholesalersPopup = () => {
  document.getElementById("wholesalersPopup").style.display = "none";
};

// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ø§Ø± Ù…Ù† Realtime Database
window.loadWholesalers = () => {
  const table = document.getElementById("wholesalersTable");
  onValue(ref(db, "suppliers"), (snap) => {
    table.innerHTML = "";
    if (!snap.exists()) {
      table.innerHTML = `<tr><td colspan="4">ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ø¨Ø¹Ø¯</td></tr>`;
      return;
    }
    const data = snap.val();
    Object.values(data).forEach(s => {
      table.innerHTML += `
        <tr>
          <td>${s.name || "-"}</td>
          <td>${s.phone || "-"}</td>
          <td>${s.address || "-"}</td>
          <td>${s.notes || "-"}</td>
        </tr>`;
    });
  });
};

// ğŸ” ÙÙ„ØªØ±Ø© Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø§Ø±
window.filterWholesalers = () => {
  const input = document.getElementById("whSearch").value.toLowerCase();
  const rows = document.querySelectorAll("#wholesalersTable tr");
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(input) ? "" : "none";
  });
};

/* =========================
   ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
========================= */
function loadSuppliers() {
  const refSup = ref(db, "suppliers");
  onValue(refSup, (snap) => {
    supplierSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯...</option>`;
    if (!snap.exists()) return;
    suppliers = snap.val();
    Object.keys(suppliers).forEach((id) => {
      const s = suppliers[id];
      supplierSelect.innerHTML += `<option value="${id}">${s.name}</option>`;
    });
  });
}

/* =========================
   ğŸ’¾ Ø­ÙØ¸ Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯
========================= */
window.saveSupplier = async function () {
  const name = supplierName.value.trim();
  const phone = supplierPhone.value.trim();
  const address = supplierAddress.value.trim();
  const notes = supplierNotes.value.trim();
  if (!name || !phone) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");

  const id = "SUP-" + Date.now().toString().slice(-6);
  await set(ref(db, "suppliers/" + id), {
    id,
    name,
    phone,
    address,
    notes,
    createdAt: new Date().toISOString(),
  });

  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
  closeSupplierPopup();
  loadSuppliers();
};

/* =========================
   ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
========================= */
async function loadProducts() {
  const snap = await get(ref(db, "warehouse"));
  warehouseProducts = snap.exists() ? snap.val() : {};
}
// ğŸ§  ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
let allProductNames = [];

// ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Firebase Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
async function loadExistingProducts() {
  const snapshot = await get(ref(db, "warehouse"));
  const select = document.getElementById("existingProductSelect");
  allProductNames = [];
  select.innerHTML = "";

  if (snapshot.exists()) {
    const data = snapshot.val();
    for (const [name] of Object.entries(data)) {
      allProductNames.push(name);
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      select.appendChild(option);
    }
  }
}

// ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© + Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬
window.filterProductOptions = function () {
  const inputEl = document.getElementById("productSearchInput");
  const select = document.getElementById("existingProductSelect");
  const input = inputEl.value.toLowerCase().trim();

  select.innerHTML = "";

  // âœ… Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ ÙƒØªØ§Ø¨Ø©ØŒ Ù†Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
  const filtered = input
    ? allProductNames.filter(name => name.toLowerCase().includes(input))
    : allProductNames;

  if (filtered.length === 0) {
    const opt = document.createElement("option");
    opt.textContent = "ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©";
    opt.disabled = true;
    select.appendChild(opt);
  } else {
    filtered.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  }

  // âœ… Ù†Ø¸Ù‡Ø± Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¥Ø°Ø§ ÙÙŠÙ‡Ø§ Ù†ØªØ§Ø¦Ø¬
  select.style.display = filtered.length > 0 ? "block" : "none";

  // âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  select.onchange = async function () {
    const selectedName = select.value;
    inputEl.value = selectedName; // ÙŠØ¸Ù‡Ø± Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø®Ù„ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
    select.style.display = "none"; // Ù†Ø®ÙÙŠ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±

    // ğŸŸ¢ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const variantContainer = document.getElementById("variantContainer");
    variantContainer.innerHTML = "";
    const prod = warehouseProducts[selectedName];
    if (prod && prod.stock) {
      Object.keys(prod.stock).forEach((v) => {
        variantContainer.innerHTML += `
          <div class="variant-item">
            <input type="text" value="${v}" disabled>
            <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" class="variantQty" data-variant="${v}">
            <input type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" class="variantPrice" data-variant="${v}">
          </div>`;
      });
    }
  };
};


/* =========================
   ğŸ”„ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬
========================= */
window.handleProductTypeChange = async function () {
  existingProductDiv.style.display = "none";
  newProductDiv.style.display = "none";
  variantContainer.innerHTML = "";
  newVariantContainer.innerHTML = "";

  const type = document.getElementById("productType").value;

if (type === "existing") {
  existingProductDiv.style.display = "block";
  
  // âœ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ØªÙŠ ØªØ¨Ù†ÙŠ allProductNames
  await loadExistingProducts();
  
  // âœ… Ø¹Ø±Ø¶ Ø£ÙˆÙ„ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø¨Ù„ Ø£ÙŠ ÙƒØªØ§Ø¨Ø©
  filterProductOptions();
}

  else if (type === "new") {
    newProductDiv.style.display = "block";

   // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© (Ø§Ø³Ù…ØŒ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡ØŒ Ø³Ø¹Ø± Ø¨ÙŠØ¹ØŒ ÙƒÙ…ÙŠØ©)
if (!document.getElementById("simpleFields")) {
  const simpleFields = document.createElement("div");
  simpleFields.id = "simpleFields";
  simpleFields.innerHTML = `
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
    <input type="text" id="simpleProductName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">

    <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
    <input type="number" id="simpleBuyPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">

    <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
    <input type="number" id="simpleSellPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">

    <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
    <input type="number" id="simpleQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  `;
  newProductDiv.insertBefore(simpleFields, newVariantContainer);
}


    // âœ… ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© "Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±" Ù„ØªØ®ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
    window.addNewVariant = function () {
      const div = document.createElement("div");
      div.className = "variant-item";
      div.innerHTML = `
        <input type="text" placeholder="Ø§Ù„Ø¨ÙØ¹Ø¯ 1 (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ù„ÙˆÙ†)">
        <input type="text" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© 1 (Ù…Ø«Ù„Ø§Ù‹ Ø£Ø­Ù…Ø±)">
        <input type="text" placeholder="Ø§Ù„Ø¨ÙØ¹Ø¯ 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <input type="text" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© 2 (Ù…Ø«Ù„Ø§Ù‹ 5)">
        <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
        <button onclick="this.parentElement.remove(); checkVariantsState();">ğŸ—‘</button>
      `;
      newVariantContainer.appendChild(div);

      // âœ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
      const simpleFields = document.getElementById("simpleFields");
      if (simpleFields) simpleFields.style.display = "none";
    };

    // âœ… Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø¢Ø®Ø± Ù…ØªØºÙŠØ±
    window.checkVariantsState = function () {
      const newVariants = newVariantContainer.querySelectorAll(".variant-item");
      const simpleFields = document.getElementById("simpleFields");
      if (newVariants.length === 0 && simpleFields) {
        simpleFields.style.display = "block";
      }
    };
  }
};


/* =========================
   ğŸ§¾ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
========================= */
function renderExistingProducts(names) {
  existingProductSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>`;
  names.forEach(
    (n) => (existingProductSelect.innerHTML += `<option value="${n}">${n}</option>`)
  );
}

/* =========================
   ğŸ“Š Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯
========================= */
existingProductSelect.addEventListener("change", () => {
  const name = existingProductSelect.value;
  variantContainer.innerHTML = "";
  if (!name) return;
  const prod = warehouseProducts[name];
  if (!prod?.stock) return;

  Object.keys(prod.stock).forEach((v) => {
    variantContainer.innerHTML += `
      <div class="variant-item">
        <input type="text" value="${v}" disabled>
        <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" class="variantQty" data-variant="${v}">
        <input type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" class="variantPrice" data-variant="${v}">
      </div>`;
  });
});

/* =========================
   â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯
========================= */
// âœ… Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
// âœ… Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ (Ø¨ÙØ¹Ø¯ÙŠÙ† + Ù‚ÙŠÙ…ØªÙŠÙ† + ÙƒÙ…ÙŠØ© + Ø³Ø¹Ø±)
window.addNewVariant = function () {
  const div = document.createElement("div");
  div.className = "variant-item";
  div.innerHTML = `
    <input type="text" placeholder="Ø§Ù„Ø¨ÙØ¹Ø¯ 1 (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ù„ÙˆÙ†)">
    <input type="text" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© 1 (Ù…Ø«Ù„Ø§Ù‹ Ø£Ø­Ù…Ø±)">
    <input type="text" placeholder="Ø§Ù„Ø¨ÙØ¹Ø¯ 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ø«Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³)">
    <input type="text" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© 2 (Ù…Ø«Ù„Ø§Ù‹ 5)">
    <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
    <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
    <button onclick="this.parentElement.remove()">ğŸ—‘</button>
  `;
  newVariantContainer.appendChild(div);

  // âœ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª)
  const simpleFields = document.getElementById("simpleFields");
  if (simpleFields) simpleFields.style.display = "none";
};



/* =========================
   ğŸ’¾ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡
========================= */
window.savePurchase = async function () {
  const supplierId = supplierSelect.value;
  const supplierNameText = suppliers[supplierId]?.name || "";
  const buyer = buyerName.value.trim();
  if (!supplierId || !buyer) return alert("âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.");

  let items = [];
  let totalQty = 0;
  let totalAmount = 0;
  const type = document.getElementById("productType").value;

  if (type === "existing") {
    const name = existingProductSelect.value;
    if (!name) return alert("âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬.");

    const qtyInputs = document.querySelectorAll(".variantQty");
    const priceInputs = document.querySelectorAll(".variantPrice");
    for (let i = 0; i < qtyInputs.length; i++) {
      const variant = qtyInputs[i].dataset.variant;
      const q = parseFloat(qtyInputs[i].value) || 0;
      const price = parseFloat(priceInputs[i].value) || 0;
      if (q > 0 && price > 0) {
        const subtotal = q * price;
        totalQty += q;
        totalAmount += subtotal;
        items.push({ product: name, variant, quantity: q, price, subtotal });

        const stockRef = ref(db, `warehouse/${name}/stock/${variant}`);
        const snap = await get(stockRef);
        const current = snap.exists() ? snap.val() : 0;
        await set(stockRef, current + q);
      }
    }
  } else if (type === "new") {
  const name = document.getElementById("simpleProductName")?.value.trim() || "";
  const buyPrice = parseFloat(document.getElementById("simpleBuyPrice")?.value) || 0;
  const sellPrice = parseFloat(document.getElementById("simpleSellPrice")?.value) || 0;
  const qty = parseFloat(document.getElementById("simpleQty")?.value) || 0;

  let stock = {};
  let itemsAdded = false;

  // ğŸŸ¢ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª
  if (newVariantContainer.querySelectorAll(".variant-item").length === 0) {
    if (name && qty > 0 && buyPrice > 0) {
      stock["default"] = qty;
      const subtotal = qty * buyPrice;
      items.push({ product: name, variant: "-", quantity: qty, price: buyPrice, subtotal });
      totalQty += qty;
      totalAmount += subtotal;
      itemsAdded = true;

      await set(ref(db, "warehouse/" + name), {
        buyPrice,
        sellPrice,
        totalQty: qty,
        stock,
        lastUpdate: new Date().toISOString(),
      });
    }
  } 
  // ğŸŸ¢ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠÙ‡ Ù…ØªØºÙŠØ±Ø§Øª
  else {
    const newVariants = newVariantContainer.querySelectorAll(".variant-item");
    for (let div of newVariants) {
      const type1 = div.children[0].value.trim();
      const value1 = div.children[1].value.trim();
      const type2 = div.children[2].value.trim();
      const value2 = div.children[3].value.trim();
      const q = parseFloat(div.children[4].value) || 0;
      const price = parseFloat(div.children[5].value) || 0;

      if (!type1 || !value1 || q <= 0 || price <= 0) continue;

      const variantKey = [type1, value1, type2, value2].filter(Boolean).join(" | ");
      const subtotal = q * price;

      stock[variantKey] = q;
      totalQty += q;
      totalAmount += subtotal;
      items.push({ product: name, variant: variantKey, quantity: q, price, subtotal });
      itemsAdded = true;
    }

    if (itemsAdded) {
      await set(ref(db, "warehouse/" + name), {
        buyPrice,
        sellPrice,
        totalQty,
        stock,
        lastUpdate: new Date().toISOString(),
      });
    }
  }
}


  if (items.length === 0) return alert("âš ï¸ Ù„Ù… ØªØ¯Ø®Ù„ Ø£ÙŠ ÙƒÙ…ÙŠØ§Øª.");

  const idRef = push(ref(db, "purchases"));
  await set(idRef, {
    supplierId,
    supplierName: supplierNameText,
    buyer,
    items,
    totalQty,
    totalAmount,
    notes: notes.value,
    date: new Date().toISOString(),
  });

  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
  closePurchasePopup();
  loadPurchases();

// âœ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… printInvoice
setTimeout(() => {
  if (window.purchases && window.purchases.length > 0) {
    const last = window.purchases.at(-1);
    printInvoice(last.id);
  }
}, 1000);


}; // â† â† Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ù…Ù‡Ù… Ù…ÙÙ‚ÙˆØ¯ Ø¹Ù†Ø¯Ùƒ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø§Ù„Ø© savePurchase

/* =========================
   â³ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
========================= */
/* =========================
   â° ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªÙ‚ÙˆÙŠÙ… (Ù…Ù† ÙˆØ¥Ù„Ù‰)
========================= */
window.filterPurchases = function () {
  const fromInput = document.getElementById("fromDate").value;
  const toInput = document.getElementById("toDate").value;
  const quick = document.getElementById("timeFilter").value;

  let startDate = fromInput ? new Date(fromInput) : null;
  let endDate = toInput ? new Date(toInput) : null;

  const now = new Date();

  // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± ÙÙ„ØªØ±Ø© Ø³Ø±ÙŠØ¹Ø© (Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹...)
  if (quick) {
    const today = new Date();
    if (quick === "today") {
      startDate = new Date(today.setHours(0, 0, 0, 0));
      endDate = new Date();
    } else if (quick === "week") {
      const first = new Date();
      first.setDate(today.getDate() - 7);
      startDate = first;
      endDate = new Date();
    } else if (quick === "month") {
      startDate = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0);
      endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
    } else if (quick === "lastMonth") {
      startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1, 0, 0, 0);
      endDate = new Date(today.getFullYear(), today.getMonth(), 0, 23, 59, 59);
    }
  }

  // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± ÙÙ‚Ø· Ù…Ù†/Ø¥Ù„Ù‰ Ù…Ù† Ø§Ù„ØªÙ‚ÙˆÙŠÙ… (Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø© Ø³Ø±ÙŠØ¹Ø©)
  if (!quick && (fromInput || toInput)) {
    if (!startDate) startDate = new Date("2000-01-01"); // Ø¨Ø¯Ø§ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    if (!endDate) endDate = new Date(); // Ù†Ù‡Ø§ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„ÙŠÙˆÙ…
    endDate.setHours(23, 59, 59, 999);
  }

  // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø¹Ø¯ØŒ Ù†ÙˆÙ‚Ù
  if (!window.purchases || window.purchases.length === 0) return;

  // âœ… ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±
  const filtered = window.purchases.filter(p => {
    const d = new Date(p.date);
    if (startDate && d < startDate) return false;
    if (endDate && d > endDate) return false;
    return true;
  });

  renderFilteredPurchases(filtered);
};

// âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
function renderFilteredPurchases(list) {
  const table = document.getElementById("purchaseTable");
  table.innerHTML = "";

  if (!list.length) {
    table.innerHTML = `<tr><td colspan="10">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>`;
    return;
  }

  list.forEach((p, i) => {
    const first = p.items?.[0] || {};
    const dateStr = new Date(p.date).toLocaleString("en-GB"); // ÙŠØ¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ù…Ø¹Ù‹Ø§
    table.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${dateStr}</td>
        <td>${first.product || "-"}</td>
        <td>${first.variant || "-"}</td>
        <td>${p.totalQty}</td>
        <td>${first.price || "-"}</td>
        <td>${p.totalAmount.toLocaleString("en-US")}</td>
        <td>${p.supplierName}</td>
        <td>${p.buyer}</td>
        <td><button onclick="printInvoice('${p.id}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></td>
      </tr>`;
  });

  updateStats(list);
}



/* =========================
   ğŸ§¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
========================= */
function loadPurchases() {
  const refP = ref(db, "purchases");
  onValue(refP, (snap) => {
    purchaseTable.innerHTML = "";
    purchases = [];
    if (!snap.exists()) return;
    const data = snap.val();

    Object.keys(data).forEach((id, i) => {
      const p = data[id];
      purchases.push({ id, ...p });
      const dateStr = new Date(p.date).toLocaleDateString("en-GB");
      const first = p.items?.[0] || {};
      purchaseTable.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${dateStr}</td>
          <td>${first.product || "-"}</td>
          <td>${first.variant || "-"}</td>
          <td>${p.totalQty}</td>
          <td>${first.price || "-"}</td>
          <td>${p.totalAmount.toLocaleString("en-US")}</td>
          <td>${p.supplierName}</td>
          <td>${p.buyer}</td>
          <td><button onclick="printInvoice('${id}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></td>
        </tr>`;
    });


    updateStats(purchases);
    window.purchases = purchases; // âœ… Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ ÙÙ‚Ø·
  });
}

/* =========================
   ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
========================= */
function updateStats(list) {
  document.getElementById("totalInvoices").textContent = list.length;
  document.getElementById("totalQty").textContent = list.reduce((a, b) => a + b.totalQty, 0);
  document.getElementById("totalAmount").textContent = list
    .reduce((a, b) => a + b.totalAmount, 0)
    .toLocaleString("en-US");
  document.getElementById("lastPurchase").textContent = list.length
    ? new Date(list.at(-1).date).toLocaleDateString("en-GB")
    : "-";
}

// âœ… Ø¯Ø§Ù„Ø© ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª Ø²Ø§ÙŠØ¯Ø©
function fixArabicText(text) {
  if (!text) return "";
  // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
  return text
    .replace(/\s+/g, " ") // ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    .trim()
    .split(/([\u0600-\u06FF]+)/)
    .map(part => {
      if (/[\u0600-\u06FF]+/.test(part)) {
        // Ù†Ù‚Ù„Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù‚Ù„Ø¨ Ø§Ù„Ø­Ø±ÙˆÙ)
        return part.split(" ").reverse().join(" ");
      }
      return part;
    })
    .reverse()
    .join(" ")
    .replace(/\s+/g, " "); // ÙŠØ¶Ù…Ù† ØªØ±ØªÙŠØ¨ Ù…ØªØ³Ø§ÙˆÙŠ Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª
}




window.printInvoice = async function (id) {
  const p = purchases.find((x) => x.id === id);
  if (!p) return alert("âš ï¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ù† Realtime Database
const supplierRef = ref(db, `suppliers/${p.supplierId}`);
const supplierSnap = await get(supplierRef);
let supplierData = supplierSnap.exists() ? supplierSnap.val() : {};

p.supplierName = supplierData.name || p.supplierName || "-";
p.supplierPhone = supplierData.phone || "-";
p.supplierAddress = supplierData.address || "-";

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø®Ø· Tajawal Ù…Ø­Ù„ÙŠÙ‹Ø§
  const res = await fetch("Tajawal-Regular.ttf");
  const buffer = await res.arrayBuffer();
  const binary = Array.from(new Uint8Array(buffer))
    .map(b => String.fromCharCode(b))
    .join("");
  const base64 = btoa(binary);
  pdfMake.vfs = { "Tajawal-Regular.ttf": base64 };
  pdfMake.fonts = {
    Tajawal: {
      normal: "Tajawal-Regular.ttf",
      bold: "Tajawal-Regular.ttf",
      italics: "Tajawal-Regular.ttf",
      bolditalics: "Tajawal-Regular.ttf"
    }
  };

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¯
  const logoBase64 = await fetch("almurad-logo.png")
    .then(r => r.blob())
    .then(blob => new Promise(res => {
      const reader = new FileReader();
      reader.onloadend = () => res(reader.result);
      reader.readAsDataURL(blob);
    }));
// âœ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
// âœ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
const content = [
  // ğŸ”¹ Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¨Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡
  {
    columns: [
{ image: logoBase64, width: 80, alignment: "left", margin: [0, -10, 0, 0] },
      { 
        text: fixArabicText("Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©"),
        fontSize: 22,
        bold: true,
        color: "#FF6B2D",
        alignment: "right",
        margin: [0, 15, 0, 0],
      },
    ],
    margin: [0, 0, 0, 10],
  },

  // ğŸ”¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  {
    text: fixArabicText("ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª"),
    alignment: "center",
    fontSize: 16,
    color: "#FF6B2D",
    bold: true,
    margin: [0, 5, 0, 20],
  },

  // ğŸ”¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹
// ğŸ”¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹ (ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©)
// ğŸ”¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹ â€” Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ©ØŒ Ù…Ø¹ Ù…Ø­Ø§Ø°Ø§Ø© Ù‚ØµÙˆÙ‰ ÙŠÙ…ÙŠÙ† ÙˆÙŠØ³Ø§Ø±
// ğŸ”¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹ (ØªØµÙ…ÙŠÙ… Ù…ØªÙˆØ§Ø²Ù† ÙŠÙ…ÙŠÙ† ÙˆÙŠØ³Ø§Ø±)
{
  columns: [
    // ğŸ§¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ (ÙŠÙ…ÙŠÙ†)
    {
      width: '45%',
      stack: [
        { text: fixArabicText('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ'), fontSize: 12, bold: true, color: '#FF6B2D', alignment: 'right', margin: [0, 0, 0, 4] },
        { text: fixArabicText(`Ø§Ù„Ø§Ø³Ù…: ${p.buyer || '-'}`), fontSize: 11, color: '#043B64', alignment: 'right', margin: [0, 3, 0, 0] },
        {
          text: fixArabicText('ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:'),
          fontSize: 11,
          color: '#043B64',
          alignment: 'right',
          margin: [0, 3, 0, 0],
        },
        {
          text: `${new Date(p.date).toLocaleDateString('en-GB')}   ${new Date(p.date)
            .toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`,
          fontSize: 11,
          color: '#FF6B2D',
          alignment: 'right',
          margin: [0, 2, 0, 0],
        },
      ],
      alignment: 'right',
margin: [0, 0, 128, 0],
    },

// ğŸ¢ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ (ÙŠÙ…ÙŠÙ† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±)
 {
      width: '45%',
      stack: [
        { text: fixArabicText('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹'), fontSize: 12, bold: true, color: '#FF6B2D', alignment: 'right', margin: [0, 0, 0, 4] },
        { text: fixArabicText(`Ø§Ù„Ø§Ø³Ù…: ${p.supplierName || '-'}`), fontSize: 11, color: '#043B64', alignment: 'right' },
        { text: fixArabicText('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:'), fontSize: 11, color: '#043B64', alignment: 'right' },
        { text: `${p.supplierPhone || '-'}`, fontSize: 11, color: '#FF6B2D', alignment: 'right' },
        { text: fixArabicText(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${p.supplierAddress || '-'}`), fontSize: 11, color: '#043B64', alignment: 'right' },
      ],
      alignment: 'right',
      margin: [0, 0, -40, 0], // âœ… Ø³Ø­Ø¨ Ø§Ù„Ù†Øµ Ø£ÙƒØ«Ø± Ù†Ø­Ùˆ Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø³Ø§Ù„Ø¨ ÙŠØ¹Ù†ÙŠ ÙŠØªØ¬Ø§ÙˆØ² Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø§Ù„Ù‡Ø§Ù…Ø´)
    },


  ],
  margin: [0, 0, 0, 15],
},
// âœ… Ø£ØºÙ„Ù‚ Ø§Ù„Ù‚ÙˆØ³ Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ ÙŠØ­ØµÙ„ Ø®Ø·Ø£ Ù†Ø­ÙˆÙŠ





  // ğŸ”¹ ÙØ§ØµÙ„ Ø£Ù†ÙŠÙ‚ Ø±Ù…Ø§Ø¯ÙŠ
  { canvas: [{ type: "line", x1: 0, y1: 0, x2: 520, y2: 0, lineWidth: 1, lineColor: "#ccc" }], margin: [0, 10, 0, 10] },

  // ğŸ”¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø®Ø· Ù…Ù†Ø³Ù‚ ÙˆÙ…Ø­Ø§Ø°Ø§Ø© ÙˆØ³Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©
 {
  table: {
    headerRows: 1,
    widths: ["auto", "auto", "auto", "*", "*", "auto"],
    body: [
      [
        { text: fixArabicText("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"), style: "tableHeader", alignment: "center" },
        { text: fixArabicText("Ø§Ù„Ø³Ø¹Ø±"), style: "tableHeader", alignment: "center" },
        { text: fixArabicText("Ø§Ù„ÙƒÙ…ÙŠØ©"), style: "tableHeader", alignment: "center" },
        { text: fixArabicText("Ø§Ù„Ù…ØªØºÙŠØ±"), style: "tableHeader", alignment: "center" },
        { text: fixArabicText("Ø§Ù„Ù…Ù†ØªØ¬"), style: "tableHeader", alignment: "center" },
        { text: "#", style: "tableHeader", alignment: "center" },
      ],
      ...p.items.map((it, j) => [
        { text: it.subtotal.toLocaleString("en-US"), alignment: "center", direction: "ltr" },
        { text: it.price.toLocaleString("en-US"), alignment: "center", direction: "ltr" },
        { text: it.quantity.toLocaleString("en-US"), alignment: "center", direction: "ltr" },
        { text: fixArabicText(it.variant), alignment: "center" }, // âœ… Ù†Ø³ØªØ®Ø¯Ù… fixArabicText Ù‡Ù†Ø§
        { text: fixArabicText(it.product), alignment: "center" }, // âœ… ÙˆÙ‡Ù†Ø§ Ø£ÙŠØ¶Ù‹Ø§
        { text: j + 1, alignment: "center", direction: "ltr" },
      ]),
    ],
  },
  layout: {
  fillColor: (rowIndex) => (rowIndex === 0 ? "#043B64" : null),
  hLineColor: "#ddd",
  vLineColor: "#ddd",
  paddingTop: () => 6,
  paddingBottom: () => 6,
  textColor: (rowIndex) => (rowIndex === 0 ? "#FF6B2D" : "#000"),
},

},


  // ğŸ”¹ ÙØ§ØµÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  { canvas: [{ type: "line", x1: 0, y1: 0, x2: 520, y2: 0, lineWidth: 1, lineColor: "#ccc" }], margin: [0, 15, 0, 5] },

  // ğŸ”¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙŠØ³Ø§Ø± Ø§Ù„ØµÙØ­Ø©
  {
    text: fixArabicText(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${p.totalAmount.toLocaleString("en-US")} Ø¯.Ø¹`),
    alignment: "left",
    color: "#FF6B2D",
    bold: true,
    fontSize: 13,
    margin: [0, 5, 0, 15],
  },

  // ğŸ”¹ ØªØ°ÙŠÙŠÙ„ Ø±Ø³Ù…ÙŠ Ø¨Ø³ÙŠØ·
  {
    text: fixArabicText("ğŸ”¹ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ø³Ù…ÙŠØ© ØµØ§Ø¯Ø±Ø© Ù…Ù† Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ø¯ ğŸ”¹"),
    alignment: "center",
    italics: true,
    color: "#777",
    fontSize: 9,
    margin: [0, 10, 0, 0],
  },
];



 

  const docDefinition = {
    pageSize: "A4",
    pageMargins: [40, 50, 40, 50],
    pageDirection: "rtl",
    defaultStyle: {
      font: "Tajawal",
      alignment: "right",
      direction: "rtl",
    },
    styles: {
      sectionTitle: {
        bold: true,
        color: "#043B64",
        fontSize: 13,
        margin: [0, 0, 0, 4],
      },
      tableHeader: {
        bold: true,
        color: "white",
        alignment: "center",
        fillColor: "#043B64",
      },
    },
    info: { title: "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ø¯" },

    // âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¶Ù…Ù† Ø£Ù† ÙƒÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØªÙƒÙˆÙ† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±)
    content: content.map((item) => ({
      ...item,
      alignment: item.alignment || "right",
      direction: "rtl",
    })),
  };

  pdfMake.createPdf(docDefinition).open();
};




window.downloadFullExcel = async () => {
  const XLSX = await import("https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs");
  const rows = [];
  purchases.forEach((p) => {
    p.items.forEach((it) => {
      rows.push({
        Supplier: p.supplierName,
        Buyer: p.buyer,
        Product: it.product,
        Variant: it.variant,
        Quantity: it.quantity,
        Price: it.price,
        Subtotal: it.subtotal,
        TotalInvoice: p.totalAmount,
      });
    });
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Purchases");
  XLSX.writeFile(wb, "ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª.xlsx");
};
loadSuppliers();
loadProducts();
loadPurchases();
window.purchases = purchases;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
// âœ… ØªØ­Ù…ÙŠÙ„ Ø®Ø· Tajawal Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
fetch("Tajawal-Regular.ttf")
  .then(res => res.arrayBuffer())
  .then(buffer => {
    const binary = Array.from(new Uint8Array(buffer))
      .map(b => String.fromCharCode(b))
      .join("");
    const base64 = btoa(binary);

    pdfMake.vfs = { "Tajawal-Regular.ttf": base64 };
    pdfMake.fonts = {
      Tajawal: {
        normal: "Tajawal-Regular.ttf",
        bold: "Tajawal-Regular.ttf",
        italics: "Tajawal-Regular.ttf",
        bolditalics: "Tajawal-Regular.ttf"
      }
    };
  });
  
</script>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</title>

<style>
    .product{position:relative}
.searchInput{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
.dropdown{
  position:absolute;
  top:100%;
  right:0;
  left:0;
  background:white;
  border:1px solid #ccc;
  max-height:160px;
  overflow-y:auto;
  display:none;
  z-index:50;
}
.dropdown div{
  padding:7px;
  cursor:pointer;
}
.dropdown div:hover{
  background:#eee;
}

:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
  --gray:#eee;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Tajawal, Tahoma, sans-serif;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:16px;
  text-align:center;
  font-size:18px;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:12px;
}
.info{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  font-size:14px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:white;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{
  background:#eef3f7;
}
td.product{width:45%}
td.qty{width:10%}

select,input{
  width:100%;
  padding:7px;
  border-radius:6px;
  border:1px solid #ccc;
}

.totalBox{
  margin-top:12px;
  background:white;
  padding:14px;
  border-radius:12px;
}
.grand{
  color:var(--orange);
  font-size:22px;
  font-weight:bold;
}

.payButtons{
  display:flex;
  gap:10px;
  margin:12px 0;
}
.payBtn{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:2px solid var(--blue);
  background:white;
  color:var(--blue);
  font-size:16px;
  cursor:pointer;
}
.payBtn.active{
  background:var(--blue);
  color:white;
}

#creditBox{
  display:none;
  margin-top:10px;
  background:#fdfdfd;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
}
.creditGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.creditGrid label{
  font-size:13px;
  color:#555;
}

button.save{
  width:100%;
  margin-top:15px;
  padding:14px;
  font-size:17px;
  background:var(--orange);
  color:white;
  border:none;
  border-radius:14px;
}
@media(max-width:700px){
  .creditGrid{grid-template-columns:1fr}
  th,td{font-size:12px}
}
input,
select,
textarea {
  font-size: 16px !important;
  -webkit-text-size-adjust: 100%;
}
html, body {
  touch-action: manipulation;
}
#bottomBar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#043B64;
  display:flex;
  gap:6px;
  padding:6px;
  z-index:999;
}
#bottomBar button{
  flex:1;
  font-size:13px;
  padding:8px;
  border:none;
  border-radius:8px;
  color:white;
  background:#2c3e50;
}
#bottomBar button:nth-child(2){
  background:#c0392b;
}
.return-mode input,
.return-mode select {
  background: #ffe6e6 !important;
  border-color: #c0392b !important;
}

.return-mode table {
  border: 2px solid #c0392b;
}
/* ğŸ§Š Action Boxes */
.action-boxes{
  position:fixed;
  bottom:16px;
  left:16px;                 /* â¬…ï¸ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± */
  display:flex;              /* âœ… ØµÙ ÙˆØ§Ø­Ø¯ */
  gap:8px;
  z-index:1000;
}



.action-box{
  width:64px;          /* âœ… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠØ§Ø³ Ù„Ù„Ø¬Ù…ÙŠØ¹ */
  height:64px;         /* âœ… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠØ§Ø³ Ù„Ù„Ø¬Ù…ÙŠØ¹ */
  background:white;
  border-radius:14px;
  padding:6px;
  text-align:center;
  cursor:pointer;
  font-size:12px;
  font-weight:bold;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
}


.action-box:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 14px rgba(0,0,0,0.12);
}

.action-box span{
  font-size:12px;
}

/* Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
.action-box.cash{
  border:2px solid #27ae60;
  color:#27ae60;
}

.action-box.return{
  border:2px solid #c0392b;
  color:#c0392b;
}

.action-box.freeze{
  border:2px solid #f1c40f;
  color:#b7950b;
  background:#fff9db;
}

.action-box.resume{
  border:2px solid #2980b9;
  color:#2980b9;
}

</style>
</head>

<body>

<header style="display:flex;justify-content:space-between;align-items:center;">
  <span>ğŸ§¾ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</span>
<button onclick="stopCameraScan()" style="
  background:#c0392b;
  color:white;
  border:none;
  border-radius:10px;
  padding:8px 12px;
  font-size:14px;
  cursor:pointer;
">
â›” Ø¥ÙŠÙ‚Ø§Ù
</button>

  <button onclick="startCameraScan()" style="
    background:#FF6B2D;
    color:white;
    border:none;
    border-radius:10px;
    padding:8px 12px;
    font-size:14px;
    cursor:pointer;
  ">
    ğŸ“· Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  </button>
  
</header>
<!-- ğŸŸ¦ Barcode Scanner Input (Ù…Ø®ÙÙŠ) -->
<input
  id="barcodeInput"
  type="text"
  style="position:absolute;opacity:0;pointer-events:none;"
  autocomplete="off"
/>



<div class="container">
  <video
  id="cameraScanner"
  style="
    display:none;
    width:100%;
    max-width:400px;
    margin:10px auto;
    border-radius:12px;
    border:2px solid #043B64;
  "
></video>

  <div id="parkedModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  z-index:999;
">
  <div style="
    background:white;
    max-width:400px;
    margin:60px auto;
    padding:15px;
    border-radius:12px;
  ">
    <h3 style="margin-top:0">ğŸ“‹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø©</h3>
    <div id="parkedList"></div>
    <button onclick="closeParkedModal()" style="
      margin-top:10px;
      width:100%;
      padding:10px;
      background:#ccc;
      border:none;
      border-radius:8px;
    ">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>


<div class="info">
  <!-- ğŸ§Š Ø¨ÙˆÙƒØ³Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
<div class="action-boxes">

  <div class="action-box cash" onclick="switchToCash()">
    ğŸ’µ
    <span>ÙƒØ§Ø´</span>
  </div>

  <div class="action-box return" onclick="switchToReturn()">
    â†©
    <span>Ù…Ø³ØªØ±Ø¬Ø¹</span>
  </div>

  <div class="action-box freeze" onclick="parkInvoice()">
    â¸
    <span>ØªØ¬Ù…ÙŠØ¯ ÙØ§ØªÙˆØ±Ø©</span>
  </div>

  <div class="action-box resume" onclick="resumeInvoice()">
    â–¶ï¸
    <span>Ø§Ø³ØªØ¦Ù†Ø§Ù ÙØ§ØªÙˆØ±Ø©</span>
  </div>

</div>

  <div id="resumeBanner" style="
  display:none;
  margin-bottom:10px;
  padding:10px;
  background:#e74c3c;
  color:white;
  border-radius:10px;
  font-size:14px;
  text-align:center;
">
ğŸ” Ù‡Ø°Ù‡ ÙØ§ØªÙˆØ±Ø© Ù…Ø³ØªØ£Ù†ÙØ©
</div>

  <div>ğŸ“… <span id="date"></span></div>
  <div>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© #<span id="invoice"></span></div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ -->
<table id="table">
<tr>
  <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
  <th>Ø§Ù„Ø³Ø¹Ø±</th>
  <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
  <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
  <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
</tr>

</table>
<!-- â• Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ ØµØºÙŠØ± -->
<div style="text-align:center; margin-top:6px;">
  <button onclick="addRow()" style="
    width:36px;
    height:36px;
    border-radius:50%;
    border:none;
    background:#27ae60;
    color:white;
    font-size:22px;
    line-height:0;
    cursor:pointer;
    box-shadow:0 3px 8px rgba(0,0,0,0.15);
  ">
    +
  </button>
</div>

<!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª -->
<div class="totalBox">
  <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: <span id="grand" class="grand">0 Ø¯.Ø¹</span></div>

  <div class="payButtons">
    <button class="payBtn active" onclick="setCash(this)">ğŸ’µ Ù†Ù‚Ø¯</button>
    <button class="payBtn" onclick="setCredit(this)">ğŸ“„ Ø¯ÙŠÙ†</button>
  </div>

  <div>
    Ø§Ù„Ù…Ø¯ÙÙˆØ¹:
    <input type="number" id="paid" disabled>
  </div>

  <div id="restLine" style="margin-top:6px;">
    Ø§Ù„Ø¨Ø§Ù‚ÙŠ (Ø¯ÙŠÙ†): <strong id="rest">0 Ø¯.Ø¹</strong>
  </div>

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ† -->
  <div id="creditBox">
    <div class="creditGrid">
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†</label>
        <input id="debtorName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
      </div>
      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="debtorPhone" placeholder="07xxxxxxxx">
      </div>
      <div style="grid-column:1/-1">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input id="debtorNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
      </div>
    </div>
  </div>
</div>

<button class="save" onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>

</div>
<script src="https://unpkg.com/@zxing/library@latest">
  
</script>

<script type="module">
  // âœ… USB BARCODE SCANNER (GLOBAL â€“ Ø¨Ø¯ÙˆÙ† ÙÙˆÙƒØ³)
let scanBuffer = "";
let scanTimer = null;

document.addEventListener("keydown", async (e) => {

  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ Ø¯Ø§Ø®Ù„ input Ø¹Ø§Ø¯ÙŠ (Ø¨Ø­Ø«ØŒ ÙƒÙ…ÙŠØ©)ØŒ ØªØ¬Ø§Ù‡Ù„
  if (
    document.activeElement &&
    ["INPUT", "TEXTAREA", "SELECT"].includes(document.activeElement.tagName) &&
document.activeElement.id !== "barcodeInput"

  ) return;

  // Enter = Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
  if (e.key === "Enter") {
    const code = scanBuffer.trim();
    scanBuffer = "";

    if (code.length < 4) return; // Ø­Ù…Ø§ÙŠØ©

    console.log("ğŸ”« USB BARCODE:", code);
    await handleBarcode(code);
    return;
  }

  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
  if (e.key.length === 1) {
    scanBuffer += e.key;

    clearTimeout(scanTimer);
    scanTimer = setTimeout(() => {
      scanBuffer = "";
    }, 300);
  }
});

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getDatabase,
  ref,
  get,
  update,
  push,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";




const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com",
  projectId: "almurad-system",
  storageBucket: "almurad-system.firebasestorage.app",
  messagingSenderId: "911755824405",
  appId: "1:911755824405:web:c5520c00c11e336148ad1c"
};
// ğŸŸ¦ Barcode Scanner Logic
let barcodeBuffer = "";
let lastKeyTime = Date.now(); // âœ… Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
// ğŸŸ¦ GLOBAL POS KEYBOARD (FINAL)
let qtyBuffer = "";
let qtyMode = null;

document.addEventListener("keydown", (e) => {
  // ğŸ›‘ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø§Ø³Ø­ ÙŠÙƒØªØ¨ Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ù„Ø§ Ù†ØªØ¯Ø®Ù„


console.log("KEY:", e.key, "SHIFT:", e.shiftKey);

  // â• (Mac + Windows)
  if (
    (e.key === "=" && e.shiftKey) ||
    e.key === "+" ||
    e.key === "-"
  ) {
    qtyMode = (e.key === "-" ? "-" : "+");
    qtyBuffer = "";
    e.preventDefault();
    return;
  }

  // ğŸ”¢ Ø£Ø±Ù‚Ø§Ù…
  if (qtyMode && /^\d$/.test(e.key)) {
    qtyBuffer += e.key;
    e.preventDefault();
    return;
  }

  // â ØªÙ†ÙÙŠØ°
  if (e.key === "Enter" && qtyMode && qtyBuffer) {
    applyQtyFromKeyboard(qtyMode, Number(qtyBuffer));
    qtyMode = null;
    qtyBuffer = "";
    e.preventDefault();
    return;
  }

});



window.stopCameraScan = function () {
  const video = document.getElementById("cameraScanner");

  if (codeReader) {
    codeReader.reset();
    codeReader = null;
  }

  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }

  video.style.display = "none";
  lastScannedCode = null;

  console.log("ğŸ“· Camera stopped");
};



async function handleBarcode(barcode) {
  console.log("ğŸ” SEARCH BARCODE:", barcode);

  const snap = await get(ref(rtdb, "warehouse"));
  if (!snap.exists()) {
    alert("âŒ Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº");
    return;
  }

  const data = snap.val();

  for (const [productName, p] of Object.entries(data)) {
    if (!p.barcodes) continue;

    for (const [variantKey, code] of Object.entries(p.barcodes)) {
      console.log("â¡ï¸ CHECK:", productName, variantKey, code);

 if (String(code).trim() === String(barcode).trim()) {

        console.log("âœ… FOUND BARCODE:", productName);
        await addProductByBarcode(
          productName,
          variantKey,
          p.prices?.pos || 0
        );
        return;
      }
    }
  }

  alert("âŒ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
}
function getReusableRow() {
  for (let i = 1; i < table.rows.length; i++) {
    const r = table.rows[i];
    const nameInput = r.cells[0].querySelector("input");

    if (!nameInput.value.trim()) {
      return r; // ØµÙ ÙØ§Ø¶ÙŠ Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
    }
  }
  return null;
}


async function addProductByBarcode(productName, variantKey, price) {

  // 1ï¸âƒ£ Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ â†’ Ø²ÙŠØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©
  for (let i = 1; i < table.rows.length; i++) {
    const r = table.rows[i];
    const nameInput = r.cells[0].querySelector("input");
    const variantSelect = r.querySelector(".variantSelect");

    if (
      nameInput.value === productName &&
      variantSelect.value === variantKey
    ) {
    const qtyInput = r.cells[3].querySelector("input");

      qtyInput.value = Number(qtyInput.value) + 1;
      multiplyRow(qtyInput);
      return;
    }
  }

 const stockSnap = await get(
  ref(rtdb, "warehouse/" + productName + "/stock")
);

if (!stockSnap.exists()) {
  alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ†");
  return;
}

const stock = stockSnap.val();
const realKey = Object.keys(stock).find(
  k => k.trim() === variantKey.trim()
);

const qty = realKey ? stock[realKey] : 0;

if (qty <= 0) {
  alert("âŒ Ø§Ù„ÙƒÙ…ÙŠØ© ØµÙØ±");
  return;
}
// 3ï¸âƒ£ Ø§Ø³ØªØ®Ø¯Ù… ØµÙ ÙØ§Ø¶ÙŠ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
let row = getReusableRow();

if (!row) {
  addRow();
  row = table.rows[table.rows.length - 1];
}

  row.cells[0].querySelector("input").value = productName;
  row.dataset.unitPrice = price;
  row.cells[1].textContent = f(price);

  await loadVariants(row, productName);
  row.querySelector(".variantSelect").value = variantKey;

multiplyRow(row.cells[3].querySelector("input"));

}




const app = initializeApp(firebaseConfig);
const rtdb = getDatabase(app);
const table = document.getElementById("table");





  
    document.addEventListener("click", e=>{
  document.querySelectorAll(".dropdown").forEach(d=>{
    if(!d.contains(e.target) && !d.previousElementSibling.contains(e.target)){
      d.style.display="none";
    }
  });
});
function showAllProducts(input){
  const box = input.nextElementSibling;
  box.innerHTML = "";

  products.forEach(p=>{
    const d = document.createElement("div");
    d.textContent = p.name;
    d.onclick = ()=>{
      input.value = p.name;
      box.style.display = "none";
      const row = input.closest("tr");
row.dataset.unitPrice = p.price;

loadVariants(row, p.name);
setTimeout(() => {
  const select = row.querySelector(".variantSelect");
  const stockSpan = row.querySelector(".stockQty");


  if (select.value && row._stock) {
    stockSpan.textContent = row._stock[select.value] ?? 0;
  }
}, 0);

row.cells[1].textContent = f(p.price);

calc();

    };
    box.appendChild(d);
  });

  box.style.display = "block";
}

    function filterProducts(input){
  const box=input.nextElementSibling;
  box.innerHTML="";
  const val=input.value.trim();
  if(!val){box.style.display="none";return;}

  products
.filter(p=>p.name.toLowerCase().includes(val.toLowerCase()))
    .forEach(p=>{
      const d=document.createElement("div");
      d.textContent=p.name;
      d.onclick=()=>{
        input.value=p.name;
        box.style.display="none";
        const row=input.closest("tr");
row.dataset.unitPrice = p.price;
loadVariants(row, p.name);   // â­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù†Ø§Ù‚Øµ
row.cells[1].textContent = f(p.price);
calc();


      };
      box.appendChild(d);
    });

  box.style.display="block";
}

// Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±
const f=n=>Number(n||0).toLocaleString("en-US")+" Ø¯.Ø¹";
const p=v=>Number(String(v).replace(/[^0-9]/g,""))||0;


let products = [];

async function loadProducts(){
  products = [];

  const snap = await get(ref(rtdb, "warehouse"));
  if(!snap.exists()) return;

  const data = snap.val();

  for(const [name, p] of Object.entries(data)){
    products.push({
      name,
price: p.prices?.pos || 0,
      totalQty: p.totalQty || 0
    });
  }

  console.log("âœ… products loaded:", products);
}
async function loadVariants(row, productName){
  const select = row.querySelector(".variantSelect");
  select.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>`;

  const snap = await get(ref(rtdb, "warehouse/" + productName));
  if(!snap.exists()) return;

const stock = snap.val().stock || {};
const totalStock = Object.values(stock).reduce(
  
  (a, b) => a + Number(b || 0),
  
  0
);
row._totalStock = totalStock; // â­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù† Ù†Ø§Ù‚Øµ

row._stock = { ...stock }; // Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø®Ø²Ù†
const stockSpan = row.querySelector(".stockQty");
stockSpan.textContent = totalStock; // âœ… Ø§ÙƒØªØ¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²Ù† ÙÙˆØ± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬

select.onchange = () => {
  const k = select.value;

  if (!k) {
    stockSpan.textContent = row._totalStock;
  } else {
    stockSpan.textContent = stock[k] ?? 0;
  }
};



  // â­â­â­ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø· â­â­â­
if (
  Object.keys(stock).length === 1 &&
  stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined
) {
  select.innerHTML =
    `<option value="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</option>`;

  // âœ… Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø®Ø²Ù† ÙÙˆØ±Ù‹Ø§
  stockSpan.textContent = stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] ?? 0;

  return;
}


  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù„ÙˆÙ† / Ù‚ÙŠØ§Ø³ / ...)
  for(const key in stock){
    if(stock[key] > 0){
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = `${key} (${stock[key]})`;
      select.appendChild(opt);
      opt.dataset.qty = stock[key];

    }
  }
}





// âœ… Ø´ØºÙ‘Ù„ Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØµØ§Ø± Ù…ÙˆØ¬ÙˆØ¯
await loadProducts();
addRow();
const grandEl=document.getElementById("grand");
const paidEl=document.getElementById("paid");
const restEl=document.getElementById("rest");
const restLine=document.getElementById("restLine");

document.getElementById("date").textContent=new Date().toLocaleDateString("ar-EG");
let invoice = Number(localStorage.getItem("invoiceNo")) || 1;
document.getElementById("invoice").textContent = invoice;


let isCredit=false;
let isReturnMode = false;
function switchToReturn(){
  isReturnMode = true;
  document.body.classList.add("return-mode");
  document.querySelector("header").style.background = "#c0392b";
  calc();
}

function addRow(){
  const r = table.insertRow();
  r.dataset.unitPrice = 0;

r.innerHTML = `
<td class="product">
  <input 
    class="searchInput"
    placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"
    onfocus="showAllProducts(this)"
    oninput="filterProducts(this)"
  >
  <div class="dropdown"></div>

  <select class="variantSelect">
    <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>
  </select>
</td>

<td>0 Ø¯.Ø¹</td>

<td class="stock">
  <span class="stockQty">0</span>
</td>

<td class="qty">
<input 
  type="text"
  value="1"
  class="qtyInput"
  style="width:60px;font-size:14px;padding:4px;text-align:center"
  onkeydown="handleQtyKey(event, this)"
  onblur="normalizeQty(this)"
>

</td>

<td>0 Ø¯.Ø¹</td>

<td>
  <button onclick="removeRow(this)" style="
    background:#c0392b;
    color:white;
    border:none;
    border-radius:6px;
    padding:6px 10px;
    cursor:pointer;
  ">âœ–</button>
</td>
`;


}

function removeRow(btn){
  const row = btn.closest("tr");
  if(table.rows.length <= 2){
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±");
    return;
  }
  row.remove();
  calc();
}


function multiplyRow(qtyInput){
  const row = qtyInput.closest("tr");

  const price = Number(row.dataset.unitPrice || 0);
const qty = Number(qtyInput.value || 0);


  const sum = price * qty;


row.cells[4].textContent = f(sum);


  calc(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
}

function calc(){
  let total = 0;

  for(let i = 1; i < table.rows.length; i++){
    const r = table.rows[i];

    const unitPrice = Number(r.dataset.unitPrice || 0); // â­ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ


const qty = Number(r.cells[3].children[0].value || 0);
const sign = isReturnMode ? -1 : 1;
const sum = sign * unitPrice * qty;

r.cells[4].textContent = f(sum);



    total += sum;
  }

  grandEl.textContent = f(total);

  if(!isCredit){
    paidEl.value = total;
    restEl.textContent = f(0);
  }else{
    restEl.textContent = f(total - Number(paidEl.value || 0));
  }
}


paidEl.oninput=calc;

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙØ¹
function setCash(btn){
  isCredit=false;
  paidEl.disabled=true;
  document.getElementById("creditBox").style.display="none";
  restLine.style.display="none";
  document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  calc();
}

function setCredit(btn){
  isCredit=true;
  paidEl.disabled=false;
  paidEl.value=0;
  document.getElementById("creditBox").style.display="block";
  restLine.style.display="block";
  document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  calc();
}
function resetRows(){
  for(let i = 1; i < table.rows.length; i++){
    const r = table.rows[i];

    r.dataset.unitPrice = 0; // â† Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±

    r.cells[0].querySelector("input").value = "";
    r.querySelector(".variantSelect").innerHTML =
  `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>`;

r.cells[1].textContent = "0 Ø¯.Ø¹";
r.cells[3].querySelector("input").value = 1;
r.cells[4].textContent = "0 Ø¯.Ø¹";

// ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
r.querySelector(".stockQty").textContent = "0";
r._stock = {};
r._totalStock = 0;

  }
}
function switchToCash(){
  isReturnMode = false;

  // Ø±Ø¬Ù‘Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹
  document.body.classList.remove("return-mode");
  document.querySelector("header").style.background = "var(--blue)";

  // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ø¯ÙØ¹ ÙƒØ§Ø´
  isCredit = false;
  paidEl.disabled = true;
  document.getElementById("creditBox").style.display = "none";
  restLine.style.display = "none";

  // ÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„ÙƒØ§Ø´ Ø¨ØµØ±ÙŠÙ‹Ø§
  document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
  document.querySelector(".payBtn").classList.add("active");

  calc();
}



// Ø­ÙØ¸
async function saveInvoice(){
  const items=[];
for(let i=1;i<table.rows.length;i++){
    const r=table.rows[i];
    const name=r.cells[0].children[0].value;
    if(name){
      const prod=products.find(x=>x.name===name);
      if(!prod){
  alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: " + name);
  return;
}

const qty = Number(r.cells[3].querySelector("input").value || 0);

      if(qty <= 0){
  alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  return;
}

 const productRef = ref(rtdb, "warehouse/" + name);
const snap = await get(productRef);

if(!snap.exists()){
  alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: " + name);
  return;
}

const data = snap.val();

if(!isReturnMode && data.totalQty < qty){
  alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©: " + name);
  return;
}


// ğŸ”¹ Ù†Ø³Ø® Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
const stock = { ...(data.stock || {}) };

// ğŸ”¹ Ø£Ù†Ù‚Øµ Ù…Ù† Ø£ÙˆÙ„ Ù…ØªØºÙŠØ± Ù…ØªÙˆÙØ±
const variantKey = r.querySelector(".variantSelect").value;

if(!variantKey && !isReturnMode){
  alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„Ù…Ù†ØªØ¬: " + name);
  return;
}


if(!isReturnMode && stock[variantKey] < qty){
  alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ±");
  return;
}


if(isReturnMode){
  stock[variantKey] += qty;
  prod.totalQty += qty;
}else{
  stock[variantKey] -= qty;
  prod.totalQty -= qty;
}



// ğŸ”¹ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©
const newTotalQty = Object.values(stock).reduce((a, b) => a + b, 0);

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« Firebase
await update(productRef, {
  stock,
  totalQty: newTotalQty,
  lastUpdate: serverTimestamp()
});




items.push({
  product: name,
  qty: isReturnMode ? -qty : qty,
  price: prod.price,
  total: isReturnMode ? -prod.price * qty : prod.price * qty
});




    }
  }
  if(!items.length){alert("Ù…Ø§ÙƒÙˆ Ù…ÙˆØ§Ø¯");return;}

  let debtor=null;
  if(isCredit){
    if(!debtorName.value.trim()){alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙˆÙ† Ù…Ø·Ù„ÙˆØ¨");return;}
    debtor={name:debtorName.value,phone:debtorPhone.value,note:debtorNote.value};
  }

  localStorage.setItem("products", JSON.stringify(products));

try {
await push(ref(rtdb, "posInvoices"), {
  invoiceNo: invoice,
  items,
  total: p(grandEl.textContent),
  paid: Number(paidEl.value || 0),
type: isReturnMode ? "return" : (isCredit ? "credit" : "cash"),

cashierId: "pos",
createdAt: serverTimestamp()
});


  console.log("âœ… Invoice saved successfully");
// ğŸ”„ Ø±Ø¬Ù‘Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹
if(isReturnMode){
  switchToCash();
}
// âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø¹Ø§Ø± ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¯ÙˆÙ† ØªØ¯Ø®Ù„
const saveToast = document.getElementById("saveToast");
saveToast.style.display = "block";

setTimeout(() => {
  saveToast.style.display = "none";
}, 1500);

} catch (err) {
  console.error("âŒ FAILED TO SAVE INVOICE", err);
  alert("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸ â€” Ø§ÙØªØ­ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„");
  return;
}


  
// Ø®Ø²Ù‘Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
// Ø®Ø²Ù‘Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
localStorage.setItem("invoiceNo", invoice + 1);

// Ø­Ø¯Ù‘Ø« Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©
invoice++;

// Ø­Ø¯Ù‘Ø« Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙˆØ±Ù‹Ø§
requestAnimationFrame(() => {
  document.getElementById("invoice").textContent = invoice;
});

// Ø±Ø¬Ù‘Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ù†Ù‚Ø¯
isCredit = false;
paidEl.disabled = true;
paidEl.value = 0;
document.getElementById("creditBox").style.display = "none";
restLine.style.display = "none";

document.querySelectorAll(".payBtn").forEach(b => b.classList.remove("active"));
document.querySelector(".payBtn").classList.add("active");
// ğŸ§¹ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ ÙˆØªØ±Ùƒ ØµÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
while (table.rows.length > 2) {
  table.deleteRow(1);
}

// ØµÙÙ‘Ø± Ø§Ù„ØµÙÙˆÙ Ø¨Ø¯ÙˆÙ† Ø­Ø°ÙÙ‡Ø§
resetRows();

// ØµÙÙ‘Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
grandEl.textContent = f(0);
restEl.textContent = f(0);

}
function parkInvoice(){
  const rows = [];

  for(let i=1;i<table.rows.length;i++){
    const r = table.rows[i];
    const name = r.cells[0].querySelector("input").value;
    if(!name) continue;

    rows.push({
      name,
      variant: r.querySelector(".variantSelect").value,
qty: Number(r.cells[3].querySelector("input").value),

      price: Number(r.dataset.unitPrice)
    });
  }

  if(!rows.length){
    alert("Ù…Ø§ÙƒÙˆ Ù…ÙˆØ§Ø¯ Ø­ØªÙ‰ ØªØªØ¹Ù„Ù‘Ù‚");
    return;
  }

  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  const key = "P" + Date.now();
const total = p(grandEl.textContent);

parked[key] = {
  rows,
  total,
  count: rows.length,
  time: new Date().toISOString()
};

  localStorage.setItem("parkedInvoices", JSON.stringify(parked));

  // ğŸ§¹ ØªØµÙÙŠØ± ÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ (POS RESET)

// 1ï¸âƒ£ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù‡ÙŠØ¯Ø±
while (table.rows.length > 1) {
  table.deleteRow(1);
}

// 2ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© ØµÙ ÙˆØ§Ø­Ø¯ Ù†Ø¸ÙŠÙ
addRow();

// 3ï¸âƒ£ ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
grandEl.textContent = f(0);
paidEl.value = 0;
restEl.textContent = f(0);

// 4ï¸âƒ£ Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù‘Ù„
if (isReturnMode) {
  switchToCash();
}


 
}
function resumeInvoice(){
  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  const keys = Object.keys(parked);

  if(!keys.length){
    alert("Ù…Ø§ÙƒÙˆ ÙÙˆØ§ØªÙŠØ± Ù…Ø¹Ù„Ù‚Ø©");
    return;
  }

  const list = document.getElementById("parkedList");
  list.innerHTML = "";

keys.forEach(key => {
  const inv = parked[key];
  const t = new Date(inv.time);
  const timeStr = t.toLocaleTimeString("ar-EG", {
    hour: "2-digit",
    minute: "2-digit"
  });

  const box = document.createElement("div");
  box.style.cssText = `
    display:flex;
    gap:6px;
    margin-bottom:6px;
  `;

  const btn = document.createElement("button");
  btn.textContent =
    `ğŸ§¾ ${inv.count} Ù…ÙˆØ§Ø¯ | ğŸ’° ${f(inv.total)} | â° ${timeStr}`;
  btn.style.cssText = `
    flex:1;
    padding:10px;
    border:none;
    border-radius:8px;
    background:#2980b9;
    color:white;
    cursor:pointer;
  `;
  btn.onclick = () => loadParkedInvoice(key);

  const del = document.createElement("button");
  del.textContent = "ğŸ—‘ï¸";
  del.style.cssText = `
    width:48px;
    border:none;
    border-radius:8px;
    background:#c0392b;
    color:white;
    cursor:pointer;
  `;
  del.onclick = () => deleteParkedInvoice(key);

  box.appendChild(btn);
  box.appendChild(del);
  list.appendChild(box);
});

  document.getElementById("parkedModal").style.display = "block";
}
function loadParkedInvoice(key){
  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  const data = parked[key];
  if(!data) return;

  resetRows();

  data.rows.forEach((item, i)=>{
    if(i > 0) addRow();
    const r = table.rows[i+1];

    r.cells[0].querySelector("input").value = item.name;
    r.dataset.unitPrice = item.price;
    r.cells[1].textContent = f(item.price);
r.cells[3].querySelector("input").value = item.qty;


    loadVariants(r, item.name).then(()=>{
      r.querySelector(".variantSelect").value = item.variant;
    });
  });

  delete parked[key];
  localStorage.setItem("parkedInvoices", JSON.stringify(parked));

  document.getElementById("parkedModal").style.display = "none";
  document.getElementById("resumeBanner").style.display = "block";

  calc();
}

function closeParkedModal(){
  document.getElementById("parkedModal").style.display = "none";
}


// ğŸ”— expose functions to HTML (required for type="module")
window.addRow = addRow;
window.switchToCash = switchToCash;
window.switchToReturn = switchToReturn;
window.handleQtyKey = handleQtyKey;
window.normalizeQty = normalizeQty;


window.removeRow = removeRow;
window.showAllProducts = showAllProducts;
window.filterProducts = filterProducts;
window.setCash = setCash;
window.setCredit = setCredit;
window.saveInvoice = saveInvoice;

window.multiplyRow = multiplyRow;
window.parkInvoice = parkInvoice;
window.resumeInvoice = resumeInvoice;
window.loadParkedInvoice = loadParkedInvoice;
window.closeParkedModal = closeParkedModal;
window.onload = () => {
  document.body.focus();
  
};

document.addEventListener("click", () => {
  const active = document.activeElement;

  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ Ø¨Ø­Ø«ØŒ Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„ÙÙˆÙƒØ³
  if (active && active.classList.contains("searchInput")) return;

  document.getElementById("barcodeInput")?.focus();
});
function deleteParkedInvoice(key){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø©ØŸ")) return;

  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  delete parked[key];
  localStorage.setItem("parkedInvoices", JSON.stringify(parked));

  resumeInvoice(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
}

let cameraStream = null;
let codeReader = null;
let lastScannedCode = null;
let lastScanTime = 0;

window.startCameraScan = async function () {
  const video = document.getElementById("cameraScanner");
  video.style.display = "block";

  codeReader = new ZXing.BrowserBarcodeReader();

  try {
    codeReader.decodeFromConstraints(
      {
        video: {
          facingMode: "environment"
        }
      },
      video,
      (result, err) => {
        if (result) {
          const code = result.text;
          const now = Date.now();

          // ğŸ›‘ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
          if (code === lastScannedCode && now - lastScanTime < 1200) return;

          lastScannedCode = code;
          lastScanTime = now;

          console.log("ğŸ“· CAMERA BARCODE:", code);
          handleBarcode(code);
        }
      }
    );
  } catch (err) {
    alert("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
    console.error(err);
  }
};
function handleQtyKey(e, input){
  if (e.key !== "Enter") return;

  e.preventDefault();

  const row = input.closest("tr");

  // ğŸ”‘ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù‚Ø¨Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©)
  let baseQty = Number(input.getAttribute("data-last") || 1);

  const raw = input.value.trim();

  let newQty = baseQty;

  if (raw.startsWith("+")) {
    const n = Number(raw.slice(1));
    if (!isNaN(n)) newQty = baseQty + n;
  }
  else if (raw.startsWith("-")) {
    const n = Number(raw.slice(1));
    if (!isNaN(n)) newQty = baseQty - n;
  }
  else {
    const n = Number(raw);
    if (!isNaN(n)) newQty = n;
  }

  if (newQty < 1) newQty = 1;

  // âœ… Ø«Ø¨Ù‘Øª Ø§Ù„Ù‚ÙŠÙ…Ø©
  input.value = newQty;
  input.setAttribute("data-last", newQty);

  multiplyRow(input);
}
function normalizeQty(input){
  let v = Number(input.value);

  if (isNaN(v) || v < 1) v = 1;

  input.value = v;
  input.setAttribute("data-last", v);

  multiplyRow(input);
}


function applyQtyFromKeyboard(mode, value) {
  let lastRow = null;

  for (let i = table.rows.length - 1; i >= 1; i--) {
    const r = table.rows[i];
    const name = r.cells[0].querySelector("input").value;
    if (name) {
      lastRow = r;
      break;
    }
  }

  if (!lastRow) return;

  const qtyInput = lastRow.cells[3].querySelector("input");
  let current = Number(qtyInput.value || 1);

  if (mode === "+") current += value;
  if (mode === "-") current -= value;
  if (current < 1) current = 1;

  qtyInput.value = current;
  qtyInput.setAttribute("data-last", current);

  multiplyRow(qtyInput);
}
let lastEnterTime = 0;
// ğŸ”¥ GLOBAL DOUBLE ENTER SAVE (FORCED)


window.addEventListener("keydown", (e) => {

  if (e.key !== "Enter") return;

  const now = Date.now();

  if (now - lastEnterTime < 400) {
    console.log("ğŸ’¾ DOUBLE ENTER â†’ SAVE");
    saveInvoice();
    lastEnterTime = 0;
  } else {
    lastEnterTime = now;
  }

}, true); // â¬…ï¸ capture + window


</script>

<!-- ğŸŸ¢ Toast ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="freezeToast" style="
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#27ae60;
  color:white;
  padding:12px 20px;
  border-radius:12px;
  font-size:15px;
  box-shadow:0 6px 14px rgba(0,0,0,0.2);
  display:none;
  z-index:2000;
">

  âœ… ØªÙ… ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
</div>
<div id="saveToast" style="
  position:fixed;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:#2980b9;
  color:white;
  padding:12px 20px;
  border-radius:12px;
  font-size:15px;
  box-shadow:0 6px 14px rgba(0,0,0,0.2);
  display:none;
  z-index:2000;
">
  ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­
</div>
</body>
</html>

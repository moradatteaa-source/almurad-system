<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</title>

<style>
  .sub-item{
  border-style:dashed;
  font-size:12px;
}
    .product{position:relative}
.searchInput{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
.dropdown{
  position:absolute;
  top:100%;
  right:0;
  left:0;
  background:white;
  border:1px solid #ccc;
  max-height:160px;
  overflow-y:auto;
  display:none;
  z-index:50;
}
.dropdown {
  pointer-events: none;
}

.dropdown[style*="display: block"] {
  pointer-events: auto;
}


.dropdown div{
  padding:7px;
  cursor:pointer;
}
.dropdown div:hover{
  background:#eee;
}

:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
  --gray:#eee;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Tajawal, Tahoma, sans-serif;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:16px;
  text-align:center;
  font-size:18px;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:12px;
}
.info{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  font-size:14px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:white;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{
  background:#eef3f7;
}
td.product{width:38%}
td.qty{width:8%}

select,input{
  width:100%;
  padding:7px;
  border-radius:6px;
  border:1px solid #ccc;
}

.totalBox{
  margin-top:10px;

  background:white;
  padding:12px;
  border-radius:12px;
}
.grand{
  color:var(--orange);
  font-size:22px;
  font-weight:bold;
}

.payButtons{
  display:flex;
  gap:10px;
  margin:12px 0;
}
.payBtn{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:2px solid var(--blue);
  background:white;
  color:var(--blue);
  font-size:16px;
  cursor:pointer;
}
.payBtn.active{
  background:var(--blue);
  color:white;
}

#creditBox{
  display:none;
  margin-top:10px;
  background:#fdfdfd;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
}
.creditGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.creditGrid label{
  font-size:13px;
  color:#555;
}

button.save{
  width:100%;
  margin-top:10px;
  padding:12px;
  font-size:16px;
  background:var(--orange);
  color:white;
  border:none;
  border-radius:12px;
}
@media(max-width:700px){
  .creditGrid{grid-template-columns:1fr}
  th,td{font-size:12px}
}
input,
select,
textarea {
  font-size: 16px !important;
  -webkit-text-size-adjust: 100%;
}
html, body {
  touch-action: manipulation;
}
#bottomBar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#043B64;
  display:flex;
  gap:6px;
  padding:6px;
  z-index:999;
}
#bottomBar button{
  flex:1;
  font-size:13px;
  padding:8px;
  border:none;
  border-radius:8px;
  color:white;
  background:#2c3e50;
}
#bottomBar button:nth-child(2){
  background:#c0392b;
}
.return-mode input,
.return-mode select {
  background: #ffe6e6 !important;
  border-color: #c0392b !important;
}

.return-mode table {
  border: 2px solid #c0392b;
}
/* ğŸ§Š Action Boxes */
.action-boxes{
  position:fixed;
  bottom:16px;
  left:16px;                 /* â¬…ï¸ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± */
  display:flex;              /* âœ… ØµÙ ÙˆØ§Ø­Ø¯ */
  gap:8px;
  z-index:1000;
}

.variantSelect{
  margin-top:4px;
  width:100%;
  padding:6px;
  font-size:14px;
}


.action-box{
  width:64px;          /* âœ… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠØ§Ø³ Ù„Ù„Ø¬Ù…ÙŠØ¹ */
  height:64px;         /* âœ… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠØ§Ø³ Ù„Ù„Ø¬Ù…ÙŠØ¹ */
  background:white;
  border-radius:14px;
  padding:6px;
  text-align:center;
  cursor:pointer;
  font-size:12px;
  font-weight:bold;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
}


.action-box:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 14px rgba(0,0,0,0.12);
}

.action-box span{
  font-size:12px;
}

/* Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
.action-box.cash{
  border:2px solid #27ae60;
  color:#27ae60;
}

.action-box.return{
  border:2px solid #c0392b;
  color:#c0392b;
}

.action-box.freeze{
  border:2px solid #f1c40f;
  color:#b7950b;
  background:#fff9db;
}

.action-box.resume{
  border:2px solid #2980b9;
  color:#2980b9;
}
.quick-item{
  border:2px solid #043B64;
  border-radius:10px;
  padding:10px 6px;
  text-align:center;
  cursor:pointer;
  font-size:13px;
  background:#f9fbfd;
  transition:0.2s;
}
.quick-item:hover{
  background:#043B64;
  color:white;
}
.quick-item .price{
  font-size:12px;
  color:#FF6B2D;
  font-weight:bold;
}
/* ğŸŸ¦ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
#categoriesBar{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.category-tab{
  background:#eef3f7;
  border:2px solid #043B64;
  border-radius:20px;
  padding:6px 12px;
  font-size:13px;
  cursor:pointer;
}

.category-tab.active{
  background:#043B64;
  color:white;
}

/* â• Ø²Ø± Ø¥Ø¶Ø§ÙØ© */
.category-add{
  background:#27ae60;
  color:white;
  border:none;
  border-radius:20px;
  padding:6px 12px;
  cursor:pointer;
}
.delete-cat{
  margin-right:6px;
  color:#c0392b;
  cursor:pointer;
  font-weight:bold;
}
.delete-prod{
  font-size:14px;
  color:#c0392b;
  cursor:pointer;
}
/* ğŸ”´ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ÙÙˆÙ‚ Ø§Ù„ÙƒØ±Øª */
.quick-item{
position: relative; /* Ù…Ù‡Ù… */
}


.delete-prod{
position: absolute;
top: 4px;
left: 4px; /* Ù„Ø£Ù† RTL */
width: 20px;
height: 20px;
border-radius: 50%;
background: #c0392b;
color: white;
font-size: 12px;
line-height: 20px;
text-align: center;
cursor: pointer;
font-weight: bold;
z-index: 5;
}


.delete-prod:hover{
background: #a93226;
}
#printArea {
  display: none;
}

@media print {
  body * {
    visibility: hidden;
  }

  #printArea,
  #printArea * {
    visibility: visible;
  }

  #printArea {
    display: block !important;   /* âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ */
    position: fixed;
    top: 0;
    right: 0;
 width: 72mm;
max-width: 72mm;

    font-family: Tajawal, Tahoma, sans-serif;
  }
}


@page {
  size: 72mm auto;
  margin: 0;
}




</style>
</head>

<body>

<header style="display:flex;justify-content:space-between;align-items:center;">
  <span>ğŸ§¾ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</span>
  <span style="font-size:13px">
ğŸ‘¤ <script>document.write(localStorage.getItem("cashierUsername") || "")</script>
</span>

<button onclick="stopCameraScan()" style="
  background:#c0392b;
  color:white;
  border:none;
  border-radius:10px;
  padding:8px 12px;
  font-size:14px;
  cursor:pointer;
">
â›” Ø¥ÙŠÙ‚Ø§Ù
</button>

  <button onclick="startCameraScan()" style="
    background:#FF6B2D;
    color:white;
    border:none;
    border-radius:10px;
    padding:8px 12px;
    font-size:14px;
    cursor:pointer;
  ">
    ğŸ“· Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  </button>
  
</header>
<!-- ğŸŸ¦ Barcode Scanner Input (Ù…Ø®ÙÙŠ) -->
<input
  id="barcodeInput"
  type="text"
  style="position:absolute;opacity:0;pointer-events:none;"
  autocomplete="off"
/>



<div class="container">
<div style="
display:flex;
gap:8px;
align-items:flex-start;
">

<!-- ğŸŸ¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
<div
 id="quickProducts"
  style="
width:45%;
max-width:420px;
background:white;
border-radius:14px;
padding:10px;
max-height:75vh;
overflow-y:visible;   /* â­â­â­ Ù…Ù‡Ù… */
box-shadow:0 4px 12px rgba(0,0,0,0.08);
position:relative;    /* â­ */
z-index:1;
">
<div id="categoriesBar"></div>

<div id="addProductBox" style="margin:8px 0;text-align:center;position:relative;">

  <button id="addProductBtn" class="category-add">
    â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ù‚Ø³Ù…
  </button>

<div id="addProductDropdownBox" style="
  position:absolute;
  top:100%;
  left:0;
  right:0;
  margin-top:6px;
  display:none;
  z-index:5000;        /* ğŸ”¥ Ø£Ø¹Ù„Ù‰ */
  background:white;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,0.18);
">
    <input
      id="addProductInput"
      placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."
      style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc"
    >
    <div
      id="addProductDropdown"
      style="
        margin-top:4px;
        border:1px solid #ccc;
        max-height:200px;
        overflow-y:auto;
        display:none;
      "
    ></div>
  </div>

</div>


<h4 style="margin:0 0 10px;text-align:center;color:#043B64">
ğŸ§º Ù…Ù†ØªØ¬Ø§Øª Ø³Ø±ÙŠØ¹Ø©
</h4>
<div id="quickGrid" style="
display:grid;
grid-template-columns:repeat(2,1fr);
gap:8px;
"></div>
</div>


<!-- ğŸŸ¨ Ù‡Ù†Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
<div style="
  flex:1;
  margin-left:-10px;
">  <video
  id="cameraScanner"
  style="
    display:none;
    width:100%;
    max-width:400px;
    margin:10px auto;
    border-radius:12px;
    border:2px solid #043B64;
  "
></video>

  <div id="parkedModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  z-index:999;
">
  <div style="
    background:white;
    max-width:400px;
    margin:60px auto;
    padding:15px;
    border-radius:12px;
  ">
    <h3 style="margin-top:0">ğŸ“‹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø©</h3>
    <div id="parkedList"></div>
    <button onclick="closeParkedModal()" style="
      margin-top:10px;
      width:100%;
      padding:10px;
      background:#ccc;
      border:none;
      border-radius:8px;
    ">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>


<div class="info">
  <!-- ğŸ§Š Ø¨ÙˆÙƒØ³Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
<div class="action-boxes">

  <div class="action-box cash" onclick="switchToCash()">
    ğŸ’µ
    <span>ÙƒØ§Ø´</span>
  </div>

  <div class="action-box return" onclick="switchToReturn()">
    â†©
    <span>Ù…Ø³ØªØ±Ø¬Ø¹</span>
  </div>

  <div class="action-box freeze" onclick="parkInvoice()">
    â¸
    <span>ØªØ¬Ù…ÙŠØ¯ ÙØ§ØªÙˆØ±Ø©</span>
  </div>

  <div class="action-box resume" onclick="resumeInvoice()">
    â–¶ï¸
    <span>Ø§Ø³ØªØ¦Ù†Ø§Ù ÙØ§ØªÙˆØ±Ø©</span>
  </div>

</div>

  <div id="resumeBanner" style="
  display:none;
  margin-bottom:10px;
  padding:10px;
  background:#e74c3c;
  color:white;
  border-radius:10px;
  font-size:14px;
  text-align:center;
">
ğŸ” Ù‡Ø°Ù‡ ÙØ§ØªÙˆØ±Ø© Ù…Ø³ØªØ£Ù†ÙØ©
</div>

  <div>ğŸ“… <span id="date"></span></div>
  <div>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© #<span id="invoice"></span></div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ -->
<!-- ğŸŸ¨ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª -->
<div class="invoice-area">

  <!-- Ø¬Ø¯ÙˆÙ„ -->
  <table id="table">
    <tr>
      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
      <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
      <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
    </tr>
  </table>

  <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ -->
  <div style="text-align:center; margin-top:6px;">
    <button onclick="addRow()">+</button>
  </div>

  <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª -->
  <div class="totalBox">
    <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: <span id="grand" class="grand">0 Ø¯.Ø¹</span></div>

    <div class="payButtons">
      <button class="payBtn active" onclick="setCash(this)">ğŸ’µ Ù†Ù‚Ø¯</button>
      <button class="payBtn" onclick="setCredit(this)">ğŸ“„ Ø¯ÙŠÙ†</button>
    </div>

    <div>
      Ø§Ù„Ù…Ø¯ÙÙˆØ¹:
      <input type="number" id="paid" disabled>
    </div>

    <div id="restLine">
      Ø§Ù„Ø¨Ø§Ù‚ÙŠ (Ø¯ÙŠÙ†): <strong id="rest">0 Ø¯.Ø¹</strong>
    </div>

    <div id="creditBox">...</div>
  </div>

  <button class="save" onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>

</div>

</div>

<script type="module">

  // âœ… USB BARCODE SCANNER (GLOBAL â€“ Ø¨Ø¯ÙˆÙ† ÙÙˆÙƒØ³)
let scanBuffer = "";
let scanTimer = null;

document.addEventListener("keydown", async (e) => {

  // Enter = Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
if (e.key === "Enter") {
if (scanBuffer.length >= 4 && /^\d+$/.test(scanBuffer))
 {
    const code = scanBuffer.trim();
    scanBuffer = "";
    await handleBarcode(code);
    e.preventDefault();
    e.stopPropagation();
    return;
  } else {
    // â¬…ï¸ Ù…Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø®Ù„Ù‘ÙŠ Enter ÙŠÙƒÙ…Ù‘Ù„ Ø·Ø±ÙŠÙ‚Ù‡
    scanBuffer = "";
  }
}




  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
if (/^\d$/.test(e.key)) {
  scanBuffer += e.key;

    clearTimeout(scanTimer);
    scanTimer = setTimeout(() => {
      scanBuffer = "";
    }, 300);
  }
});

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  get,
  push,
  update,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";






const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com",
  projectId: "almurad-system",
  storageBucket: "almurad-system.firebasestorage.app",
  messagingSenderId: "911755824405",
  appId: "1:911755824405:web:c5520c00c11e336148ad1c"
};
// ğŸŸ¦ Barcode Scanner Logic
let barcodeBuffer = "";
let lastKeyTime = Date.now(); // âœ… Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
// ğŸŸ¦ GLOBAL POS KEYBOARD (FINAL)
let qtyBuffer = "";
let qtyMode = null;

document.addEventListener("keydown", (e) => {
  // ğŸ›‘ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø§Ø³Ø­ ÙŠÙƒØªØ¨ Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ù„Ø§ Ù†ØªØ¯Ø®Ù„


console.log("KEY:", e.key, "SHIFT:", e.shiftKey);

  // â• (Mac + Windows)
  if (
    (e.key === "=" && e.shiftKey) ||
    e.key === "+" ||
    e.key === "-"
  ) {
    qtyMode = (e.key === "-" ? "-" : "+");
    qtyBuffer = "";
    e.preventDefault();
    return;
  }

  // ğŸ”¢ Ø£Ø±Ù‚Ø§Ù…
  if (qtyMode && /^\d$/.test(e.key)) {
    qtyBuffer += e.key;
    e.preventDefault();
    return;
  }

  // â ØªÙ†ÙÙŠØ°
if (e.key === "Enter" && qtyMode && qtyBuffer) {
  applyQtyFromKeyboard(qtyMode, Number(qtyBuffer));
  qtyMode = null;
  qtyBuffer = "";
  e.preventDefault();
  e.stopPropagation();
  return;
}


});



window.stopCameraScan = function () {
  const video = document.getElementById("cameraScanner");

  if (codeReader) {
    codeReader.reset();
    codeReader = null;
  }

  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }

  video.style.display = "none";
  lastScannedCode = null;

  console.log("ğŸ“· Camera stopped");
};



async function handleBarcode(barcode) {
  console.log("ğŸ” SEARCH BARCODE:", barcode);

  const snap = await get(ref(rtdb, "warehouse"));
  if (!snap.exists()) {
    alert("âŒ Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº");
    return;
  }

  const data = snap.val();

  for (const [productName, p] of Object.entries(data)) {
    if (!p.barcodes) continue;

    for (const [variantKey, code] of Object.entries(p.barcodes)) {
      console.log("â¡ï¸ CHECK:", productName, variantKey, code);

 if (String(code).trim() === String(barcode).trim()) {

        console.log("âœ… FOUND BARCODE:", productName);
        await addProductByBarcode(
          productName,
          variantKey,
          p.prices?.pos || 0
        );
        return;
      }
    }
  }

  alert("âŒ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
}
function getReusableRow() {
  for (let i = 1; i < table.rows.length; i++) {
    const r = table.rows[i];
    const nameInput = r.cells[0].querySelector("input");

    if (!nameInput.value.trim()) {
      return r; // ØµÙ ÙØ§Ø¶ÙŠ Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
      
    }
  }
  return null;
}


async function addProductByBarcode(productName, variantKey, price) {
for (let i = 1; i < table.rows.length; i++) {
  const r = table.rows[i];
  const nameInput = r.cells[0].querySelector("input");
  const variantSelect = r.querySelector(".variantSelect");

  // â›” Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù†Ø¯Ù‡ Ù…ØªØºÙŠØ±Ø§Øª (Ø£Ù„ÙˆØ§Ù†/Ø£Ø­Ø¬Ø§Ù…) â†’ Ù„Ø§ ØªØ¶Ø§Ø¹Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§
  if (variantSelect && variantSelect.options.length > 1) {
    continue;
  }

  // âœ… ÙÙ‚Ø· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª
  if (nameInput.value === productName) {
    const qtyInput = r.cells[3].querySelector("input");
    qtyInput.value = Number(qtyInput.value) + 1;
    multiplyRow(qtyInput);
    return;
  }
}

 const stockSnap = await get(
  ref(rtdb, "warehouse/" + productName + "/stock")
);

if (!stockSnap.exists()) {
  alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ†");
  return;
}

const stock = stockSnap.val();
const realKey = Object.keys(stock).find(
  k => k.trim() === variantKey.trim()
);

const qty = realKey ? stock[realKey] : 0;

if (qty <= 0) {
  alert("âŒ Ø§Ù„ÙƒÙ…ÙŠØ© ØµÙØ±");
  return;
}
// 3ï¸âƒ£ Ø§Ø³ØªØ®Ø¯Ù… ØµÙ ÙØ§Ø¶ÙŠ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
let row = getReusableRow();

if (!row) {
  addRow();
  row = table.rows[table.rows.length - 1];
}

  row.cells[0].querySelector("input").value = productName;
  row.dataset.unitPrice = price;
  row.cells[1].textContent = f(price);

  await loadVariants(row, productName);
  row.querySelector(".variantSelect").value = variantKey;

multiplyRow(row.cells[3].querySelector("input"));

}




const app = initializeApp(firebaseConfig);
const rtdb = getDatabase(app);
const table = document.getElementById("table");






function showAllProducts(input){
  const box = input.nextElementSibling;

  // ğŸ” Ø¥Ø°Ø§ Ù…ÙØªÙˆØ­Ø© â†’ Ø£ØºÙ„Ù‚Ù‡Ø§
  if (box.style.display === "block") {
    box.style.display = "none";
    return;
  }

  box.innerHTML = "";

  products.forEach(p=>{
    const d = document.createElement("div");
    d.textContent = p.name;
    d.onclick = (e)=>{
      e.stopPropagation(); // â›” Ù„Ø§ ØªØºÙ„Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      input.value = p.name;
      box.style.display = "none";

      const row = input.closest("tr");
      row.dataset.unitPrice = p.price;
      row.cells[1].textContent = f(p.price);

      loadVariants(row, p.name);
      calc();
    };
    box.appendChild(d);
  });

  box.style.display = "block";
}


    function filterProducts(input){
  const box=input.nextElementSibling;
  box.innerHTML="";
  const val=input.value.trim();
  if(!val){box.style.display="none";return;}

  products
.filter(p=>p.name.toLowerCase().includes(val.toLowerCase()))
    .forEach(p=>{
      const d=document.createElement("div");
      d.textContent=p.name;
      d.onclick=()=>{
        input.value=p.name;
        box.style.display="none";
        const row=input.closest("tr");
row.dataset.unitPrice = p.price;
loadVariants(row, p.name);   // â­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù†Ø§Ù‚Øµ
row.cells[1].textContent = f(p.price);
calc();


      };
      box.appendChild(d);
    });

  box.style.display="block";
}

// Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±
const f=n=>Number(n||0).toLocaleString("en-US")+" Ø¯.Ø¹";
const p=v=>Number(String(v).replace(/[^0-9]/g,""))||0;


let products = [];
let uiCategories = {};     // Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
let activeCategory = null;
const addInput = document.getElementById("addProductInput");
const addDropdown = document.getElementById("addProductDropdown");

addInput.addEventListener("input", () => {
  addInput.addEventListener("click", e => e.stopPropagation());
  const val = addInput.value.trim().toLowerCase();
  addDropdown.innerHTML = "";

  if (!val) {
    addDropdown.style.display = "none";
    return;
  }

  products
    .filter(p => p.name.toLowerCase().includes(val))
    .forEach(p => {
      const d = document.createElement("div");
      d.textContent = p.name;
      d.style.padding = "8px";
      d.style.cursor = "pointer";

        d.onclick = (e) => {
  e.stopPropagation();
        const exists = uiCategories[activeCategory]
          .some(x => x.name === p.name);

        if (exists) {
          alert("Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹");
          return;
        }

        uiCategories[activeCategory].push({ name: p.name });
        localStorage.setItem(
          "uiCategories",
          JSON.stringify(uiCategories)
        );

        addInput.value = "";
        addDropdown.style.display = "none";
        document.getElementById("addProductDropdownBox").style.display = "none";
        renderCategoryProducts();
      };

      addDropdown.appendChild(d);
    });

// â›” Ø¥Ø°Ø§ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…ØºÙ„Ù‚ØŒ Ù„Ø§ ØªÙØªØ­ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
const box = document.getElementById("addProductDropdownBox");
if (box.style.display !== "block") return;

addDropdown.style.display = "block";});
// ğŸ§º Ù…Ù†ØªØ¬Ø§Øª Ø³Ø±ÙŠØ¹Ø© (Ù…Ø¨Ø§Ø´Ø± + Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)
const quickMenu = [
  {
    type: "item",
    name: "Ø³ÙƒØ±"
  },
  {
    type: "item",
    name: "Ø²ÙŠØª"
  },
  {
    type: "group",
    name: "Ø³Ù„Ø§Øª",
    children: [
      "Ø³Ù„Ø© ØµØºÙŠØ±Ø©",
      "Ø³Ù„Ø© ÙˆØ³Ø·",
      "Ø³Ù„Ø© ÙƒØ¨ÙŠØ±Ø©"
    ]
  },
  {
    type: "group",
    name: "ÙƒØ§Ø¨Ø³Ø§Øª",
    children: [
      "ÙƒØ§Ø¨Ø³Ø© A",
      "ÙƒØ§Ø¨Ø³Ø© B"
    ]
  }
];

// ğŸ§º Ù…Ù†ØªØ¬Ø§Øª Ø³Ø±ÙŠØ¹Ø© (ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø³Ù‡Ù„)
const quickList = [
  "Ø³ÙƒØ±",
  "Ø±Ø²",
  "Ø²ÙŠØª",
  "Ø´Ø§ÙŠ",
  "Ø·Ø­ÙŠÙ†",
  "Ù…Ù†Ø§Ø¯ÙŠÙ„"
]
;
function renderQuickProducts(){
  const box = document.getElementById("quickGrid");
  box.innerHTML = "";

  quickMenu.forEach(entry => {

    // ğŸŸ¢ Ù…Ù†ØªØ¬ Ù…Ø¨Ø§Ø´Ø±
    if(entry.type === "item"){
      const prod = products.find(p=>p.name === entry.name);
      if(!prod) return;

      const d = document.createElement("div");
      d.className = "quick-item";
      d.innerHTML = `
        <div>${entry.name}</div>
        <div class="price">${f(prod.price)}</div>
      `;
      d.onclick = ()=>addQuickProduct(entry.name, prod.price);
      box.appendChild(d);
    }

    // ğŸ”µ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù†ØªØ¬Ø§Øª
    if(entry.type === "group"){
      const g = document.createElement("div");
      g.className = "quick-item";
      g.style.background = "#eef3f7";
      g.innerHTML = `ğŸ“¦ ${entry.name}`;
      g.onclick = ()=>toggleGroup(entry, g);
      box.appendChild(g);
    }

  });
}
function renderCategories(){
  const bar = document.getElementById("categoriesBar");
  bar.innerHTML = "";

  // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…
  const addBtn = document.createElement("button");
  addBtn.className = "category-add";
  addBtn.textContent = "â• Ù‚Ø³Ù…";
  addBtn.onclick = addCategory;
  bar.appendChild(addBtn);

  Object.keys(uiCategories).forEach(cat=>{
    const t = document.createElement("div");
    t.className = "category-tab" + (cat === activeCategory ? " active" : "");
t.innerHTML = `
  <span>${cat}</span>
  <span class="delete-cat" data-cat="${cat}">âœ–</span>
`;
    t.onclick = ()=>{
      t.ondblclick = ()=>{
  const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…:", cat);
  if(!newName || newName === cat) return;

  uiCategories[newName] = uiCategories[cat];
  delete uiCategories[cat];

  localStorage.setItem("uiCategories", JSON.stringify(uiCategories));
  activeCategory = newName;

  renderCategories();
  renderCategoryProducts();
};
      activeCategory = cat;
      renderCategories();
      renderCategoryProducts();
    };
    bar.appendChild(t);
    t.querySelector(".delete-cat").onclick = (e)=>{
  e.stopPropagation();
  if(!confirm(`Ø­Ø°Ù Ù‚Ø³Ù… "${cat}"ØŸ`)) return;

  delete uiCategories[cat];
  localStorage.setItem("uiCategories", JSON.stringify(uiCategories));

  activeCategory = Object.keys(uiCategories)[0] || null;
  renderCategories();
  renderCategoryProducts();
};
  });
}
function renderCategoryProducts(){
  const box = document.getElementById("quickGrid");
  box.innerHTML = "";

  if(!activeCategory) return;

  uiCategories[activeCategory].forEach(item=>{
    const prod = products.find(p=>p.name === item.name);
    if(!prod) return;

    const d = document.createElement("div");
    d.className = "quick-item";d.innerHTML = `
  <div>${item.name}</div>
  <div class="price">${f(prod.price)}</div>
  <div class="delete-prod" data-name="${item.name}">âœ–</div>
`;
    d.onclick = ()=>addQuickProduct(item.name, prod.price);
    box.appendChild(d);
d.querySelector(".delete-prod").onclick = (e)=>{
  e.stopPropagation();

  const ok = confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬:\n"${item.name}" ØŸ`);
  if(!ok) return;

  uiCategories[activeCategory] =
    uiCategories[activeCategory].filter(p=>p.name !== item.name);

  localStorage.setItem(
    "uiCategories",
    JSON.stringify(uiCategories)
  );

  renderCategoryProducts();
};
  });
}
function addCategory(){
  const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…");
  if(!name) return;

  if(uiCategories[name]){
    alert("Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯");
    return;
  }

  uiCategories[name] = [];
  localStorage.setItem("uiCategories", JSON.stringify(uiCategories));
  activeCategory = name;
  renderCategories();
  renderCategoryProducts();
}
function addProductToCategory(){
  if(!activeCategory){
    alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù„Ø§Ø²Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†)");
  if(!name) return;

  const exists = products.find(p=>p.name === name);
  if(!exists){
    alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†");
    return;
  }

  uiCategories[activeCategory].push({name});
  localStorage.setItem("uiCategories", JSON.stringify(uiCategories));
  renderCategoryProducts();
}
document.getElementById("addProductBtn").onclick = (e) => {
  e.stopPropagation(); // Ù…Ù‡Ù…

  if (!activeCategory) {
    alert("Ø§Ø®ØªØ± Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const box = document.getElementById("addProductDropdownBox");
  box.style.display = "block";

  document.getElementById("addProductInput").focus();
};
async function loadProducts(){
  products = [];

  const snap = await get(ref(rtdb, "warehouse"));
  if(!snap.exists()) {
    console.warn("âš ï¸ Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº");
    return;
  }

  const data = snap.val();

  for(const [name, p] of Object.entries(data)){
    products.push({
      name,
      price: p.prices?.pos || 0,
      totalQty: p.totalQty || 0
    });
  }

  console.log("âœ… products loaded:", products);

  renderQuickProducts(); // âœ… ØªÙ†Ø§Ø¯ÙŠÙ‡Ø§ Ù…Ø±Ø© ÙˆØ­Ø¯Ø© ÙÙ‚Ø·
}
function toggleGroup(group, box){

  // Ø¥Ø°Ø§ Ù…ÙØªÙˆØ­Ø© â†’ Ø£ØºÙ„Ù‚Ù‡Ø§
  if(box._open){
    document.querySelectorAll(".sub-item").forEach(e=>{
      if(e.dataset.parent === group.name) e.remove();
    });
    box._open = false;
    return;
  }

  // Ø£ØºÙ„Ù‚ Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø«Ø§Ù†ÙŠØ©
  document.querySelectorAll(".sub-item").forEach(e=>e.remove());
  document.querySelectorAll(".quick-item").forEach(b=>b._open=false);

  // Ø§ÙØªØ­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  group.children.forEach(name=>{
    const prod = products.find(p=>p.name === name);
    if(!prod) return;

    const s = document.createElement("div");
    s.className = "quick-item sub-item";
    s.dataset.parent = group.name;
    s.style.marginRight = "10px";
    s.style.background = "#fff";
    s.innerHTML = `
      <div>âœ ${name}</div>
      <div class="price">${f(prod.price)}</div>
    `;
    s.onclick = ()=>addQuickProduct(name, prod.price);

    box.after(s);
  });

  box._open = true;
}

async function loadVariants(row, productName){
  // â›” Ù„Ø§ ØªØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø°Ø§ Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªØ¬
if (row.dataset.loadedProduct === productName) {
  return;
}
  const select = row.querySelector(".variantSelect");
  select.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>`;

  const snap = await get(ref(rtdb, "warehouse/" + productName));
  if(!snap.exists()) return;

const stock = snap.val().stock || {};
const totalStock = Object.values(stock).reduce(
  
  (a, b) => a + Number(b || 0),
  
  0
);
row._totalStock = totalStock; // â­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù† Ù†Ø§Ù‚Øµ

row._stock = { ...stock }; // Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø®Ø²Ù†
const stockSpan = row.querySelector(".stockQty");
stockSpan.textContent = totalStock; // âœ… Ø§ÙƒØªØ¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²Ù† ÙÙˆØ± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬

select.onchange = () => {
  const k = select.value;

  if (!k) {
    stockSpan.textContent = row._totalStock;
  } else {
    stockSpan.textContent = stock[k] ?? 0;
  }
};



  // â­â­â­ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø· â­â­â­
if (
  Object.keys(stock).length === 1 &&
  stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined
) {
  select.innerHTML =
    `<option value="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</option>`;

  // âœ… Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø®Ø²Ù† ÙÙˆØ±Ù‹Ø§
  stockSpan.textContent = stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] ?? 0;

  return;
}


  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù„ÙˆÙ† / Ù‚ÙŠØ§Ø³ / ...)
  for(const key in stock){
    if(stock[key] > 0){
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = `${key} (${stock[key]})`;
      select.appendChild(opt);
      opt.dataset.qty = stock[key];

    }
  }
}



// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
const savedCats = localStorage.getItem("uiCategories");
if (savedCats) {
  uiCategories = JSON.parse(savedCats);
}

// âœ… Ø´ØºÙ‘Ù„ Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØµØ§Ø± Ù…ÙˆØ¬ÙˆØ¯
await loadProducts();// Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ø£Ù‚Ø³Ø§Ù… Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø£Ù†Ø´Ø¦ Ø§ÙØªØ±Ø§Ø¶ÙŠ
// Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ø£Ù‚Ø³Ø§Ù…ØŒ Ù„Ø§ ØªØ¶ÙŠÙ Ø´ÙŠ
if (Object.keys(uiCategories).length === 0) {
  activeCategory = null;
}

renderCategories();
renderCategoryProducts();
addRow();
const grandEl=document.getElementById("grand");
const paidEl=document.getElementById("paid");
const restEl=document.getElementById("rest");
const restLine=document.getElementById("restLine");

document.getElementById("date").textContent=new Date().toLocaleDateString("ar-EG");
let invoice = Number(localStorage.getItem("invoiceNo")) || 1;
document.getElementById("invoice").textContent = invoice;


let isCredit=false;
let isReturnMode = false;
function switchToReturn(){
  isReturnMode = true;
  document.body.classList.add("return-mode");
  document.querySelector("header").style.background = "#c0392b";
  calc();
}

function addRow(){
  const r = table.insertRow();
  r.dataset.unitPrice = 0;

r.innerHTML = `
<td class="product">
<input 
  class="searchInput"
  placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"
  onclick="event.stopPropagation(); showAllProducts(this)"
  oninput="filterProducts(this)"
>

  <div class="dropdown"></div>

  <select class="variantSelect">
    <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>
  </select>
</td>

<td>0 Ø¯.Ø¹</td>

<td class="stock">
  <span class="stockQty">0</span>
</td>

<td class="qty">
<input 
  type="text"
  value="1"
  class="qtyInput"
  style="width:60px;font-size:14px;padding:4px;text-align:center"
  onkeydown="handleQtyKey(event, this)"
  onblur="normalizeQty(this)"
>

</td>

<td>0 Ø¯.Ø¹</td>

<td>
  <button onclick="removeRow(this)" style="
    background:#c0392b;
    color:white;
    border:none;
    border-radius:6px;
    padding:6px 10px;
    cursor:pointer;
  ">âœ–</button>
</td>
`;


}

function removeRow(btn){
  const row = btn.closest("tr");

  // Ø¥Ø°Ø§ Ù‡Ø°Ø§ Ø¢Ø®Ø± ØµÙ â†’ ØµÙÙ‘Ø±Ù‡ Ø¨Ø¯Ù„ Ù…Ø§ ØªØ­Ø°ÙÙ‡
  if (table.rows.length <= 2) {
    // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    row.dataset.unitPrice = 0;

    row.cells[0].querySelector("input").value = "";
    row.querySelector(".variantSelect").innerHTML =
      `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>`;

    row.cells[1].textContent = "0 Ø¯.Ø¹";
    row.cells[3].querySelector("input").value = 1;
    row.cells[4].textContent = "0 Ø¯.Ø¹";

    // ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù†
    row.querySelector(".stockQty").textContent = "0";
    row._stock = {};
    row._totalStock = 0;

    calc();
    return;
  }

  // Ø¥Ø°Ø§ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙ â†’ Ø§Ø­Ø°Ù Ø¹Ø§Ø¯ÙŠ
  row.remove();
  calc();
}

function calc(){
  let total = 0;

  for(let i = 1; i < table.rows.length; i++){
    const r = table.rows[i];

    const unitPrice = Number(r.dataset.unitPrice || 0); // â­ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ


const qty = Number(r.cells[3].children[0].value || 0);
const sign = isReturnMode ? -1 : 1;
const sum = sign * unitPrice * qty;

r.cells[4].textContent = f(sum);



    total += sum;
  }

  grandEl.textContent = f(total);

  if(!isCredit){
    paidEl.value = total;
    restEl.textContent = f(0);
  }else{
    restEl.textContent = f(total - Number(paidEl.value || 0));
  }
}


paidEl.oninput=calc;

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙØ¹
function setCash(btn){
  isCredit=false;
  paidEl.disabled=true;
  document.getElementById("creditBox").style.display="none";
  restLine.style.display="none";
  document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  calc();
}

function setCredit(btn){
  isCredit=true;
  paidEl.disabled=false;
  paidEl.value=0;
  document.getElementById("creditBox").style.display="block";
  restLine.style.display="block";
  document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  calc();
}
function resetRows(){
  for(let i = 1; i < table.rows.length; i++){
    const r = table.rows[i];

    r.dataset.unitPrice = 0; // â† Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±

    r.cells[0].querySelector("input").value = "";
    r.querySelector(".variantSelect").innerHTML =
  `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± â€”</option>`;

r.cells[1].textContent = "0 Ø¯.Ø¹";
r.cells[3].querySelector("input").value = 1;
r.cells[4].textContent = "0 Ø¯.Ø¹";

// ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
r.querySelector(".stockQty").textContent = "0";
r._stock = {};
r._totalStock = 0;

  }
}
function switchToCash(){
  isReturnMode = false;

  // Ø±Ø¬Ù‘Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹
  document.body.classList.remove("return-mode");
  document.querySelector("header").style.background = "var(--blue)";

  // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ø¯ÙØ¹ ÙƒØ§Ø´
  isCredit = false;
  paidEl.disabled = true;
  document.getElementById("creditBox").style.display = "none";
  restLine.style.display = "none";

  // ÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„ÙƒØ§Ø´ Ø¨ØµØ±ÙŠÙ‹Ø§
  document.querySelectorAll(".payBtn").forEach(b=>b.classList.remove("active"));
  document.querySelector(".payBtn").classList.add("active");

  calc();
}



function multiplyRow(input) {
  const row = input.closest("tr");
  if (!row) return;

  const unitPrice = Number(row.dataset.unitPrice || 0);
  const qty = Number(input.value || 0);

  const sum = unitPrice * qty;

  // Ø§ÙƒØªØ¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµÙ
  row.cells[4].textContent = f(sum);

  // Ø£Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  calc();
}

// Ø­ÙØ¸
async function saveInvoice(){
  const items=[];
for(let i=1;i<table.rows.length;i++){
    const r=table.rows[i];
    const name=r.cells[0].children[0].value;
    if(name){
      const prod=products.find(x=>x.name===name);
      if(!prod){
  alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: " + name);
  return;
}


const qty = Number(r.cells[3].querySelector("input").value || 0);

      if(qty <= 0){
  alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  return;
}

 const productRef = ref(rtdb, "warehouse/" + name);
const snap = await get(productRef);

if(!snap.exists()){
  alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: " + name);
  return;
}

const data = snap.val();

if(!isReturnMode && data.totalQty < qty){
  alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©: " + name);
  return;
}


// ğŸ”¹ Ù†Ø³Ø® Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
const stock = { ...(data.stock || {}) };

// ğŸ”¹ Ø£Ù†Ù‚Øµ Ù…Ù† Ø£ÙˆÙ„ Ù…ØªØºÙŠØ± Ù…ØªÙˆÙØ±
const variantKey = r.querySelector(".variantSelect").value;

if(!variantKey && !isReturnMode){
  alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„Ù…Ù†ØªØ¬: " + name);
  return;
}
window.multiplyRow = multiplyRow;


if(!isReturnMode && stock[variantKey] < qty){
  alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ±");
  return;
}


if(isReturnMode){
  stock[variantKey] += qty;
  prod.totalQty += qty;
}else{
  stock[variantKey] -= qty;
  prod.totalQty -= qty;
}



// ğŸ”¹ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©
const newTotalQty = Object.values(stock).reduce((a, b) => a + b, 0);

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« Firebase
await update(productRef, {
  stock,
  totalQty: newTotalQty,
  lastUpdate: serverTimestamp()
});




items.push({
  product: name,
  qty: isReturnMode ? -qty : qty,
  price: prod.price,
  total: isReturnMode ? -prod.price * qty : prod.price * qty
});




    }
  }
  if(!items.length){alert("Ù…Ø§ÙƒÙˆ Ù…ÙˆØ§Ø¯");return;}

  let debtor=null;
  if(isCredit){
    if(!debtorName.value.trim()){alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙˆÙ† Ù…Ø·Ù„ÙˆØ¨");return;}
    debtor={name:debtorName.value,phone:debtorPhone.value,note:debtorNote.value};
  }

  localStorage.setItem("products", JSON.stringify(products));

try {
await push(ref(rtdb, "posInvoices"), {
  
  invoiceNo: invoice,
  items,
  total: p(grandEl.textContent),
  paid: Number(paidEl.value || 0),
type: isReturnMode ? "return" : (isCredit ? "credit" : "cash"),

cashierId: localStorage.getItem("cashierUsername") || "unknown",

createdAt: serverTimestamp()
});

// ğŸ§¾ ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯)
window._printData = {
  items: items.map(i => ({
    name: i.product,
    qty: Math.abs(i.qty),
    total: Math.abs(i.total)
  })),
  total: p(grandEl.textContent)
};

  console.log("âœ… Invoice saved successfully");
  // ğŸ–¨ï¸ Ø§Ø·Ø¨Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø·
setTimeout(() => {
  try {
    buildAndPrintReceipt();
  } catch (e) {
    console.warn("ğŸ–¨ï¸ Printing skipped");
  }
}, 100);

// ğŸ”„ Ø±Ø¬Ù‘Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹
if(isReturnMode){
  switchToCash();
}
// âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø¹Ø§Ø± ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¯ÙˆÙ† ØªØ¯Ø®Ù„
const saveToast = document.getElementById("saveToast");
saveToast.style.display = "block";

setTimeout(() => {
  saveToast.style.display = "none";
}, 1500);

} catch (err) {
  console.error("âŒ FAILED TO SAVE INVOICE", err);
  alert("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸ â€” Ø§ÙØªØ­ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„");
  return;
}


  
// Ø®Ø²Ù‘Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
// Ø®Ø²Ù‘Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
localStorage.setItem("invoiceNo", invoice + 1);

// Ø­Ø¯Ù‘Ø« Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©
invoice++;

// Ø­Ø¯Ù‘Ø« Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙˆØ±Ù‹Ø§
requestAnimationFrame(() => {
  document.getElementById("invoice").textContent = invoice;
});

// Ø±Ø¬Ù‘Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ù†Ù‚Ø¯
isCredit = false;
paidEl.disabled = true;
paidEl.value = 0;
document.getElementById("creditBox").style.display = "none";
restLine.style.display = "none";

document.querySelectorAll(".payBtn").forEach(b => b.classList.remove("active"));
document.querySelector(".payBtn").classList.add("active");
// ğŸ§¹ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ ÙˆØªØ±Ùƒ ØµÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
while (table.rows.length > 2) {
  table.deleteRow(1);
}

// ØµÙÙ‘Ø± Ø§Ù„ØµÙÙˆÙ Ø¨Ø¯ÙˆÙ† Ø­Ø°ÙÙ‡Ø§
resetRows();

// ØµÙÙ‘Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
grandEl.textContent = f(0);
restEl.textContent = f(0);

}
function parkInvoice(){
  const rows = [];

  for(let i=1;i<table.rows.length;i++){
    const r = table.rows[i];
    const name = r.cells[0].querySelector("input").value;
    if(!name) continue;

    rows.push({
      name,
      variant: r.querySelector(".variantSelect").value,
qty: Number(r.cells[3].querySelector("input").value),

      price: Number(r.dataset.unitPrice)
    });
  }

  if(!rows.length){
    alert("Ù…Ø§ÙƒÙˆ Ù…ÙˆØ§Ø¯ Ø­ØªÙ‰ ØªØªØ¹Ù„Ù‘Ù‚");
    return;
  }

  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  const key = "P" + Date.now();
const total = p(grandEl.textContent);

parked[key] = {
  rows,
  total,
  count: rows.length,
  time: new Date().toISOString()
};

  localStorage.setItem("parkedInvoices", JSON.stringify(parked));

  // ğŸ§¹ ØªØµÙÙŠØ± ÙƒØ§Ù…Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ (POS RESET)

// 1ï¸âƒ£ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù‡ÙŠØ¯Ø±
while (table.rows.length > 1) {
  table.deleteRow(1);
}

// 2ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© ØµÙ ÙˆØ§Ø­Ø¯ Ù†Ø¸ÙŠÙ
addRow();

// 3ï¸âƒ£ ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
grandEl.textContent = f(0);
paidEl.value = 0;
restEl.textContent = f(0);

// 4ï¸âƒ£ Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù‘Ù„
if (isReturnMode) {
  switchToCash();
}


 
}
function resumeInvoice(){
  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  const keys = Object.keys(parked);

  if(!keys.length){
    alert("Ù…Ø§ÙƒÙˆ ÙÙˆØ§ØªÙŠØ± Ù…Ø¹Ù„Ù‚Ø©");
    return;
  }

  const list = document.getElementById("parkedList");
  list.innerHTML = "";

keys.forEach(key => {
  const inv = parked[key];
  const t = new Date(inv.time);
  const timeStr = t.toLocaleTimeString("ar-EG", {
    hour: "2-digit",
    minute: "2-digit"
  });

  const box = document.createElement("div");
  box.style.cssText = `
    display:flex;
    gap:6px;
    margin-bottom:6px;
  `;

  const btn = document.createElement("button");
  btn.textContent =
    `ğŸ§¾ ${inv.count} Ù…ÙˆØ§Ø¯ | ğŸ’° ${f(inv.total)} | â° ${timeStr}`;
  btn.style.cssText = `
    flex:1;
    padding:10px;
    border:none;
    border-radius:8px;
    background:#2980b9;
    color:white;
    cursor:pointer;
  `;
  btn.onclick = () => loadParkedInvoice(key);

  const del = document.createElement("button");
  del.textContent = "ğŸ—‘ï¸";
  del.style.cssText = `
    width:48px;
    border:none;
    border-radius:8px;
    background:#c0392b;
    color:white;
    cursor:pointer;
  `;
  del.onclick = () => deleteParkedInvoice(key);

  box.appendChild(btn);
  box.appendChild(del);
  list.appendChild(box);
});

  document.getElementById("parkedModal").style.display = "block";
}
function loadParkedInvoice(key){
  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  const data = parked[key];
  if(!data) return;

  resetRows();

  data.rows.forEach((item, i)=>{
    if(i > 0) addRow();
    const r = table.rows[i+1];

    r.cells[0].querySelector("input").value = item.name;
    r.dataset.unitPrice = item.price;
    r.cells[1].textContent = f(item.price);
r.cells[3].querySelector("input").value = item.qty;


    loadVariants(r, item.name).then(()=>{
      r.querySelector(".variantSelect").value = item.variant;
    });
  });

  delete parked[key];
  localStorage.setItem("parkedInvoices", JSON.stringify(parked));

  document.getElementById("parkedModal").style.display = "none";
  document.getElementById("resumeBanner").style.display = "block";

  calc();
}

function closeParkedModal(){
  document.getElementById("parkedModal").style.display = "none";
}

// ğŸ§¾ BUILD & PRINT RECEIPT (80mm AUTO HEIGHT)
window.buildAndPrintReceipt = function () {
  const itemsBox = document.getElementById("printItems");
  const totalBox = document.getElementById("printTotal");

  itemsBox.innerHTML = "";

  if (!window._printData || !window._printData.items.length) {
    console.warn("ğŸ§¾ No print data");
    return;
  }

  window._printData.items.forEach(item => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.fontSize = "12px";
    row.innerHTML = `
      <span>${item.name} Ã— ${item.qty}</span>
      <span>${f(item.total)}</span>
    `;
    itemsBox.appendChild(row);
  });

  totalBox.textContent = f(window._printData.total);
// ğŸ§¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
document.getElementById("printCashier").textContent =
  localStorage.getItem("cashierUsername") || "â€”";

document.getElementById("printDate").textContent =
  new Date().toLocaleDateString("ar-EG");

document.getElementById("printInvoiceNo").textContent =
  document.getElementById("invoice").textContent;

  window.print();
};

// ğŸ”— expose functions to HTML (required for type="module")
window.addRow = addRow;
window.switchToCash = switchToCash;
window.switchToReturn = switchToReturn;
window.handleQtyKey = handleQtyKey;
window.normalizeQty = normalizeQty;


window.removeRow = removeRow;


window.addCategory = addCategory; // â¬…ï¸ Ø£Ù†ØµØ­ ØªØ¶ÙŠÙÙ‡ Ù‡Ù…
window.showAllProducts = showAllProducts;
window.filterProducts = filterProducts;
window.setCash = setCash;
window.setCredit = setCredit;
window.saveInvoice = saveInvoice;

window.multiplyRow = multiplyRow;
window.parkInvoice = parkInvoice;
window.resumeInvoice = resumeInvoice;
window.loadParkedInvoice = loadParkedInvoice;
window.closeParkedModal = closeParkedModal;

window.onload = () => {
  document.body.focus();
};

// ğŸŸ¢ Ø¥ØºÙ„Ø§Ù‚ Ù…Ù†Ø³Ø¯Ù„Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener("click", (e) => {
  document.querySelectorAll(".dropdown").forEach(box => {
    const input = box.previousElementSibling;

    if (!box.contains(e.target) && !input.contains(e.target)) {
      box.style.display = "none";
    }
  });
});


// ğŸŸ¢ ÙƒØªØ§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (CAPTURE MODE)
document.addEventListener("keydown", (e) => {

  // âŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)
  if (/^\d$/.test(e.key)) return;

  // âŒ ØªØ¬Ø§Ù‡Ù„ Enter ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª
  if (["Enter", "+", "-", "="].includes(e.key)) return;

  // âŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª
  if (e.ctrlKey || e.altKey || e.metaKey) return;

  // âŒ Ø¥Ø°Ø§ Ø¯Ø§Ø®Ù„ input Ø£ØµÙ„Ø§Ù‹
  const active = document.activeElement;
  if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) {
    return;
  }

  // ğŸŸ¢ Ø¢Ø®Ø± ØµÙ
  let targetInput = null;
  for (let i = table.rows.length - 1; i >= 1; i--) {
    const inp = table.rows[i].querySelector(".searchInput");
    if (inp) {
      targetInput = inp;
      break;
    }
  }

  if (!targetInput) return;

  // ğŸŸ¢ Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ø±Ù
  targetInput.focus();
  targetInput.value += e.key;
  filterProducts(targetInput);

  e.preventDefault();
  e.stopPropagation(); // ğŸ”¥ Ù…Ù‡Ù…
}, true); // ğŸ”¥ capture phase

document.addEventListener("click", (e) => {

  // ğŸ›‘ Ø¥Ø°Ø§ Ø§Ù„ÙƒÙ„Ùƒ Ø¯Ø§Ø®Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ â†’ Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„ÙÙˆÙƒØ³
  if (e.target.closest("#addProductDropdownBox")) return;

  // ğŸ›‘ Ø¥Ø°Ø§ ÙŠÙƒØªØ¨ Ø¯Ø§Ø®Ù„ Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const active = document.activeElement;
  if (
    active &&
    (
      active.classList.contains("searchInput") ||
      active.id === "addProductInput"
    )
  ) return;

  document.getElementById("barcodeInput")?.focus();
});
function deleteParkedInvoice(key){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø©ØŸ")) return;

  const parked = JSON.parse(localStorage.getItem("parkedInvoices") || "{}");
  delete parked[key];
  localStorage.setItem("parkedInvoices", JSON.stringify(parked));

  resumeInvoice(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
}

let cameraStream = null;
let codeReader = null;
let lastScannedCode = null;
let lastScanTime = 0;

window.startCameraScan = async function () {
  const video = document.getElementById("cameraScanner");
  video.style.display = "block";

  codeReader = new ZXing.BrowserBarcodeReader();

  try {
    codeReader.decodeFromConstraints(
      {
        video: {
          facingMode: "environment"
        }
      },
      video,
      (result, err) => {
        if (result) {
          const code = result.text;
          const now = Date.now();

          // ğŸ›‘ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
          if (code === lastScannedCode && now - lastScanTime < 1200) return;

          lastScannedCode = code;
          lastScanTime = now;

          console.log("ğŸ“· CAMERA BARCODE:", code);
          handleBarcode(code);
        }
      }
    );
  } catch (err) {
    alert("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
    console.error(err);
  }
};
function handleQtyKey(e, input){
  if (e.key !== "Enter") return;

  e.preventDefault();

  const row = input.closest("tr");

  // ğŸ”‘ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù‚Ø¨Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©)
  let baseQty = Number(input.getAttribute("data-last") || 1);

  const raw = input.value.trim();

  let newQty = baseQty;

  if (raw.startsWith("+")) {
    const n = Number(raw.slice(1));
    if (!isNaN(n)) newQty = baseQty + n;
  }
  else if (raw.startsWith("-")) {
    const n = Number(raw.slice(1));
    if (!isNaN(n)) newQty = baseQty - n;
  }
  else {
    const n = Number(raw);
    if (!isNaN(n)) newQty = n;
  }

  if (newQty < 1) newQty = 1;

  // âœ… Ø«Ø¨Ù‘Øª Ø§Ù„Ù‚ÙŠÙ…Ø©
  input.value = newQty;
  input.setAttribute("data-last", newQty);

  multiplyRow(input);
}
function normalizeQty(input){
  let v = Number(input.value);

  if (isNaN(v) || v < 1) v = 1;

  input.value = v;
  input.setAttribute("data-last", v);

  multiplyRow(input);
}


function applyQtyFromKeyboard(mode, value) {
  let lastRow = null;

  for (let i = table.rows.length - 1; i >= 1; i--) {
    const r = table.rows[i];
    const name = r.cells[0].querySelector("input").value;
    if (name) {
      lastRow = r;
      break;
    }
  }

  if (!lastRow) return;

  const qtyInput = lastRow.cells[3].querySelector("input");
  let current = Number(qtyInput.value || 1);

  if (mode === "+") current += value;
  if (mode === "-") current -= value;
  if (current < 1) current = 1;

  qtyInput.value = current;
  qtyInput.setAttribute("data-last", current);

  multiplyRow(qtyInput);
}



async function addQuickProduct(productName, price){
for (let i = 1; i < table.rows.length; i++) {
  const r = table.rows[i];
  const nameInput = r.cells[0].querySelector("input");
  const variantSelect = r.querySelector(".variantSelect");

  // Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªØ¬ØŸ
  if (nameInput.value !== productName) continue;

  // âŒ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ù…ØªØºÙŠØ±Ø§Øª â†’ Ù„Ø§ Ù†Ø¯Ù…Ø¬
  if (variantSelect.options.length > 1) {
    continue;
  }

  // âœ… Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª â†’ Ø²ÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø¯
  const qtyInput = r.cells[3].querySelector("input");
  qtyInput.value = Number(qtyInput.value) + 1;
  multiplyRow(qtyInput);
  return;
}
  // ğŸ§© Ø§Ø³ØªØ®Ø¯Ù… ØµÙ ÙØ§Ø¶ÙŠ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯
  let row = getReusableRow();
  if (!row) {
    addRow();
    row = table.rows[table.rows.length - 1];
  }

  // ğŸ§¾ Ø§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  row.cells[0].querySelector("input").value = productName;
  row.dataset.unitPrice = price;
  row.cells[1].textContent = f(price);

  // ğŸ§  Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  await loadVariants(row, productName);

  // Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ù…ØªØºÙŠØ± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· â†’ Ø§Ø®ØªØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const select = row.querySelector(".variantSelect");
  if (select.options.length === 1) {
    select.selectedIndex = 0;
  }

  multiplyRow(row.cells[3].querySelector("input"));
}
let lastEnterTime = 0;

document.addEventListener("keydown", (e) => {

  // Ù„Ø§ ØªØªØ¯Ø®Ù„ Ø¥Ø°Ø§ Ø¯Ø§Ø®Ù„ input
  const el = document.activeElement;
  if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) return;

  if (e.key !== "Enter") return;

  const now = Date.now();

  if (now - lastEnterTime < 350) {
    console.log("ğŸ’¾ DOUBLE ENTER â†’ SAVE");

    e.preventDefault();
    e.stopImmediatePropagation(); // ğŸ”¥ Ù‡Ø°Ø§ ÙŠØ­Ø³Ù… ÙƒÙ„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶

    saveInvoice();
    lastEnterTime = 0;
  } else {
    lastEnterTime = now;
  }

}, true); // ğŸ”¥ capture phase




</script>


<!-- ğŸŸ¢ Toast ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="freezeToast" style="
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#27ae60;
  color:white;
  padding:12px 20px;
  border-radius:12px;
  font-size:15px;
  box-shadow:0 6px 14px rgba(0,0,0,0.2);
  display:none;
  z-index:2000;
">

  âœ… ØªÙ… ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
</div>
<div id="saveToast" style="
  position:fixed;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:#2980b9;
  color:white;
  padding:12px 20px;
  border-radius:12px;
  font-size:15px;
  box-shadow:0 6px 14px rgba(0,0,0,0.2);
  display:none;
  z-index:2000;
">
  ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­
</div>
<!-- ğŸ§¾ PRINT RECEIPT (HIDDEN) -->
<div id="printArea">
  <div class="receipt">

 <div style="text-align:center;font-weight:bold">
  Ø³Ù†ØªØ± Ø§Ù„Ù…Ø±Ø§Ø¯<br>
  ğŸ“ 07865393559
</div>

<div style="font-size:11px;margin-top:4px">
  <div>ğŸ‘¤ Ø§Ù„ÙƒØ§Ø´ÙŠØ±: <span id="printCashier"></span></div>
  <div>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="printDate"></span></div>
  <div>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: <span id="printInvoiceNo"></span></div>
</div>


    <hr>

    <div id="printItems"></div>

    <hr>

    <div style="display:flex;justify-content:space-between;font-weight:bold">
      <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span>
      <span id="printTotal">0</span>
    </div>

    <div style="text-align:center;margin-top:6px">
      Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ³ÙˆÙ‚ÙƒÙ… ğŸŒ¸
    </div>

  </div>
</div>


</body>
</html> 
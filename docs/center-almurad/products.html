<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ù…Ø®Ø²Ù†</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
}
body{
  margin:0;
  font-family:Tahoma;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:12px;
  text-align:center;
  font-size:18px;
}
.container{
  padding:10px;
}
table{
  width:100%;
  background:white;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{
  background:#eaf0f6;
}
input{
  width:100%;
  border:none;
  text-align:center;
}
button{
  padding:6px 10px;
  background:var(--orange);
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.delete{
  background:#c0392b;
}
input,select,textarea{
  font-size:16px !important;
}
html, body{
  touch-action: manipulation;
}
</style>
</head>

<body>

<header>ğŸ¬ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</header>

<div class="container" style="
  background:white;
  margin:10px;
  border-radius:8px;
  display:flex;
  gap:10px;
  align-items:center;
">
  <input type="file" id="excelFile" accept=".xlsx,.xls" style="flex:1">
  <button onclick="importExcel()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
</div>
<div class="container" style="background:white;margin:10px;border-radius:8px">
  <input
    type="text"
    id="searchInput"
    placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."
    oninput="searchProducts(this.value)"
  >
</div>

<div class="container">

  <button onclick="addProduct()" style="margin-bottom:10px">
    â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
  </button>

  <table id="productsTable">
    <tr>
      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
      <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø­Ø°Ù</th>
    </tr>
  </table>

</div>


<script type="module">
/* ğŸ”¹ Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  getDoc,          // âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù†Ø§Ù‚Øµ
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqudXSSUtolKjyN574DtiS592BKDxrrAo",
  authDomain: "al-murad-cashier.firebaseapp.com",
  projectId: "al-murad-cashier"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ğŸ”¹ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href = "index.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));

  if(!snap.exists()){
    location.href = "dashboard.html";
    return;
  }

  const data = snap.data();
  const roles = data.roles || {};

  // Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…
  if (data.role === "admin") {
    roles.admin = true;
  }

  // âŒ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©
  if (!roles.admin && !roles.store) {
    alert("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†");
    location.href = "dashboard.html";
    return;
  }

  // âœ… Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„
  loadProducts();
});



/* ğŸ”¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª */
const table = document.getElementById("productsTable");
let products = [];

/* ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
async function loadProducts(){
  products = [];
  const snap = await getDocs(collection(db,"products"));
  snap.forEach(d=>{
    products.push({id:d.id, ...d.data()});
  });
  render();
}

/* ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function render(){
  table.innerHTML = `
    <tr>
      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
      <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø­Ø°Ù</th>
    </tr>
  `;

  products.forEach(p=>{
    const r = table.insertRow();
r.innerHTML = `
<td><input value="${p.name || ''}" onchange="updateProduct('${p.id}','name',this.value)"></td>
<td><input type="number" value="${p.buy || ''}" onchange="updateProduct('${p.id}','buy',this.value)"></td>
<td><input type="number" value="${p.sell || ''}" onchange="updateProduct('${p.id}','sell',this.value)"></td>
<td><input type="number" value="${p.qty || ''}" onchange="updateProduct('${p.id}','qty',this.value)"></td>
<td>
  <button class="delete" onclick="deleteProduct('${p.id}')">âœ–</button>
</td>
`;

  });
}

/* ğŸ”¹ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ */
window.addProduct = async function(){
  const ref = await addDoc(collection(db,"products"),{
    name:"",
    buy:"",
    sell:"",
    qty:"",
    createdAt: serverTimestamp()
  });

  // â¬†ï¸ Ø¶ÙŠÙÙ‡ Ø¨Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ©
  products.unshift({
    id: ref.id,
    name:"",
    buy:"",
    sell:"",
    qty:""
  });

  render();
};
window.searchProducts = function(text){
  const q = text.trim().toLowerCase();

  const filtered = products.filter(p =>
    (p.name || "").toLowerCase().includes(q)
  );

  renderFiltered(filtered);
};

function renderFiltered(list){
  table.innerHTML = `
    <tr>
      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
      <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø­Ø°Ù</th>
    </tr>
  `;

  list.forEach(p=>{
    const r = table.insertRow();
    r.innerHTML = `
<td><input value="${p.name || ''}" onchange="updateProduct('${p.id}','name',this.value)"></td>
<td><input type="number" value="${p.buy || ''}" onchange="updateProduct('${p.id}','buy',this.value)"></td>
<td><input type="number" value="${p.sell || ''}" onchange="updateProduct('${p.id}','sell',this.value)"></td>
<td><input type="number" value="${p.qty || ''}" onchange="updateProduct('${p.id}','qty',this.value)"></td>
<td><button class="delete" onclick="deleteProduct('${p.id}')">âœ–</button></td>
`;
  });
}

/* ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬ */
window.updateProduct = async function(id,key,val){
  await updateDoc(doc(db,"products",id),{
    [key]: key === "name" ? val : Number(val)
  });
};


/* ğŸ”¹ Ø­Ø°Ù Ù…Ù†ØªØ¬ */
window.deleteProduct = async function(id){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
  await deleteDoc(doc(db,"products",id));
  loadProducts();
};

/* ğŸ”¹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel */
window.importExcel = function(){
  const fileInput = document.getElementById("excelFile");
  if(!fileInput.files.length){
    alert("Ø§Ø®ØªØ± Ù…Ù„Ù Excel");
    return;
  }

  const reader = new FileReader();
  reader.onload = async e=>{
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data,{type:"array"});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet,{header:1});
    rows.shift();

    for(const r of rows){
      if(!r[0]) continue;
      await addDoc(collection(db,"products"),{
        name: r[0],
        buy: Number(r[1]) || 0,
        sell: Number(r[2]) || 0,
        qty: Number(r[3]) || 0,
        createdAt: serverTimestamp()
      });
    }

    fileInput.value="";
    alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    loadProducts();
  };
  reader.readAsArrayBuffer(fileInput.files[0]);
};


</script>

</body>
</html>

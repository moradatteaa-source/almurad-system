<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¯ÙŠÙˆÙ†</title>

<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
  --red:#c0392b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Tajawal, Tahoma, sans-serif;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:16px;
  text-align:center;
  font-size:18px;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:12px;
}
.customer{
  background:white;
  border-radius:14px;
  padding:14px;
  margin-bottom:16px;
  border:1px solid #ddd;
}
.cHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.name{
  font-size:17px;
  font-weight:bold;
  color:var(--blue);
}
.phone{
  font-size:13px;
  color:#555;
}
.totalDebt{
  color:var(--red);
  font-weight:bold;
  font-size:16px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:13px;
}
th,td{
  border:1px solid #eee;
  padding:6px;
  text-align:center;
}
th{
  background:#f1f4f7;
}
.payBox{
  margin-top:10px;
  display:flex;
  gap:10px;
}
.payBox input{
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
.payBox button{
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:var(--orange);
  color:white;
  font-size:14px;
  cursor:pointer;
}
.empty{
  text-align:center;
  margin-top:40px;
  color:#777;
}
</style>
</head>

<body>

<header>ğŸ“„ Ø§Ù„Ø¯ÙŠÙˆÙ† (Ù…Ø¬Ù…Ù‘Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†)</header>
<div class="container" id="list"></div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";




const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com",
  projectId: "almurad-system",
  storageBucket: "almurad-system.firebasestorage.app",
  messagingSenderId: "911755824405",
  appId: "1:911755824405:web:c5520c00c11e336148ad1c"
};


const app = initializeApp(firebaseConfig);
const rtdb = getDatabase(app);


/* ========= Ø£Ø¯ÙˆØ§Øª ========= */
const f = n => Number(n || 0).toLocaleString("en-US") + " Ø¯.Ø¹";
const list = document.getElementById("list");
let invoices = [];

function loadDebts() {

  const invoicesRef = ref(rtdb, "posInvoices");

  onValue(invoicesRef, (snapshot) => {

    invoices = [];
    list.innerHTML = "";

    if (!snapshot.exists()) {
      renderDebts();
      return;
    }

    const data = snapshot.val();

    Object.entries(data).forEach(([id, inv]) => {

      if (inv.type === "credit" && inv.rest > 0) {
        invoices.push({ id, ...inv });
      }

    });

    renderDebts();
  });

}



/* ========= Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠÙˆÙ† ========= */
function renderDebts() {
  if (!invoices.length) {
    list.innerHTML = `<div class="empty">Ù…Ø§ÙƒÙˆ Ø¯ÙŠÙˆÙ† Ù…Ø³Ø¬Ù„Ø©</div>`;
    return;
  }

  const customers = {};

  invoices.forEach(inv => {
    const phone = inv.debtor?.phone || "Ø¨Ø¯ÙˆÙ†";
    if (!customers[phone]) {
      customers[phone] = {
        name: inv.debtor?.name || "Ø²Ø¨ÙˆÙ†",
        phone,
        invoices: [],
        total: 0
      };
    }
    customers[phone].invoices.push(inv);
    customers[phone].total += inv.rest;
  });

  Object.values(customers).forEach(cust => {
    const div = document.createElement("div");
    div.className = "customer";

    let invoicesHTML = "";
    cust.invoices.forEach(inv => {
      let rows = "";
      inv.items.forEach(it => {
        rows += `
          <tr>
            <td>${it.product}</td>
            <td>${it.qty}</td>
            <td>${f(it.price)}</td>
            <td>${f(it.total)}</td>
          </tr>`;
      });

      invoicesHTML += `
        <div style="margin-top:10px;border-top:1px dashed #ccc;padding-top:10px">
<b>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© #${inv.invoiceNo}</b>
<div style="font-size:12px;color:#555">
ğŸ‘¤ Ø§Ù„ÙƒØ§Ø´ÙŠØ±: ${inv.cashierId || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}
</div>


          <table>
            <tr>
              <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
            </tr>
            ${rows}
          </table>
          <div style="color:#c0392b;font-weight:bold">
            Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${f(inv.rest)}
          </div>
        </div>`;
    });

    div.innerHTML = `
      <div class="cHeader">
        <div>
          <div class="name">${cust.name}</div>
          <div class="phone">${cust.phone}</div>
        </div>
        <div class="totalDebt">${f(cust.total)}</div>
      </div>

      ${invoicesHTML}

      <div class="payBox">
        <input type="number" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯" id="pay-${cust.phone}">
        <button onclick="pay('${cust.phone}')">ØªØ³Ø¯ÙŠØ¯</button>
      </div>
    `;

    list.appendChild(div);
  });
}

/* ========= Ø§Ù„ØªØ³Ø¯ÙŠØ¯ FIFO ========= */
window.pay = async function(phone) {
  const input = document.getElementById("pay-" + phone);
  let amount = Number(input.value || 0);
  if (amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  const invs = invoices
    .filter(i => i.debtor?.phone === phone && i.rest > 0)
    .sort((a, b) => new Date(a.date) - new Date(b.date));

  for (let inv of invs) {
    if (amount <= 0) break;

    const paidNow = Math.min(amount, inv.rest);
    amount -= paidNow;

await update(ref(rtdb, "posInvoices/" + inv.id), {

      paid: (inv.paid || 0) + paidNow,
      rest: inv.rest - paidNow
    });
  }

  alert("ØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯ âœ…");
};

loadDebts();

</script>

</body>
</html>

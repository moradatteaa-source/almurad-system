<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title>

<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
}
body{
  margin:0;
  font-family:Tahoma;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:12px;
  text-align:center;
  font-size:18px;
}
.container{padding:10px;}
.box{
  background:white;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
}
h3{
  margin:5px 0;
  color:var(--blue);
  font-size:15px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{background:#eaf0f6;}
.total{
  font-weight:bold;
  color:var(--orange);
}
button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  background:var(--orange);
  color:white;
  cursor:pointer;
}
button.gray{
  background:#ccc;
  color:#333;
}
/* Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
input,
select,
textarea {
  font-size: 16px !important;
  -webkit-text-size-adjust: 100%;
}

/* ØªØ­Ø³ÙŠÙ† Ø³Ù„ÙˆÙƒ Ø§Ù„Ù„Ù…Ø³ */
html, body {
  touch-action: manipulation;
}

</style>
</head>

<body>

<header>ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</header>

<div class="container">
<h3>ğŸ‘¤ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ø´ÙŠØ±</h3>

<select id="cashierSelect">
  <option value="all">ÙƒÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª</option>
</select>

  <div class="box">
    <h3>ğŸ“… ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h3>

    <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      Ù…Ù†:
      <input type="date" id="fromDate">
      Ø¥Ù„Ù‰:
      <input type="date" id="toDate">
      <button onclick="filterByRange()">ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <hr>

    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button onclick="quickFilter('today')">Ø§Ù„ÙŠÙˆÙ…</button>
      <button onclick="quickFilter('week')">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
      <button onclick="quickFilter('month')">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
      <button onclick="quickFilter('year')">Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</button>
      <button class="gray" onclick="quickFilter('all')">Ø§Ù„ÙƒÙ„</button>
    </div>
  </div>

  <div class="box">
    <h3>ğŸ§¾ ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
    <table id="table">
      <tr>
   <th>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</th>
<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
<th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
<th>Ø§Ù„Ø¯ÙŠÙ†</th>

      </tr>
    </table>
  </div>

</div>

<script type="module">
// ===== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
const table = document.getElementById("table");
let invoices = []; // â† ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø±Ø§Ø­ ØªØ¬ÙŠ Ù…Ù† Firebase)
let cashiersMap = {};


// ===== ØªÙ†Ø³ÙŠÙ‚ Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ =====
const fmt = n => Number(n || 0).toLocaleString("en-US");
const today = () => new Date().toLocaleDateString("en-CA"); // YYYY-MM-DD
// ===== ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© =====
function toggleDetails(row, inv){

  // Ø¥Ø°Ø§ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…ÙØªÙˆØ­Ø© â†’ Ø³ÙƒÙ‘Ø±Ù‡Ø§
  if (row.nextSibling && row.nextSibling.classList?.contains("details")) {
    row.nextSibling.remove();
    return;
  }

  // Ø³ÙƒÙ‘Ø± Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø«Ø§Ù†ÙŠØ© Ù…ÙØªÙˆØ­Ø©
  document.querySelectorAll(".details").forEach(d => d.remove());

  const detailsRow = table.insertRow(row.rowIndex + 1);
  detailsRow.className = "details";

  let html = `
    <table style="width:100%;font-size:12px;margin-top:6px">
      <tr style="background:#f7f7f7">
        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
      </tr>
  `;

  (inv.items || []).forEach(it=>{
    html += `
      <tr>
        <td>${it.product}</td>
        <td>${it.qty}</td>
        <td>${fmt(it.price)} Ø¯.Ø¹</td>
        <td>${fmt(it.total)} Ø¯.Ø¹</td>
      </tr>
    `;
  });

  html += `
      <tr style="font-weight:bold;background:#eef3f7">
        <td colspan="3">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</td>
        <td>${fmt(inv.grand)} Ø¯.Ø¹</td>
      </tr>
    </table>
  `;

  detailsRow.innerHTML = `<td colspan="6">${html}</td>`;
}

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =====
function render(data){
  table.querySelectorAll("tr:not(:first-child)").forEach(r=>r.remove());

  if(!data.length){
    table.insertRow().innerHTML =
      `<td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</td>`;
    return;
  }
  

  let total=0, paid=0, debt=0;

  data.forEach(inv=>{
    total += +inv.grand;
    paid  += +inv.paid;
    debt  += +inv.rest;

const row = table.insertRow();
row.style.cursor = "pointer";

row.innerHTML = `
<td>${cashiersMap[inv.cashierId] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</td>
<td>${fmt(inv.invoiceNo)}</td>
<td>${inv.date}</td>
<td>${fmt(inv.grand)} Ø¯.Ø¹</td>
<td>${fmt(inv.paid)} Ø¯.Ø¹</td>
<td>${fmt(inv.rest)} Ø¯.Ø¹</td>
`;

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· â†’ ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„
row.onclick = () => toggleDetails(row, inv);


  });

  table.insertRow().innerHTML = `
    <td colspan="2"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</strong></td>
    <td class="total">${fmt(total)} Ø¯.Ø¹</td>
    <td class="total">${fmt(paid)} Ø¯.Ø¹</td>
    <td class="total">${fmt(debt)} Ø¯.Ø¹</td>
  `;
}

// ===== ÙÙ„ØªØ±Ø© Ù…Ù† â†’ Ø¥Ù„Ù‰ =====
function filterByRange(){
  if(!fromDate.value || !toDate.value){
    alert("Ø§Ø®ØªÙØ± ØªØ§Ø±ÙŠØ® Ù…Ù† ÙˆØ¥Ù„Ù‰");
    return;
  }
  render(invoices.filter(i =>
    i.date >= fromDate.value && i.date <= toDate.value
  ));
}

// ===== ÙÙ„Ø§ØªØ± Ø³Ø±ÙŠØ¹Ø© =====
function quickFilter(type){
  const n = new Date();
  let s,e;

  if(type==="today"){
    s = e = today();
  }
  if(type==="week"){
    const d = new Date(n.setDate(n.getDate()-n.getDay()));
    s = d.toLocaleDateString("en-CA");
    e = today();
  }
  if(type==="month"){
    s = new Date(n.getFullYear(), n.getMonth(), 1)
          .toLocaleDateString("en-CA");
    e = today();
  }
  if(type==="year"){
    s = new Date(n.getFullYear(), 0, 1)
          .toLocaleDateString("en-CA");
    e = today();
  }
  if(type==="all"){
    render(invoices);
    return;
  }

  render(invoices.filter(i => i.date >= s && i.date <= e));
}
// Ø±Ø¨Ø· Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø§Ù„Ù€ HTML
window.quickFilter = quickFilter;
window.filterByRange = filterByRange;

// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  getDoc,      // âœ… Ø£Ø¶Ù Ù‡Ø°Ø§
  doc,         // âœ… ÙˆÙ‡Ø°Ø§
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqudXSSUtolKjyN574DtiS592BKDxrrAo",
  authDomain: "al-murad-cashier.firebaseapp.com",
  projectId: "al-murad-cashier"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const cashierSelect = document.getElementById("cashierSelect");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª
async function loadCashiers(){
  const q = query(
    collection(db,"users"),
where("roles.cashier","==",true)
  );

  const snap = await getDocs(q);

  snap.forEach(d=>{
    const name = d.data().name; // âœ… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„ÙŠÙ‹Ø§

    cashiersMap[d.id] = name;

    cashierSelect.innerHTML +=
      `<option value="${d.id}">${name}</option>`;
  });
}


// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
async function loadInvoices(){
  let q = collection(db,"invoices");

  if (cashierSelect.value !== "all") {
    q = query(q, where("cashierId","==",cashierSelect.value));
  }

  const snap = await getDocs(q);
  invoices = [];
  snap.forEach(d => invoices.push(d.data()));
invoices.sort((a, b) => b.invoiceNo - a.invoiceNo);

  render(invoices);
}

cashierSelect.addEventListener("change", loadInvoices);

// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ + ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href = "index.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()){
    location.href = "dashboard.html";
    return;
  }

  const data = snap.data();
  const roles = data.roles || {};

  // âœ… Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…
  if (data.role === "admin") {
    roles.admin = true;
  }

  // âœ… Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ¯Ø®Ù„ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙØ­Øµ
  if (roles.admin) {
    loadCashiers();
    loadInvoices();
    return;
  }

  // âŒ ØºÙŠØ± Ø§Ù„Ø£Ø¯Ù…Ù†: Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…Ø­Ø§Ø³Ø¨
  if (!roles.accountant) {
    alert("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨");
    location.href = "dashboard.html";
    return;
  }

  // âœ… Ù…Ø­Ø§Ø³Ø¨ Ø¹Ø§Ø¯ÙŠ
  loadCashiers();
  loadInvoices();
});




</script>

</body>
</html>

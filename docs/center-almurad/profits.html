<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</title>

<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
}
body{
  margin:0;
  font-family:Tahoma;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:12px;
  text-align:center;
  font-size:18px;
}
.container{padding:10px;}
.box{
  background:white;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
}
label{font-size:13px}
input,button{
  padding:6px;
  margin:4px 0;
}
button{
  background:var(--orange);
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:10px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{background:#eaf0f6;}
.total{
  font-size:16px;
  font-weight:bold;
  color:var(--orange);
  text-align:center;
  margin-top:10px;
}
/* Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
input,
select,
textarea,
button {
  font-size: 16px !important;
  -webkit-text-size-adjust: 100%;
}

/* Ù…Ù†Ø¹ zoom ØºÙŠØ± Ù…Ù‚ØµÙˆØ¯ Ø¨Ø§Ù„Ù„Ù…Ø³ */
html, body {
  touch-action: manipulation;
}

</style>
</head>

<body>

<header>ğŸ’° Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</header>

<div class="container">

<div class="box">
  <label>ğŸ‘¤ Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</label>
<select id="cashierFilter">
  <option value="all">ÙƒÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª</option>
</select>
<br>

  <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
  <input type="date" id="from">
  <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
  <input type="date" id="to">
  <br>
  <button onclick="calcProfit()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
  <hr>

<button onclick="quickFilter('today')">Ø§Ù„ÙŠÙˆÙ…</button>
<button onclick="quickFilter('yesterday')">Ø£Ù…Ø³</button>
<button onclick="quickFilter('week')">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
<button onclick="quickFilter('month')">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
<button onclick="quickFilter('year')">Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</button>
<button onclick="quickFilter('all')" style="background:#ccc;color:#333">Ø§Ù„ÙƒÙ„</button>

</div>

<div class="box">
<table id="table">
  <tr>
    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</th>
    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</th>
    <th>Ø§Ù„Ø±Ø¨Ø­</th>
  </tr>
</table>

<div id="netProfit" class="total">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: 0 Ø¯.Ø¹</div>
</div>

</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
  authDomain: "almurad-system.firebaseapp.com",
  databaseURL: "https://almurad-system-default-rtdb.firebaseio.com",
  projectId: "almurad-system",
};




const app = initializeApp(firebaseConfig);
const rtdb = getDatabase(app);



// ================= ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ =================

const table = document.getElementById("table");
const netProfitEl = document.getElementById("netProfit");
let invoices = [];
let warehouse = {};
const cashierFilter = document.getElementById("cashierFilter");
loadData().then(() => calcProfit());

async function loadData(){

  // âœ… ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ù…Ù† Realtime DB
  const snap = await get(ref(rtdb, "posInvoices"));
  invoices = [];

  if (snap.exists()) {
    Object.values(snap.val()).forEach(inv => {
      invoices.push(inv);
    });
  }
// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±
cashierFilter.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª</option>`;

[...new Set(invoices.map(i => i.cashierId || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"))]
.forEach(id=>{
  cashierFilter.innerHTML += `<option value="${id}">${id}</option>`;
});

// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²Ù† (Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡) Ù…Ù† Realtime DB
const whSnap = await get(ref(rtdb, "warehouse"));
warehouse = whSnap.exists() ? whSnap.val() : {};

}
function getBuyPrice(productName){
  const p = warehouse[productName];
  return p && p.buyPrice ? Number(p.buyPrice) : 0;
}




async function calcProfit(){
  


  const from = document.getElementById("from").value;
  const to   = document.getElementById("to").value;

  table.innerHTML = `
    <tr>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</th>
      <th>Ø§Ù„Ø±Ø¨Ø­</th>
    </tr>
  `;

  let netProfit = 0;
  let found = false;

  invoices.forEach(inv=>{
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒØ§Ø´ÙŠØ±
if(cashierFilter.value !== "all"){
  if(inv.cashierId !== cashierFilter.value) return;
}

if (!inv.createdAt) return;

let invDate;

// ğŸŸ¢ Ø¥Ø°Ø§ createdAt Ø±Ù‚Ù…
if (typeof inv.createdAt === "number") {
  invDate = new Date(inv.createdAt).toLocaleDateString("en-CA");
}

// ğŸŸ¢ Ø¥Ø°Ø§ createdAt Ø¬Ø§ÙŠ Ù…Ù† serverTimestamp
else if (inv.createdAt.seconds) {
  invDate = new Date(inv.createdAt.seconds * 1000)
    .toLocaleDateString("en-CA");
}

// ğŸ›‘ Ø¥Ø°Ø§ Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
else {
  return;
}

if (from && invDate < from) return;
if (to && invDate > to) return;

    if(!inv.items) return;

    inv.items.forEach(it=>{
 const buyPrice = getBuyPrice(it.product);

      const sellTotal = Number(it.total);
const qty = Number(it.qty);

// ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹
if (qty <= 0) return;

const buyTotal  = buyPrice * qty;
const profit    = sellTotal - buyTotal;


      netProfit += profit;
      found = true;

      const r = table.insertRow();
      r.innerHTML = `
     <td>${invDate}</td>

        <td>${it.product}</td>
        <td>${it.qty}</td>
        <td>${sellTotal.toLocaleString("en-US")} Ø¯.Ø¹</td>
        <td>${buyTotal.toLocaleString("en-US")} Ø¯.Ø¹</td>
        <td>${profit.toLocaleString("en-US")} Ø¯.Ø¹</td>
      `;
    });
  });

  if(!found){
    const r = table.insertRow();
    r.innerHTML = `<td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td>`;
    netProfitEl.textContent = "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: 0 Ø¯.Ø¹";
    return;
  }

  netProfitEl.textContent =
    "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: " + netProfit.toLocaleString("en-US") + " Ø¯.Ø¹";
}
function quickFilter(type){

  const fromInput = document.getElementById("from");
  const toInput   = document.getElementById("to");
fromInput.addEventListener("change", calcProfit);
toInput.addEventListener("change", calcProfit);

  const todayDate = new Date();
  let start, end;

  if(type === "today"){
    start = end = todayDate;
  }

  if(type === "yesterday"){
    const y = new Date();
    y.setDate(y.getDate() - 1);
    start = end = y;
  }

  if(type === "week"){
    const d = new Date();
    d.setDate(d.getDate() - d.getDay());
    start = d;
    end   = todayDate;
  }

  if(type === "month"){
    start = new Date(todayDate.getFullYear(), todayDate.getMonth(), 1);
    end   = todayDate;
  }

  if(type === "year"){
    start = new Date(todayDate.getFullYear(), 0, 1);
    end   = todayDate;
  }

  if(type === "all"){
    fromInput.value = "";
    toInput.value   = "";
    calcProfit();
    return;
  }

  const fmt = d => d.toLocaleDateString("en-CA");

  fromInput.value = fmt(start);
  toInput.value   = fmt(end);

  calcProfit();
}

window.quickFilter = quickFilter;

window.calcProfit = calcProfit;

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</title>

<style>
:root{
  --blue:#043B64;
  --orange:#FF6B2D;
  --bg:#f4f6fa;
}
body{
  margin:0;
  font-family:Tahoma;
  background:var(--bg);
}
header{
  background:var(--blue);
  color:white;
  padding:12px;
  text-align:center;
  font-size:18px;
}
.container{padding:10px;}
.box{
  background:white;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
}
label{font-size:13px}
input,button{
  padding:6px;
  margin:4px 0;
}
button{
  background:var(--orange);
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:10px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{background:#eaf0f6;}
.total{
  font-size:16px;
  font-weight:bold;
  color:var(--orange);
  text-align:center;
  margin-top:10px;
}
/* Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
input,
select,
textarea,
button {
  font-size: 16px !important;
  -webkit-text-size-adjust: 100%;
}

/* Ù…Ù†Ø¹ zoom ØºÙŠØ± Ù…Ù‚ØµÙˆØ¯ Ø¨Ø§Ù„Ù„Ù…Ø³ */
html, body {
  touch-action: manipulation;
}

</style>
</head>

<body>

<header>ğŸ’° Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</header>

<div class="container">

<div class="box">
  <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
  <input type="date" id="from">
  <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
  <input type="date" id="to">
  <br>
  <button onclick="calcProfit()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
</div>

<div class="box">
<table id="table">
  <tr>
    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</th>
    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</th>
    <th>Ø§Ù„Ø±Ø¨Ø­</th>
  </tr>
</table>

<div id="netProfit" class="total">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: 0 Ø¯.Ø¹</div>
</div>

</div>

<script type="module">
  import { 
  getFirestore, 
  collection, 
  getDocs 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqudXSSUtolKjyN574DtiS592BKDxrrAo",
  authDomain: "al-murad-cashier.firebaseapp.com",
  projectId: "al-murad-cashier"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); 
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  const snap = await getDocs(collection(db, "users"));
  let currentUser = null;

  snap.forEach(d => {
    if (d.id === user.uid) currentUser = d.data();
  });

  const roles = currentUser.roles || {};

// Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯
const isAdmin =
  currentUser.role === "admin" ||
  roles.admin === true;

// Ø¥Ø°Ø§ Ù…Ùˆ Ø£Ø¯Ù…Ù† ÙˆÙ„Ø§ Ù…Ø­Ø§Ø³Ø¨ â†’ Ù…Ù…Ù†ÙˆØ¹
if (!isAdmin && !roles.accountant) {
  alert("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­");
  location.href = "dashboard.html";
}

});


// ================= ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ =================

const table = document.getElementById("table");
const netProfitEl = document.getElementById("netProfit");
let invoices = [];
let products = [];

async function loadData(){
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
  const invSnap = await getDocs(collection(db, "invoices"));
  invoices = [];
  invSnap.forEach(d => {
    invoices.push(d.data());
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  const prodSnap = await getDocs(collection(db, "products"));
  products = [];
  prodSnap.forEach(d => {
    products.push(d.data());
  });
}

function getBuyPrice(name){
  const p = products.find(x => x.name.trim() === name.trim());
  return p ? Number(p.buy) : 0;
}

async function calcProfit(){
    await loadData();
alert("Invoices: " + invoices.length + " | Products: " + products.length);

  const from = document.getElementById("from").value;
  const to   = document.getElementById("to").value;

  table.innerHTML = `
    <tr>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</th>
      <th>Ø§Ù„Ø±Ø¨Ø­</th>
    </tr>
  `;

  let netProfit = 0;
  let found = false;

  invoices.forEach(inv=>{
    if(from && inv.date < from) return;
    if(to && inv.date > to) return;
    if(!inv.items) return;

    inv.items.forEach(it=>{
      const buyPrice = getBuyPrice(it.product);
      const sellTotal = Number(it.total);
      const buyTotal  = buyPrice * Number(it.qty);
      const profit    = sellTotal - buyTotal;

      netProfit += profit;
      found = true;

      const r = table.insertRow();
      r.innerHTML = `
        <td>${inv.date}</td>
        <td>${it.product}</td>
        <td>${it.qty}</td>
        <td>${sellTotal.toLocaleString("en-US")} Ø¯.Ø¹</td>
        <td>${buyTotal.toLocaleString("en-US")} Ø¯.Ø¹</td>
        <td>${profit.toLocaleString("en-US")} Ø¯.Ø¹</td>
      `;
    });
  });

  if(!found){
    const r = table.insertRow();
    r.innerHTML = `<td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td>`;
    netProfitEl.textContent = "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: 0 Ø¯.Ø¹";
    return;
  }

  netProfitEl.textContent =
    "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: " + netProfit.toLocaleString("en-US") + " Ø¯.Ø¹";
}
window.calcProfit = calcProfit;

</script>

</body>
</html>

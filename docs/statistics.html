<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>

  <!-- Ø®Ø· Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù„ÙŠ Ø·Ù„Ø¨ØªÙ‡ -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js (Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --main-blue:#043B64;
      --accent:#FF6B2D;
      --card-bg:#ffffff;
      --muted:#6b7280;
      --surface:#f5f6fa;
    }
    body{font-family:'Tajawal',sans-serif;background:var(--surface);margin:0;color:#222}
    header{background:var(--main-blue);color:#fff;padding:14px 18px;text-align:center;font-weight:700}
    .container{max-width:1200px;margin:20px auto;padding:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .controls select, .controls input[type="date"], .controls button {padding:8px 10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    .controls button {background:var(--main-blue);color:#fff;border:0;cursor:pointer}
    .controls .preset {background:transparent;color:var(--main-blue);border:1px solid #ddd;cursor:pointer}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:18px}
    .card {background:var(--card-bg);padding:16px;border-radius:10px;box-shadow:0 4px 12px rgba(6,21,34,0.04);text-align:center}
    .card h3{margin:0;color:var(--main-blue);font-size:15px}
    .card p{margin:6px 0 0;font-size:20px;font-weight:700}
    .charts {display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full {grid-column:1/-1}
    canvas{background:#fff;border-radius:8px;padding:8px}
    .table-wrap{margin-top:18px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 14px rgba(6,21,34,0.04)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    th{background:#f8fafc;color:var(--main-blue)}
    .small{font-size:12px;color:var(--muted)}
    @media(max-width:900px){ .charts {grid-template-columns:1fr} }
    .toolbar {display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .export-btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>ğŸ“Š ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</header>

  <div class="container">
    <!-- ÙÙ„ØªØ±Ø© + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="controls">
      <div class="toolbar">
        <label class="small">Ù…Ù†:</label>
        <input type="date" id="fromDate">
        <label class="small">Ø¥Ù„Ù‰:</label>
        <input type="date" id="toDate">
        <select id="statusFilter" title="ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©">
          <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <!-- Ø­Ø§Ù„Ø§Øª Ø³ØªÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </select>

        <select id="granularity" title="Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø²Ù…Ù†ÙŠ">
          <option value="day">ÙŠÙˆÙ…ÙŠ</option>
          <option value="week">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
          <option value="month" selected>Ø´Ù‡Ø±ÙŠ</option>
          <option value="all">Ø§Ù„ÙƒÙ„</option>
        </select>

        <button id="applyBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
        <button class="preset" id="todayBtn">Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="preset" id="weekBtn">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</button>
        <button class="preset" id="monthBtn">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</button>
        <button class="preset" id="allBtn">Ø§Ù„ÙƒÙ„</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¸Ø§Ù‡Ø±Ø©: <span id="shownCount">0</span></div>
        <button class="export-btn" id="downloadCsv">ØªØ­Ù…ÙŠÙ„ CSV</button>
      </div>
    </div>

    <!-- Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© -->
<!-- Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© + Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ -->
<div id="summary" class="grid"></div>

<!-- ğŸ§® Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ -->
<div id="totalCard" class="card" style="
  margin-top: 10px;
  background: #043B64;
  color: white;
  font-weight: bold;
  text-align: center;
  font-size: 18px;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
">
  ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©: <span id="totalOrders">0</span>
</div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts">
      <div class="card">
        <h3>ğŸ“ˆ ØªØ·ÙˆØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h3>
        <canvas id="chartLine" height="160"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
        <canvas id="chartDonut" height="160"></canvas>
      </div>

      <div class="card full">
        <h3>ğŸ›’ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹ (Top 10)</h3>
        <canvas id="chartBar" height="160"></canvas>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ù„Ù„ÙÙ„ØªØ±Ø© ÙƒÙ„Ù‡Ø§) -->
    <div class="table-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯)</div>
        <div class="muted small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„</div>
      </div>
      <div style="overflow:auto;max-height:420px">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ÙƒÙˆØ¯</th>
              <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
              <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø§Ù„Ù…Ø¹Ù„Ù†</th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª: Firebase + Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <script type="module">
    // ----- ØªÙ‡ÙŠØ¦Ø© Firebase (Ù†ÙØ³ config Ø¹Ù†Ø¯Ùƒ) -----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, get, onValue, child } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ----- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -----
    const fromDateEl = document.getElementById('fromDate');
    const toDateEl = document.getElementById('toDate');
    const applyBtn = document.getElementById('applyBtn');
    const statusFilter = document.getElementById('statusFilter');
    const granularityEl = document.getElementById('granularity');
    const summaryEl = document.getElementById('summary');
    const shownCountEl = document.getElementById('shownCount');
    const ordersTbody = document.getElementById('ordersTbody');
    const downloadCsvBtn = document.getElementById('downloadCsv');

    // Charts
    let chartLine = null, chartDonut = null, chartBar = null;

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù†Ø¶ÙŠÙ Ø­Ø§Ù„Ø§ØªÙƒ Ù…Ø¹ "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹")
    const defaultStatuses = ["", "Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø±Ø§Ø¬Ø¹", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹", "Ø±ÙØ¶"];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Firebase (Ù…Ø¨Ø§Ø´Ø±ØŒ ÙˆÙ†Ø³ØªØ®Ø¯Ù… onValue Ù„ÙƒÙŠ ØªØªØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
const ordersRef = ref(db, 'orders');

// ğŸ§© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡
const loggedUser = JSON.parse(localStorage.getItem("loggedInUser")) || {};
const roles = loggedUser.roles || [];
const currentName = loggedUser.name || loggedUser.username || loggedUser.user || "";
console.log("ğŸ§¾ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù…Ù„Ø©:", loggedUser);

let allOrders = [];

// âœ… Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ†ØªØ§Ø¨Ø¹Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Firebase
onValue(ordersRef, (snap) => {
  if (!snap.exists()) {
    allOrders = [];
    renderAll([]);
    return;
  }

  const obj = snap.val();
  let ordersArray = Object.entries(obj).map(([id, val]) => ({ id, ...val }));

 if (roles.includes("stabilizer") && !roles.includes("admin")) {
  ordersArray = ordersArray.filter(o => {
    const fixed = (o.fixedBy || "").trim();
    return fixed &&
      (
        fixed === currentName.trim() ||
        fixed === (loggedUser.username || "").trim() ||
        fixed === (loggedUser.name || "").trim() ||
        fixed.includes(currentName.trim()) || // Ø¯Ø¹Ù… Ø¬Ø²Ø¦ÙŠ (Ù…Ø«Ù„Ø§Ù‹ "Ù…Ø±Ø§Ø¯ Ø§Ù„ÙƒØ§ÙÙŠ" ÙŠØ­ØªÙˆÙŠ "Ù…Ø±Ø§Ø¯")
        currentName.trim().includes(fixed)
      );
  });
}

  // ğŸš« Ø¥Ø°Ø§ Ø§Ù„Ù…Ø«Ø¨Øª Ù…Ø§ Ø¹Ù†Ø¯Ù‡ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª
if (roles.includes("stabilizer") && ordersArray.length === 0) {
  document.querySelector(".container").innerHTML = `
    <div style="
      text-align:center;
      margin-top:120px;
      font-size:20px;
      color:#043B64;
      font-weight:bold;
    ">
      ğŸš« Ù…Ø§ÙƒÙˆ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯ØŒ Ø«Ø¨Ù‘Øª Ø·Ù„Ø¨Ø§Øª ÙˆØ²ÙŠØ¯ Ø£Ø±Ø¨Ø§Ø­Ùƒ ğŸ”¥
    </div>
  `;
  return; // Ù†ÙˆÙ‚Ù Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯
}


  allOrders = ordersArray;
  populateStatusFilter();
  applyFiltersAndRender();
});



    // Ù…Ù„Ø¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª
    function populateStatusFilter() {
      const found = new Set(defaultStatuses);
      allOrders.forEach(o => {
        const st = (o.status || "").toString().trim();
        if (st) found.add(st);
      });
      // Ø§ÙØ±Ø§Øº Ø§Ù„Ø¹Ù†ØµØ± Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¦Ù‡
      statusFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>';
      Array.from(found).forEach(s => {
        // Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§Ø±ØºØ© Ù…Ø±ØªÙŠÙ†
        if (s === "") return;
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        statusFilter.appendChild(opt);
      });
    }

    // Ù…Ø³Ø§Ø¹Ø¯ Ù„ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ø±ÙŠØ®
    function toDateObj(d) {
      if (!d) return null;
      // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ§Ø±ÙŠØ® ISO
      const n = new Date(d);
      if (!isNaN(n)) return n;
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… (timestamp)
      const t = Number(d);
      if (!isNaN(t)) return new Date(t);
      return null;
    }

    // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ùˆ Ø§Ù„Ø±Ù†Ø¯Ø±
    function applyFiltersAndRender() {
      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙÙ„Ø§ØªØ±
      const fromVal = fromDateEl.value ? new Date(fromDateEl.value + 'T00:00:00') : null;
      const toVal = toDateEl.value ? new Date(toDateEl.value + 'T23:59:59') : null;
      const statusVal = statusFilter.value;
      const gran = granularityEl.value;

      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø­Ø§Ù„Ø©
      const filtered = allOrders.filter(o => {
        const dt = toDateObj(o.orderDate) || toDateObj(o.createdAt) || new Date();
        if (!dt) return false;
        if (fromVal && dt < fromVal) return false;
        if (toVal && dt > toVal) return false;
        if (statusVal && ((o.status||'').toString().trim() !== statusVal)) return false;
        return true;
      });

      renderAll(filtered, gran);
    }

    // renderAll: ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
    function renderAll(filtered, granularity = 'month') {
      // --- Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ø­Ø§Ù„Ø© (Ù†Ø­Ø³Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©) ---
      const statusCounts = {};
      // Ù†Ø¶Ù…Ù† Ø£Ù† ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
      defaultStatuses.forEach(s => statusCounts[s] = 0);

      filtered.forEach(o => {
        const st = (o.status || '').toString().trim();
        statusCounts[st] = (statusCounts[st] || 0) + 1;
      });

      // render summary
      summaryEl.innerHTML = '';
      Object.keys(statusCounts).forEach(key => {
        // skip empty key if you want rename: show as "Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©"
        const label = (key === "" ? "Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" : key);
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<h3>${label}</h3><p>${statusCounts[key] || 0}</p>`;
        summaryEl.appendChild(div);
      });

      // --- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) ---
      ordersTbody.innerHTML = '';
      filtered.sort((a,b) => {
        const da = toDateObj(a.orderDate) || new Date(0);
        const db = toDateObj(b.orderDate) || new Date(0);
        return db - da; // ØªØµØ§Ø¹Ø¯ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      }).forEach((o, idx) => {
        const tr = document.createElement('tr');
        const dt = toDateObj(o.orderDate);
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${o.code || '-'}</td>
          <td>${(o.productName || o.product) || '-'}</td>
          <td>${o.price || 0}</td>
          <td>${o.quantity || 0}</td>
          <td>${o.phone1 || o.phone || '-'}</td>
          <td>${o.city || '-'}</td>
          <td>${o.area || '-'}</td>
          <td>${o.status || '-'}</td>
          <td>${dt ? dt.toLocaleString() : '-'}</td>
          <td>${o.advertiser || '-'}</td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => openInlineDetails(o));
        ordersTbody.appendChild(tr);
      });

      shownCountEl.textContent = filtered.length;
document.getElementById("totalOrders").textContent = filtered.length;

      // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
      buildCharts(filtered, statusCounts, granularity);
    }

    // ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø³ÙŠØ·
    function openInlineDetails(order) {
      const overlay = document.createElement('div');
      Object.assign(overlay.style, {
        position:'fixed',left:0,top:0,right:0,bottom:0,background:'rgba(0,0,0,0.4)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:99999
      });
      const box = document.createElement('div');
      Object.assign(box.style, {background:'#fff',padding:'18px',borderRadius:'10px',minWidth:'300px',maxWidth:'720px',direction:'rtl',textAlign:'right',maxHeight:'90%',overflow:'auto'});
      const dt = toDateObj(order.orderDate);
      box.innerHTML = `
        <h3 style="margin-top:0;color:${getComputedStyle(document.documentElement).getPropertyValue('--main-blue') || '#043B64'}">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <p><b>Ø§Ù„ÙƒÙˆØ¯:</b> ${order.code || '-'}</p>
        <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${(order.productName || order.product) || '-'}</p>
        <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${order.quantity || '-'}</p>
        <p><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${order.price || '-'}</p>
        <p><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${order.phone1 || order.phone || '-'}</p>
        <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${(order.city||'-') + ' - ' + (order.area||'-')}</p>
        <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${order.status || '-'}</p>
        <p><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</b> ${dt ? dt.toLocaleString() : '-'}</p>
        <p><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${order.notes || '-'}</p>
        <div style="text-align:center;margin-top:12px"><button id="closeDetails" style="background:var(--main-blue);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button></div>
      `;
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      document.getElementById('closeDetails').addEventListener('click', () => overlay.remove());
      
    }

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    function buildCharts(filtered, statusCounts, granularity) {
      // --- Ø®Ø· ØªØ·ÙˆØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ø£Ùˆ Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹/Ø§Ù„Ø´Ù‡Ø±) ---
      const salesByDate = {}; // key -> Ù…Ø¨Ù„Øº Ø¥Ø¬Ù…Ø§Ù„ÙŠ
      const profitByDate = {}; // Ù…Ø«Ø§Ù„: ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø±Ø¨Ø­ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¥Ù† Ø£Ø±Ø¯Øª
      const qtyByProduct = {};
      const returnsByProduct = {};

      filtered.forEach(o => {
        const dt = toDateObj(o.orderDate) || new Date();
        // Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ granularity
        let key;
        if (granularity === 'day') key = dt.toISOString().split('T')[0];
        else if (granularity === 'week') {
          const start = new Date(dt); // Ø­Ø³Ø§Ø¨ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…Ø«Ù„Ø§Ù‹)
          const day = start.getDay(); // 0..6
          const diff = start.getDate() - day + (day === 0 ? -6 : 1); // Ø§Ù„Ø§Ø«Ù†ÙŠÙ† ÙƒØ¨Ø¯Ø§ÙŠØ©
          start.setDate(diff);
          key = start.toISOString().split('T')[0];
        } else if (granularity === 'month') {
          key = dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
        } else key = dt.toISOString().split('T')[0];

        const price = Number(o.price || 0);
        const qty = Number(o.quantity || 0);

        salesByDate[key] = (salesByDate[key] || 0) + price;
        // profitByDate[key] = (profitByDate[key] || 0) + (price - 4000); // Ù…Ø«Ø§Ù„
        const prod = (o.productName || o.product || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ').toString();
        if ((o.status||'').toString().trim() === 'Ø±Ø§Ø¬Ø¹') returnsByProduct[prod] = (returnsByProduct[prod] || 0) + qty;
        else qtyByProduct[prod] = (qtyByProduct[prod] || 0) + qty;
      });

      // Line chart data (sorted keys)
      const labelsLine = Object.keys(salesByDate).sort();
      const dataLine = labelsLine.map(k => salesByDate[k]);

      // Donut chart for statuses
      const statusLabels = Object.keys(statusCounts).filter(k => k !== undefined);
      const statusValues = statusLabels.map(k => statusCounts[k] || 0);

      // Top products
      const topProducts = Object.entries(qtyByProduct).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const topLabels = topProducts.map(p=>p[0]);
      const topValues = topProducts.map(p=>p[1]);

      // --- render or update charts ---
      const ctxLine = document.getElementById('chartLine').getContext('2d');
      if (chartLine) chartLine.destroy();
      chartLine = new Chart(ctxLine, {
        type: 'line',
        data: { labels: labelsLine, datasets: [{ label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', data: dataLine, borderColor: '#043B64', backgroundColor:'rgba(4,59,100,0.08)', fill:true, tension:0.2 }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });

      const ctxDonut = document.getElementById('chartDonut').getContext('2d');
      if (chartDonut) chartDonut.destroy();
      chartDonut = new Chart(ctxDonut, {
        type: 'doughnut',
        data: { labels: statusLabels.map(k => k==='' ? 'Ø¬Ø¯ÙŠØ¯Ø©' : k), datasets:[{ data: statusValues, backgroundColor: ['#6C757D','#0D6EFD','#198754','#FFC107','#FF6B2D','#17A2B8','#28A745','#EF476F','#5D3FD3','#D6336C'] }] },
        options: { responsive:true, plugins:{legend:{position:'right'}} }
      });

      const ctxBar = document.getElementById('chartBar').getContext('2d');
      if (chartBar) chartBar.destroy();
      chartBar = new Chart(ctxBar, {
        type: 'bar',
        data: { labels: topLabels, datasets:[{ label:'Ø§Ù„ÙƒÙ…ÙŠØ©', data: topValues, backgroundColor: '#FF6B2D' }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // event listeners Ù„Ù„ÙÙ„Ø§ØªØ± Ùˆ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª
    applyBtn.addEventListener('click', () => applyFiltersAndRender());
    document.getElementById('todayBtn').addEventListener('click', ()=> {
      const d = new Date(); fromDateEl.value = d.toISOString().split('T')[0]; toDateEl.value = d.toISOString().split('T')[0];
      applyFiltersAndRender();
    });
    document.getElementById('weekBtn').addEventListener('click', ()=> {
      const to = new Date(); const from = new Date(); from.setDate(to.getDate()-6);
      fromDateEl.value = from.toISOString().split('T')[0]; toDateEl.value = to.toISOString().split('T')[0];
      applyFiltersAndRender();
    });
    document.getElementById('monthBtn').addEventListener('click', ()=> {
      const to = new Date(); const from = new Date(); from.setDate(to.getDate()-29);
      fromDateEl.value = from.toISOString().split('T')[0]; toDateEl.value = to.toISOString().split('T')[0];
      applyFiltersAndRender();
    });
    document.getElementById('allBtn').addEventListener('click', ()=> {
      fromDateEl.value = ''; toDateEl.value = ''; applyFiltersAndRender();
    });

    // ØªØ­Ù…ÙŠÙ„ CSV Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
    downloadCsvBtn.addEventListener('click', () => {
      // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const rows = Array.from(document.querySelectorAll('#ordersTbody tr')).map(tr => {
        return Array.from(tr.children).map(td => td.textContent.trim().replace(/\n/g,' '));
      });
      if (!rows.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
      let csv = 'Ø±Ù‚Ù…,ÙƒÙˆØ¯,Ù…Ù†ØªØ¬,Ø³Ø¹Ø±,ÙƒÙ…ÙŠØ©,Ù‡Ø§ØªÙ,Ù…Ø¯ÙŠÙ†Ø©,Ù…Ù†Ø·Ù‚Ø©,Ø­Ø§Ù„Ø©,ØªØ§Ø±ÙŠØ®,Ù…Ø¹Ù„Ù†\n';
      rows.forEach(r => { csv += r.join(',') + '\n'; });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'orders_stats.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©: Ù†Ø¹Ø±Ø¶ "Ø§Ù„ÙƒÙ„" Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡
    // (onValue Ø³ÙŠØ³ØªØ¯Ø¹ÙŠ applyFiltersAndRender Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
  </script>
</body>
</html>


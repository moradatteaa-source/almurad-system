<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù†ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #043B64;
      --orange: #FF6B2D;
      --bg: #f4f6fa;
    }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg);
      color: var(--blue);
      margin: 0;
      padding: 0;
    }
    header {
      background: var(--blue);
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      max-width: 1250px;
      margin: 25px auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    select, input[type=date], input[type=number], button {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Tajawal';
      font-size: 14px;
    }
    button {
      background: var(--blue);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: var(--orange); }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .card {
      background: var(--bg);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin: 0;
      font-size: 15px;
      color: var(--blue);
    }
    .card p {
      font-size: 20px;
      font-weight: bold;
      color: var(--orange);
      margin: 5px 0 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: center;
    }
    th {
      background: var(--blue);
      color: white;
      position: sticky;
      top: 0;
    }
    .section-title {
      margin: 20px 0 10px;
      color: var(--blue);
      font-weight: bold;
    }
    @media(max-width:900px) {
      .filters { flex-direction: column; align-items: flex-start; }
    }
    /* âœ… ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
.dropdown { position: relative; display: inline-block; }
.dropbtn {
  background: var(--blue);
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Tajawal';
}
.dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 180px;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  z-index: 5;
}
.dropdown-content label {
  display: block;
  margin: 4px 0;
  cursor: pointer;
}
.dropdown:hover .dropdown-content {
  display: block;
}
#productDropdown {
  max-height: 250px;
  overflow-y: auto;
}
#productSearch {
  font-family: 'Tajawal';
  font-size: 13px;
}

  </style>
</head>
<body>
  <header>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù†ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</header>
  <div class="container">

    <div class="filters">
      <select id="advertiserSelect"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù†ÙŠÙ†</option></select>
<div class="dropdown">
  <button class="dropbtn">ğŸ§¾ Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
  <div class="dropdown-content" id="statusCheckboxes">
    <label><input type="checkbox" id="selectAllStatuses"> âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
    <label><input type="checkbox" value="Ù…Ø«Ø¨Øª"> Ù…Ø«Ø¨Øª</label>
    <label><input type="checkbox" value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"> Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</label>
    <label><input type="checkbox" value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"> ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
    <label><input type="checkbox" value="Ø±Ø§Ø¬Ø¹"> Ø±Ø§Ø¬Ø¹</label>
    <label><input type="checkbox" value="ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"> ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹</label>
    <label><input type="checkbox" value="Ø±ÙØ¶"> Ø±ÙØ¶</label>
  </div>
</div>


<div class="dropdown">
  <button class="dropbtn">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <div class="dropdown-content" id="productDropdown">
    <input type="text" id="productSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." style="width:100%;padding:6px 8px;margin-bottom:8px;border:1px solid #ccc;border-radius:6px;">
    <label><input type="checkbox" id="selectAllProducts"> âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
    <div id="productCheckboxes"></div>
  </div>
</div>

      <input type="date" id="fromDate">
      <input type="date" id="toDate">
      <input type="number" id="adCost" placeholder="ğŸ’¸ ÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" min="0" style="width:140px">
      <button id="applyBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      <button id="exportExcel">ğŸ“ ØªØµØ¯ÙŠØ± Excel</button>
    </div>

    <div class="cards">
      <div class="card"><h3>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><p id="totalOrders">0</p></div>
      <div class="card"><h3>âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</h3><p id="deliveredCount">0</p></div>
      <div class="card"><h3>â†©ï¸ Ø§Ù„Ø±Ø§Ø¬Ø¹</h3><p id="returnedCount">0</p></div>
      <div class="card"><h3>ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©</h3><p id="totalSales">0</p></div>
      <div class="card"><h3>ğŸ’µ ÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡</h3><p id="totalBuy">0</p></div>
      <div class="card"><h3>ğŸšš ÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„</h3><p id="deliveryCost">0</p></div>
      <div class="card"><h3>ğŸ“£ ÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</h3><p id="adCostDisplay">0</p></div>
      <div class="card"><h3>ğŸ“ˆ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</h3><p id="profit">0</p></div>
    </div>

    <h3 class="section-title">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <div style="overflow:auto;max-height:400px">
      <table id="ordersTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø¹Ù„Ù†</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
    authDomain: "almurad-system.firebaseapp.com",
    databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
    projectId: "almurad-system",
    storageBucket: "almurad-system.appspot.com",
    messagingSenderId: "911755824405",
    appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const advertiserSelect = document.getElementById("advertiserSelect");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const tbody = document.querySelector("#ordersTable tbody");

  let allOrders = [], warehouse = {};
// âœ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¨Ø¶ØºØ·Ø© ÙˆØ§Ø­Ø¯Ø©
document.addEventListener("change", (e) => {
  if (e.target.id === "selectAllStatuses") {
    const checkAll = e.target.checked;
    document.querySelectorAll("#statusCheckboxes input[type='checkbox']").forEach(c => {
      if (c.id !== "selectAllStatuses") c.checked = checkAll;
    });
    applyFilter();
  }
});

  async function loadData() {
    const ordersSnap = await get(ref(db, "orders"));
    if (ordersSnap.exists()) allOrders = Object.values(ordersSnap.val());
    const warehouseSnap = await get(ref(db, "warehouse"));
    if (warehouseSnap.exists()) warehouse = warehouseSnap.val();
    populateAdvertisers();
    applyFilter();
  }

  function populateAdvertisers() {
    const advs = [...new Set(allOrders.map(o => o.advertiser || "").filter(Boolean))];
    advertiserSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù†ÙŠÙ†</option>' + advs.map(a => `<option>${a}</option>`).join('');
  }

  document.getElementById("applyBtn").onclick = applyFilter;
  document.getElementById("adCost").oninput = applyFilter;
function populateProductsForAdvertiser() {
  const adv = advertiserSelect.value;
  const products = allOrders
    .filter(o => !adv || o.advertiser === adv)
    .flatMap(o => (o.productName || "").split("ØŒ").map(x => x.trim()))
    .filter(Boolean);

  const uniqueProducts = [...new Set(products)];

  const productContainer = document.getElementById("productCheckboxes");
  productContainer.innerHTML = uniqueProducts.length
    ? uniqueProducts.map(p => `<label><input type="checkbox" value="${p}"> ${p}</label>`).join('')
    : "<p style='font-size:13px;color:#777;text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>";

  // Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
  document.getElementById("selectAllProducts").checked = false;
}
// âœ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¶ØºØ·Ø© ÙˆØ§Ø­Ø¯Ø©
document.addEventListener("change", (e) => {
  if (e.target.id === "selectAllProducts") {
    const checkAll = e.target.checked;
    document.querySelectorAll("#productCheckboxes input[type='checkbox']").forEach(c => c.checked = checkAll);
    applyFilter();
  }
});

// âœ… Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
document.getElementById("productSearch").addEventListener("input", (e) => {
  const search = e.target.value.trim();
  document.querySelectorAll("#productCheckboxes label").forEach(label => {
    const text = label.textContent.trim();
    label.style.display = text.includes(search) ? "block" : "none";
  });
});

advertiserSelect.onchange = () => {
  populateProductsForAdvertiser();
  applyFilter();
};

  function applyFilter() {
    const adv = advertiserSelect.value;
const statusFilter = Array.from(document.querySelectorAll("#statusCheckboxes input:checked")).map(c => c.value);
const selectedProducts = Array.from(document.querySelectorAll("#productCheckboxes input:checked")).map(c => c.value);
    const adCost = Number(document.getElementById("adCost").value) || 0;
    const f = fromDate.value ? new Date(fromDate.value) : null;
    const t = toDate.value ? new Date(toDate.value + "T23:59:59") : null;

    let filtered = allOrders.filter(o => {
      if (adv && o.advertiser !== adv) return false;
if (statusFilter.length && !statusFilter.includes(o.status)) return false;
  // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ ØªØ§Ù… (Ù…Ø§ ØªØ·Ù„Ø¹ Ø¥Ù„Ø§ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø·)
  if (selectedProducts.length) {
    const orderProducts = (o.productName || "").split("ØŒ").map(x => x.trim());
    const match = orderProducts.some(prod => selectedProducts.includes(prod));
    if (!match) return false;
  }

if (
  selectedProducts.length &&
  !selectedProducts.some(p =>
    (o.productName || "")
      .split("ØŒ")              // ØªÙØµÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨
      .map(x => x.trim())      // ØªØ´ÙŠÙ„ Ø§Ù„ÙØ±Ø§ØºØ§Øª
      .includes(p)             // ØªØ·Ø§Ø¨Ù‚ ØªØ§Ù… Ù„Ù„Ø§Ø³Ù…
  )
) return false;
      const d = new Date(o.orderDate || o.createdAt || Date.now());
      if (f && d < f) return false;
      if (t && d > t) return false;
      return true;
    });

    if (!filtered.length) {
      tbody.innerHTML = "<tr><td colspan='8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±Ø©</td></tr>";
      updateCards({});
      return;
    }

    const deliveryPerOrder = 4250;
    let totalSales = 0, totalBuy = 0, delivered = 0, returned = 0, totalOrders = filtered.length;
    let rows = "";

    filtered.forEach((order, i) => {
  const status = order.status || "-";
  if (status.includes("Ø±Ø§Ø¬Ø¹")) returned++;
  if (status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") delivered++;

  const names = (order.productName || "").split("ØŒ").map(s => s.trim()).filter(Boolean);
  const unique = [...new Set(names)];

  unique.forEach(p => {
    const qty = Number(order.quantity || 0) / unique.length;
    const buy = warehouse[p]?.buyPrice || 0;
    // âœ… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ù†ÙØ³Ù‡
    const unitSell = (Number(order.price) || 0) / (Number(order.quantity) || 1);
    const saleVal = (status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") ? qty * unitSell : 0;
    const buyVal = qty * buy;

    totalSales += saleVal;
    totalBuy += buyVal;

    rows += `<tr>
      <td>${i + 1}</td>
      <td>${order.advertiser || "-"}</td>
      <td>${p}</td>
      <td>${formatNumber(qty)}</td>
      <td>${formatNumber(unitSell.toFixed(0))}</td>
      <td>${formatNumber(buy)}</td>
      <td>${status}</td>
      <td>${new Date(order.orderDate).toLocaleDateString('en-GB')}</td>
    </tr>`;
  });
});


    const deliveryCost = totalOrders * deliveryPerOrder;
    const profit = totalSales - totalBuy - deliveryCost - adCost;

    tbody.innerHTML = rows;
    updateCards({ totalOrders, delivered, returned, totalSales, totalBuy, deliveryCost, adCost, profit });
  }
// âœ… Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ Ù…Ø¹ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ
function formatNumber(num) {
  return Number(num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
}

  function updateCards(v) {
  document.getElementById("totalOrders").textContent = formatNumber(v.totalOrders || 0);
  document.getElementById("deliveredCount").textContent = formatNumber(v.delivered || 0);
  document.getElementById("returnedCount").textContent = formatNumber(v.returned || 0);
  document.getElementById("totalSales").textContent = formatNumber(v.totalSales || 0);
  document.getElementById("totalBuy").textContent = formatNumber(v.totalBuy || 0);
  document.getElementById("deliveryCost").textContent = formatNumber(v.deliveryCost || 0);
  document.getElementById("adCostDisplay").textContent = formatNumber(v.adCost || 0);
  document.getElementById("profit").textContent = formatNumber(v.profit || 0);
}


  // âœ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø¨ØµÙŠØºØ© Ø³Ù„ÙŠÙ…Ø© (XLSX)
  document.getElementById("exportExcel").onclick = () => {
    const table = document.getElementById("ordersTable");
    let html = '<table border="1">' + table.innerHTML + '</table>';
    const blob = new Blob([`\uFEFF${html}`], { type: "application/vnd.ms-excel" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "advertisers_stats.xls";
    a.click();
  };

  loadData();
</script>
</body>
</html>

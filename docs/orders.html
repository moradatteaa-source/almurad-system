<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0, minimum-scale=0.2, user-scalable=yes">
  <title>Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯</title>
  <style>
html, body {
  touch-action: auto !important; /* ğŸ”¥ Ø§Ù„Ø³Ù…Ø§Ø­ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù€ pinch zoom */
  -ms-touch-action: auto;
  overflow: auto !important;
  overscroll-behavior: contain;
}


/* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù„Ù„ÙŠØ³Ø§Ø± */
.table-container table {
  margin-right: 0;
  margin-left: auto;
}





/* âœ… Ù…Ù†Ø¹ ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ input ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
input, select, textarea, button {
  font-size: 16px !important;
  touch-action: manipulation;
}

    body {
      font-family: Tahoma, Arial;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }

    header {
      background: #043B64;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 18px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    .back-btn {
      background: #043B64;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .delete-btn {
      background: #d93025;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .search-bar {
      text-align: center;
      margin: 10px 0 15px;
    }
    .search-bar input {
      width: 60%;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }




table {
  width: max-content;
  min-width: 100%;
  transform-origin: 0 0;
  touch-action: pan-x pan-y;
}

body {
  transform-origin: 0 0;
  touch-action: pan-x pan-y pinch-zoom !important; /* ğŸ”¥ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø­Ø± */
}

thead th {
  position: sticky;
  top: 0;
  background: #043B64;
  color: white;
  z-index: 10;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}



    table {
      width: max-content;
      min-width: 1400px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
    }
    th { background: #043B64; color: white; }
    tr:hover { background: #f9fafb; }
    input, select, textarea {
      font-size: 12px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    textarea { resize: vertical; height: 40px; }
    button {
      background: #FF6B2D;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* ğŸ”¸ Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
input, select, textarea {
  font-size: 16px !important;
}

    button:hover { opacity: 0.9; }
    /* ğŸ”½ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£ÙˆØ§Ù…Ø± */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ffffff;
  min-width: 200px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  border-radius: 6px;
  z-index: 9999;
  right: 0;
  top: 40px;
}

.dropdown-content button {
  background: none;
  color: #333;
  border: none;
  padding: 10px 15px;
  text-align: right;
  width: 100%;
  font-size: 13px;
  cursor: pointer;
}

.dropdown-content button:hover {
  background-color: #f1f1f1;
}

/* ğŸ”¸ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.show {
  display: block;
}
/* ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù„ÙˆÙŠ Ø£Ù†ÙŠÙ‚ */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #FF6B2D;
  color: #fff;
  padding: 14px 22px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
  font-family: 'Tajawal', sans-serif;
  font-size: 16px;
  z-index: 9999;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.notification.show {
  opacity: 1;
  transform: translateY(0);
}
@media (max-width: 768px) {
  input, select, textarea, button {
    font-size: 16px !important;
    touch-action: manipulation;
  }
}

/* ğŸ‘‡ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ®Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù„Ù…Ø³ ÙƒØ£Ù†Ù‡ Google Sheets */
table {
  width: max-content;
  min-width: 100%;
  border-collapse: collapse;
  transform-origin: 0 0;
}


/* âœ… Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ â€” Ø³Ù‡Ù… ØµØºÙŠØ± Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© */
#loadMoreBtn {
  position: fixed;
  bottom: 15px;
  left: 15px;
  width: 40px;
  height: 40px;
  background: #043B64;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 20px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  z-index: 999;
  transition: all 0.2s ease;
  opacity: 0.9;
}


#loadMoreBtn:hover {
  background: #022d4b;
  opacity: 1;
  transform: scale(1.1);
}

.table-container table {
  margin: 0; /* Ø«Ø§Ø¨Øª Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø· */
}
/* âœ… ØªØ«Ø¨ÙŠØª Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
td:first-child, th:first-child {
  position: sticky;
  left: 0;
  background: white;
  z-index: 30;
}

/* ğŸ¯ ØªØ«Ø¨ÙŠØª Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ³Ù„Ø³Ù„ (#) ÙŠÙ…ÙŠÙ† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
td:nth-child(2), th:nth-child(2) {
  position: sticky;
  left: 60px;
  background: white;
  z-index: 29;
}

/* ğŸ¯ ØªØ«Ø¨ÙŠØª Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ) */
thead th {
  position: sticky;
  top: 0;
  background: #043B64;
  color: white;
  z-index: 40;
}
/* ğŸ”µ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ â€” Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ */
.table-container {
  position: relative;
  width: 100%;
  overflow: auto;
  background: white;
  border-radius: 10px;
  touch-action: pan-x pan-y pinch-zoom !important;
}


/* ğŸŸ  Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù†ÙØ³Ù‡ ÙŠØ¨Ù‚Ù‰ Ø«Ø§Ø¨Øª ÙŠÙ…ÙŠÙ† ÙˆÙÙˆÙƒ Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ¨ÙŠØ± */
.table-container table {
  transform-origin: top right !important;
  transition: transform 0.15s ease-out;
  margin: 0; /* Ù…Ù‡Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ */
}

/* ğŸŸ¢ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø£Ø³ */
thead th {
  position: sticky;
  top: 0;
  z-index: 50;
  background: #043B64;
  color: white;
}

/* ğŸŸ£ ØªØ«Ø¨ÙŠØª Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙŠÙ…ÙŠÙ† */
td:first-child, th:first-child {
  position: sticky;
  right: 0;
  background: white;
  z-index: 40;
}

/* ğŸ”´ ØªØ«Ø¨ÙŠØª Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ³Ù„Ø³Ù„ (#) ÙŠÙ…ÙŠÙ† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
td:nth-child(2), th:nth-child(2) {
  position: sticky;
  right: 60px;
  background: white;
  z-index: 39;
}


  </style>
</head>

<body>

  <header id="pageTitle">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</header>
<h2 id="pageStatusTitle" style="
  text-align:center;
  background:#FF6B2D;
  color:white;
  font-weight:bold;
  padding:10px 0;
  margin:10px 0;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
"></h2>

  <div class="top-bar">
  <button class="back-btn" id="backBtn">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <div class="dropdown">
    <button class="back-btn" id="commandsBtn">âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ³ÙŠØ· â–¾</button>
    <div class="dropdown-content" id="commandsMenu">
      <button id="sendToWaseet">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©</button>
      <button id="updateStatuses">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
    </div>
  </div>
  <button class="delete-btn" id="deleteSelected">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
</div>
<button class="delete-btn" id="deleteDuplicates" style="margin-right:10px;background:#8b0000;">
  ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
</button>


  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø©...">
  </div>
<div style="text-align:center;margin:10px 0;">
  <button onclick="undoChange()" style="background:#043B64;color:white;padding:8px 15px;border:none;border-radius:6px;">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
  <button onclick="redoChange()" style="background:#FF6B2D;color:white;padding:8px 15px;border:none;border-radius:6px;">â†ªï¸ Ø¥Ø¹Ø§Ø¯Ø©</button>
</div>
<!-- ğŸ”ğŸ” Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± -->
<div id="zoomControls" style="
  position: fixed;
  top: 90px;
  left: 10px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
">
  <button id="zoomInBtn" style="
    width:42px;height:42px;border:none;border-radius:50%;
    background:#043B64;color:white;font-size:22px;box-shadow:0 3px 8px rgba(0,0,0,0.2);
  ">ï¼‹</button>

  <button id="zoomOutBtn" style="
    width:42px;height:42px;border:none;border-radius:50%;
    background:#FF6B2D;color:white;font-size:22px;box-shadow:0 3px 8px rgba(0,0,0,0.2);
  ">ï¼</button>
</div>
 <div id="ordersList"></div>


<script type="module">
  // ğŸ§  Ø­ÙØ¸ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ÙŠÙØªØ­Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
window.addEventListener("beforeunload", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const currentStatus = decodeURIComponent(urlParams.get("status") || "");
  localStorage.setItem("lastStatusView", currentStatus);
  localStorage.setItem("previousScrollPosition", window.scrollY);
});

  import { waseetCities } from "./waseetCities.js";
  import { waseetRegions } from "./waseetRegions.js";
  import { citiesData, allCities } from "./citiesData.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove, get } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
    // ğŸ§© Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
// ğŸ§© Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
// âœ… ØªØ­Ø¯ÙŠØ« Ø°ÙƒÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (ÙŠØ¯Ø¹Ù… ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ØªØºÙŠØ±Ø§Øª)
// âœ… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (Ø¶Ø±ÙˆØ±ÙŠØ© Ù‚Ø¨Ù„ Ø£ÙŠ ÙƒÙˆØ¯)
window.showNotification = function (message, color = "#043B64") {
  const existing = document.querySelector(".notification");
  if (existing) existing.remove();

  const note = document.createElement("div");
  note.className = "notification";
  note.textContent = message;
  note.style.background = color;
  document.body.appendChild(note);

  // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¯Ø±ÙŠØ¬ÙŠ
  setTimeout(() => note.classList.add("show"), 100);

  // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
  setTimeout(() => {
    note.classList.remove("show");
    setTimeout(() => note.remove(), 400);
  }, 3000);
};

// âœ… Ø¯Ø§Ù„Ø© ØªØ¶Ù…Ù† Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ§Ù…Ù„Ø© Ù‚Ø¨Ù„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø©
async function ensureOrderDetailsSaved(orderId) {
  const db = getDatabase();
  const orderRef = ref(db, `orders/${orderId}`);
  const snap = await get(orderRef);
  if (!snap.exists()) return;
  const order = snap.val();

  // Ù„Ùˆ Ø£ØµÙ„Ø§Ù‹ Ù…ÙˆØ¬ÙˆØ¯ productsDetailedØŒ Ù…Ø§ Ù†Ø³ÙˆÙŠ Ø´ÙŠ
// Ù„Ùˆ Ù…Ø§ÙƒÙˆ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ productsDetailed Ù†Ø¹ÙŠØ¯ ØªÙˆÙ„ÙŠØ¯Ù‡Ø§
if (
  !order.productsDetailed ||
  !Array.isArray(order.productsDetailed) ||
  order.productsDetailed.length === 0 ||
  !order.productsDetailed[0]?.name
) {
  // Ù†ÙƒÙ…Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ø¯Ù†Ø§Ù‡
} else {
  return; // Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ©ØŒ Ù†Ø·Ù„Ø¹
}

  // Ù†Ø¬Ù‡Ø² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  const productName = order.productName || "";
  const qty = Number(order.quantity) || 0;
  const variants = order.selectedVariants || {};

  if (!productName || qty <= 0) return;

  const details = [{
    name: productName,
    qty: qty,
    variants: variants
  }];

  await update(orderRef, { productsDetailed: details });
  console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${orderId} ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`);
}
window.adjustStockOnStatusChange = async function (orderId, newStatus) {
  const db = getDatabase();
  const orderRef = ref(db, `orders/${orderId}`);
  const orderSnap = await get(orderRef);
  if (!orderSnap.exists()) return;
  const order = orderSnap.val();

  console.log("ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", orderId, newStatus);

  // ğŸ§© ØªØ¬Ù…ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ)
  const products = [];

  function addProduct(name, qty, variants) {
    if (!name || isNaN(qty)) return;
    const cleanName = name.trim();
    const hasVariants = variants && Object.keys(variants).length > 0;
    const variantKey = hasVariants
      ? Object.entries(variants)
          .map(([k, v]) => `${k} | ${v}`)
          .join(" | ")
      : "Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±";
    products.push({ name: cleanName, qty, variantKey, variants });
  }

  // ğŸŸ¢ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  if (order.productName && order.quantity) {
    addProduct(order.productName, parseInt(order.quantity), order.selectedVariants || {});
  }

  // ğŸŸ¢ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (extraProducts)
  if (Array.isArray(order.extraProducts)) {
    order.extraProducts.forEach((p) => {
      addProduct(p.name, parseInt(p.qty) || 1, p.selectedVariants || {});
    });
  }

  // ğŸŸ¢ productsDetailed (ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³Ø¨Ù‚)
  if (Array.isArray(order.productsDetailed)) {
    order.productsDetailed.forEach((p) => {
      addProduct(p.name, parseInt(p.qty) || 1, p.variants || {});
    });
  }

  // ğŸ§± Ù†Ø¨Ø¯Ø£ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
  for (const item of products) {
    const { name, qty, variantKey, variants } = item;
    const warehouseRef = ref(db, `warehouse/${name}`);
    const warehouseSnap = await get(warehouseRef);

    // ğŸš¨ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
    if (!warehouseSnap.exists()) {
      console.warn(`ğŸš« Ø§Ù„Ù…Ù†ØªØ¬ "${name}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†`);
      showNotification(`ğŸš¨ Ø§Ù„Ù…Ù†ØªØ¬ "${name}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†!`, "#b30000");

      // ğŸ”´ ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const td = [...document.querySelectorAll("td")].find(
        (cell) => cell.textContent.trim() === name
      );
      if (td) td.style.backgroundColor = "#ffcccc";
      continue;
    }

    const warehouse = warehouseSnap.val();
    const stock = warehouse.stock || {};
    const processed = warehouse.processedOrders || {};
    let totalQty = parseInt(warehouse.totalQty || 0);

    // ğŸ§  Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    let foundKey = null;
    const variantValues = Object.values(variants || {}).map((v) => v.trim().toLowerCase());

    for (const key of Object.keys(stock)) {
      const normalizedKey = key.trim().toLowerCase();
      const matches = variantValues.filter((v) => normalizedKey.includes(v)).length;
      if (matches === variantValues.length && matches > 0) {
        foundKey = key;
        break;
      }
    }

    // ğŸ§© Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
    const variantId = variantKey.replace(/\s+/g, "_");
    const uniqueKey = `${orderId}_${name}_${variantId}`;

  // ===============================
//  ğŸŸ© Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø¯ÙˆÙ† Ø±ÙØ¶
// ===============================
if (newStatus === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„" && !processed[`deduct_${uniqueKey}`]) {

  // ğŸŸ¢ 1) Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ù…ØªØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚
  if (foundKey && stock[foundKey] !== undefined) {
    stock[foundKey] = (stock[foundKey] || 0) - qty;  // ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨
    processed[`deduct_${uniqueKey}`] = true;
    console.log(`ğŸ“¦ Ø®ØµÙ… ${qty} Ù…Ù† ${name} (${foundKey}) = ${stock[foundKey]}`);
  }

  // ğŸŸ  2) Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…ØªØºÙŠØ± Ù„ÙƒÙ† ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
  else if (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] !== undefined) {
    stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = (stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] || 0) - qty;
    processed[`deduct_${uniqueKey}`] = true;
    console.log(`ğŸ“¦ Ø®ØµÙ… ${qty} Ù…Ù† ${name} (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©) = ${stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"]}`);
  }

  // ğŸ”´ 3) Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø®Ø²ÙˆÙ† â†’ Ù†Ù†Ø´Ø¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬Ø¯ÙŠØ¯ ÙˆÙ†Ø®ØµÙ… Ù…Ù†Ù‡
  else {
    stock["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©"] = -qty;  
    processed[`deduct_${uniqueKey}`] = true;
    console.log(`ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬Ø¯ÙŠØ¯ ÙˆØ®ØµÙ… ${qty} Ù„Ù€ ${name} = -${qty}`);
  }
}


    // â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨)
    totalQty = Object.values(stock).reduce((a, b) => a + (parseInt(b) || 0), 0);

    // ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
    await update(warehouseRef, {
      stock,
      totalQty,
      processedOrders: processed,
      lastUpdate: new Date().toISOString(),
    });

    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${name}`, { totalQty, stock });
  }
};







    const firebaseConfig = {
      apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
      authDomain: "almurad-system.firebaseapp.com",
      databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
      projectId: "almurad-system",
      storageBucket: "almurad-system.appspot.com",
      messagingSenderId: "911755824405",
      appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
    };

   const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ordersBody = document.getElementById("ordersBody");
const searchInput = document.getElementById("searchInput");

// ğŸ”¹ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
let currentUser = sessionStorage.getItem("userName");

// ğŸ”¸ ÙÙŠ Ø­Ø§Ù„ Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ session (Ù…Ø«Ù„Ø§Ù‹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)
if (!currentUser) {
  const savedUser = localStorage.getItem("loggedInUser");
  if (savedUser) {
    const parsed = JSON.parse(savedUser);
    currentUser = parsed.name || parsed.username || parsed.displayName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  } else {
    currentUser = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  }
}



    let allProducts = [];
    let allOrders = [];
    window.allOrders = allOrders;
window.__debugOrders = allOrders;

    const urlParams = new URLSearchParams(window.location.search);
    const currentStatus = decodeURIComponent(urlParams.get("status") || "");

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    // ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ "warehouse"
const productsRef = ref(db, "warehouse");
onValue(productsRef, (snapshot) => {
  if (snapshot.exists()) {
    const data = snapshot.val();
    // ÙƒÙ„ Ù…Ù†ØªØ¬ Ù…ÙØªØ§Ø­Ù‡ Ù‡Ùˆ Ø§Ø³Ù…Ù‡ Ù…Ø«Ù„ "Ø¨ÙˆØºØ§ØªÙŠ"
    allProducts = Object.keys(data); 
  } else {
    allProducts = [];
  }
});

// âœ… Ù…ØªØºÙŠØ± Ø¹Ø§Ù… ÙŠØ®Ø²Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø­ØªÙ‰ Ù†Ø¹Ø±Ù Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
let previousOrderCount = 0;

// ğŸŸ¢ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù‹
const ordersRef = ref(db, "orders");

// âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ fixedBy
onValue(ordersRef, (snapshot) => {
  if (!snapshot.exists()) {
    ordersBody.innerHTML = `<tr><td colspan="17">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
    return;
  }

  const data = snapshot.val();

allOrders = Object.entries(data).map(([id, order]) => ({ id, ...order }));
window.allOrders = allOrders; // â¬…ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
window.__debugOrders = allOrders;
if (previousOrderCount && Object.keys(data).length > previousOrderCount) {
  const newRows = document.querySelectorAll("tr:first-child");
  newRows.forEach(row => {
    row.style.backgroundColor = "#d4edda"; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
    setTimeout(() => row.style.backgroundColor = "", 2000);
  });
}
previousOrderCount = Object.keys(data).length;

// âœ… Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
if (!currentStatus) {
  const newOrders = allOrders.filter(o => {
    const st = (o.status || "").trim();
    return !st || st === "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" || st === null;
  });
  currentOrders = newOrders;
  currentIndex = 0;
  ordersBody.innerHTML = ""; // ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù…
  renderNextOrders(); // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 50 ÙÙ‚Ø·
} else {
  // âœ… ØºÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø«Ù„Ø§Ù‹ Ù…Ø«Ø¨ØªØ© Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„)
  refreshVisibleOrders();
}


  // âœ… Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
  const currentCount = Object.keys(data).length;
  if (previousOrderCount && currentCount > previousOrderCount) {
    const diff = currentCount - previousOrderCount;
    showNewOrderNotification(diff);
  }
  previousOrderCount = currentCount;
});


// â¬‡ï¸ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ø³Ø·Ø±ÙŠÙ†
window.allOrders = allOrders;
window.__debugOrders = allOrders;
// âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø²Ø¦ÙŠ
let currentOrders = [];
let currentIndex = 0;
const chunkSize = 50; // Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨ÙƒÙ„ Ø¯ÙØ¹Ø©

// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰)
function renderNextOrders() {
  const nextChunk = currentOrders.slice(currentIndex, currentIndex + chunkSize);
  const offset = currentIndex;
  renderOrders(nextChunk, true, offset);
  currentIndex += chunkSize;
}

// âœ… Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ â€” ØªØ­Ù…ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
window.addEventListener("scroll", () => {
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 400;
  if (nearBottom && currentIndex < currentOrders.length) {
    renderNextOrders();
  }
});
function renderOrdersPaginated(orders) {
  // ğŸ”¼ ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰)
  currentOrders = orders.sort((a, b) => {
    const dateA = new Date(a.orderDate || 0);
    const dateB = new Date(b.orderDate || 0);
    return dateA - dateB; // Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
  });

  currentIndex = 0;
  ordersBody.innerHTML = "";
  renderNextOrders(); // Ø£ÙˆÙ„ 50 Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø«
}









// âœ… Ù†Ø®ÙÙŠ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" Ù„Ø£Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
const loadMoreBtn = document.getElementById("loadMoreBtn");
if (loadMoreBtn) loadMoreBtn.style.display = "none";




// ğŸ”„ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function refreshVisibleOrders() {
  const filtered = allOrders.filter(o => {
    const st = (o.status || "").trim();
   return currentStatus === ""
  ? (st === "" || st === null || st === "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" || typeof st === "undefined")
  : st === currentStatus;

  });

renderOrdersPaginated(filtered);
}


function createEditableInput(value, onSave, fieldName = "", orderId = "") {
  const input = document.createElement("input");
  input.value = value || "";

 if (fieldName === "price" || fieldName === "quantity") {
  input.addEventListener("input", e => {
    // ÙÙ‚Ø· Ø£Ø±Ù‚Ø§Ù… â€” Ø¨Ø¯ÙˆÙ† ÙÙˆØ§Ø±Ø²ØŒ Ø¨Ø¯ÙˆÙ† ØªÙ†Ø³ÙŠÙ‚
    e.target.value = e.target.value.replace(/[^\d]/g, "");
  });

  input.addEventListener("change", e => {
    const cleanValue = e.target.value.replace(/[^\d]/g, "");
    recordChange(orderId, fieldName, value, cleanValue);
    onSave(cleanValue);
  });
}

   else {
    // ğŸŸ  Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙØ§ØµÙ„Ø©
    input.addEventListener("change", e => {
      const newVal = e.target.value;
      recordChange(orderId, fieldName, value, newVal); // âœ… Ù†Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±
      onSave(newVal);
    });
  }

  return input;
}




    function createTextarea(value, onSave) {
      const t = document.createElement("textarea");
      t.value = value || "";
      t.addEventListener("change", e => onSave(e.target.value));
      return t;
    }
// âœ… Ø¯Ø§Ù„Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø© + Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function createDropdown(options, selected, onChange) {
  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";

  const input = document.createElement("input");
  input.type = "text";
  input.value = selected || "";
  input.placeholder = "Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ±...";
  input.style.cursor = "text";
  input.style.width = "100%";
  input.style.borderRadius = "4px";
  input.style.padding = "4px";
  input.style.border = "1px solid #ccc";
  input.style.background = "#fff";
  input.style.fontSize = "12px";

  // âš™ï¸ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
  const dropdown = document.createElement("div");
  Object.assign(dropdown.style, {
    position: "fixed",
    background: "#fff",
    border: "1px solid #ccc",
    borderRadius: "6px",
    boxShadow: "0 3px 10px rgba(0,0,0,0.25)",
    maxHeight: "200px",
    overflowY: "auto",
    zIndex: "9999999",
    display: "none",
    fontSize: "13px"
  });
  document.body.appendChild(dropdown);

  // ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  function showDropdown(filter = "") {
    dropdown.innerHTML = "";
    const filtered = options.filter(o => o.includes(filter));
    if (filtered.length === 0) {
      const noRes = document.createElement("div");
      noRes.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
      noRes.style.padding = "6px 10px";
      dropdown.appendChild(noRes);
    } else {
      filtered.forEach(o => {
        const opt = document.createElement("div");
        opt.textContent = o;
        opt.style.padding = "5px 8px";
        opt.style.cursor = "pointer";
        opt.addEventListener("click", () => {
          input.value = opt.textContent.trim();
          dropdown.style.display = "none";
          if (onChange) onChange(opt.textContent.trim());
        });
        dropdown.appendChild(opt);
      });
    }

    const rect = input.getBoundingClientRect();
const scrollY = window.scrollY || document.documentElement.scrollTop;
const scrollX = window.scrollX || document.documentElement.scrollLeft;
const dropdownHeight = 200;
const spaceBelow = window.innerHeight - rect.bottom;

// âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù† ØªØ­Øª Ø¶ÙŠÙ‚ØŒ ØªÙØªØ­ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¨Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ù‚Ù„
let topPosition;
if (spaceBelow < dropdownHeight) {
  topPosition = rect.top + scrollY - dropdownHeight - 5; // ØªÙØªØ­ ÙÙˆÙ‚ Ø¨Ø´ÙƒÙ„ Ù…Ø±ØªØ¨
} else {
  topPosition = rect.bottom + scrollY + 3; // ØªÙØªØ­ ØªØ­Øª Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
}

dropdown.style.position = "absolute";
dropdown.style.top = `${topPosition}px`;
dropdown.style.left = `${rect.left + scrollX}px`;
dropdown.style.width = `${rect.width}px`;
dropdown.style.display = "block";
dropdown.style.zIndex = "9999999";

  }

  // ğŸ§  Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
// âœ… Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ØªÙØªØ­ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø©
input.addEventListener("focus", () => showDropdown(""));
input.addEventListener("click", () => showDropdown(""));
  input.addEventListener("input", (e) => showDropdown(e.target.value.trim()));

  // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒØªØ§Ø¨Ø© Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ø¥Ù†ØªØ±
  input.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter" && input.value.trim()) {
      ev.preventDefault();
      dropdown.style.display = "none";
      if (onChange) onChange(input.value.trim());
    }
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) dropdown.style.display = "none";
  });

  wrapper.appendChild(input);
  return wrapper;
}



// âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®Ø§Ù†Ø© "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" Ù…Ø¹ Ø¨Ø­Ø« ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ÙÙ‚Ø§Ø¹Ø§Øª
function createTagsDropdownCell(orderId, initialValue = "", options = [], onSave) {
  const td = document.createElement("td");

  const container = document.createElement("div");
  container.style.cssText = `
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 4px;
    background: #fff;
    min-height: 34px;
    cursor: text;
  `;

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...";
  input.style.cssText = `
    border: none;
    outline: none;
    flex: 1;
    min-width: 80px;
    font-size: 12px;
  `;

  let tags = initialValue
    ? initialValue.split("ØŒ").map(t => t.trim()).filter(Boolean)
    : [];

  function renderTags() {
    container.innerHTML = "";
    tags.forEach((tag, index) => {
      const span = document.createElement("span");
      span.textContent = tag;
      span.style.cssText = `
        background: #043B64;
        color: white;
        border-radius: 20px;
        padding: 3px 10px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 5px;
      `;
      const remove = document.createElement("span");
      remove.textContent = "âœ–";
      remove.style.cursor = "pointer";
      remove.onclick = () => {
        tags.splice(index, 1);
        saveTags();
      };
      span.appendChild(remove);
      container.appendChild(span);
    });
    container.appendChild(input);
  }

  function saveTags() {
    const val = tags.join("ØŒ ");
onSave(val, input);
    renderTags();
  }

  // ğŸ”½ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬
  const dropdown = document.createElement("div");
  Object.assign(dropdown.style, {
    position: "fixed",
    background: "#fff",
    border: "1px solid #ccc",
    borderRadius: "6px",
    boxShadow: "0 3px 10px rgba(0,0,0,0.2)",
    maxHeight: "200px",
    overflowY: "auto",
    zIndex: "999999",
    display: "none",
    fontSize: "12px"
  });

  function showDropdown(filter = "") {
    dropdown.innerHTML = "";
    const filtered = options.filter(o => o.includes(filter));
    if (filtered.length === 0) {
      const noResult = document.createElement("div");
      noResult.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
      noResult.style.padding = "6px 10px";
      dropdown.appendChild(noResult);
    } else {
      filtered.forEach(o => {
        const opt = document.createElement("div");
        opt.textContent = o;
        opt.style.padding = "5px 8px";
        opt.style.cursor = "pointer";
        opt.addEventListener("click", () => {
          if (!tags.includes(o)) {
            tags.push(o);
            saveTags();
          }
          dropdown.style.display = "none";
          input.value = "";
        });
        dropdown.appendChild(opt);
      });
    }

    const rect = input.getBoundingClientRect();
const scrollY = window.scrollY || document.documentElement.scrollTop;
const scrollX = window.scrollX || document.documentElement.scrollLeft;
const dropdownHeight = 200;
const spaceBelow = window.innerHeight - rect.bottom;

// âœ… Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ù…ÙƒØ§Ù† ÙƒØ§ÙÙŠ ØªØ­Øª Ø§Ù„Ø­Ù‚Ù„ØŒ Ø®Ù„ÙŠ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ØªØ·Ù„Ø¹ Ù„Ù„Ø£Ø¹Ù„Ù‰
let topPosition;
if (spaceBelow < dropdownHeight) {
  topPosition = rect.top + scrollY - dropdownHeight - 5; // Ù„Ù„Ø£Ø¹Ù„Ù‰
} else {
  topPosition = rect.bottom + scrollY + 3; // Ù„Ù„Ø£Ø³ÙÙ„
}

// âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¯ÙˆÙ† fixed Ø­ØªÙ‰ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
dropdown.style.position = "absolute";
dropdown.style.top = `${topPosition}px`;
dropdown.style.left = `${rect.left + scrollX}px`;
dropdown.style.width = `${rect.width}px`;
dropdown.style.display = "block";
dropdown.style.zIndex = "9999999";

  }

  input.addEventListener("focus", () => showDropdown());
input.addEventListener("input", e => {
  const value = e.target.value.trim();
  showDropdown(value);

  // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
  input.onkeydown = (ev) => {
    if (ev.key === "Enter" && value) {
      ev.preventDefault();
      if (!tags.includes(value)) {
        tags.push(value);
        saveTags();
      }
      input.value = "";
      dropdown.style.display = "none";
    }
  };
});
  document.addEventListener("click", e => {
    if (!container.contains(e.target)) dropdown.style.display = "none";
  });

  container.appendChild(input);
  document.body.appendChild(dropdown);
  renderTags();
  td.appendChild(container);
  return td;
}

function renderOrders(orders, append = false, offset = 0) {
  if (!append) ordersBody.innerHTML = "";

      if (orders.length === 0) {
        ordersBody.innerHTML = `<tr><td colspan="17">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</td></tr>`;
        return;
      }

      orders.forEach((order, index) => {
        const tr = document.createElement("tr");
           // ğŸ›‘ Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø§Øª Ù…Ø¹ÙŠÙ†Ø© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
  const user = JSON.parse(localStorage.getItem("loggedInUser")) || {};
  const roles = user.roles || [];
  const readOnlyStatuses = ["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø±Ø§Ø¬Ø¹", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"];
  const isReadOnly = readOnlyStatuses.includes(order.status?.trim());

  // ğŸ”’ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø£Ø¯Ù…Ù† ÙˆÙ„Ø§ Ù…Ø­Ø§Ø³Ø¨ØŒ ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©
  if (!roles.includes("admin") && !roles.includes("accountant") && isReadOnly) {
    // Ù†Ø­ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ù‰ Ù†ØµÙˆØµ Ø«Ø§Ø¨ØªØ© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø¯Ø®Ø§Ù„)
    const cols = [
      order.code, order.phone1 || order.phone, order.phone2, order.city, order.area,
      order.address, order.price, order.quantity, order.productName, order.notes,
      order.receiptNum, order.status, order.orderDate, order.advertiser
    ];

    btn.onclick = () => openOrderDetailsInline(order);
    detailsTd.appendChild(btn);

    // âœ… Ù†Ø¶ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    tr.appendChild(document.createElement("td")); // checkbox ÙØ§Ø±Øº
    tr.appendChild(indexTd);
    tr.appendChild(detailsTd);

    cols.forEach((val) => {
      const td = document.createElement("td");
      td.textContent = val || "-";
      tr.appendChild(td);
    });
// ğŸ” ÙØ­Øµ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
const productName = (order.productName || "").trim();
if (productName && !allProducts.includes(productName)) {
  tr.style.backgroundColor = "#ffcccc"; // ğŸ”´ Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ
}

// âœ… Ø£Ø¶Ù Ø§Ù„ØµÙ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ø§Ù„Ø£Ø­Ø¯Ø« Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
ordersBody.appendChild(tr);

    return; // â›” Ù†ÙˆÙ‚Ù Ù‡Ù†Ø§ØŒ Ù…Ø§ Ù†ÙƒÙ…Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ­Ø±ÙŠØ±
  }

        const areas = citiesData[order.city] || [];

        // âœ… Ø§Ø®ØªÙŠØ§Ø±
        const selectTd = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.id = order.id;
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        // ğŸ”¢ ØªØ³Ù„Ø³Ù„
        const indexTd = document.createElement("td");
indexTd.textContent = offset + index + 1;
        tr.appendChild(indexTd);

        // ğŸ” ØªÙØ§ØµÙŠÙ„
        const detailsTd = document.createElement("td");
        const detailsBtn = document.createElement("button");
        detailsBtn.textContent = "ğŸ” ØªÙØ§ØµÙŠÙ„";
        detailsBtn.style.background = "#FF6B2D";
detailsBtn.addEventListener("click", () => {
  const modal = document.getElementById("detailsModal");
  const frame = document.getElementById("detailsFrame");

localStorage.setItem("selectedOrder", order.id);

// âœ… Ù†Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø«Ù„ "Ù…Ø«Ø¨Øª" Ø£Ùˆ "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©")
localStorage.setItem("lastStatusView", currentStatus);

// âœ… Ù†Ø±Ø³Ù„Ù‡Ø§ Ø£ÙŠØ¶Ù‹Ø§ ÙƒÙ€ query ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­ØªÙ‰ ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ØªØ¹Ø±ÙÙ‡Ø§
frame.src = `order-details.html?id=${order.id}&status=${encodeURIComponent(currentStatus)}`;

  modal.style.display = "block";


// Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
function handleCloseModal(e) {
  if (e.data === "closeDetailsModal") {
    modal.style.display = "none";
    frame.src = "";
    window.removeEventListener("message", handleCloseModal);
  }
}
window.addEventListener("message", handleCloseModal);

});

        detailsTd.appendChild(detailsBtn);
        tr.appendChild(detailsTd);

        // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„
    // âœ… Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø© Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯ (ØªØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹)
const fields = [
  { name: "code", val: order.code, fn: v => update(ref(db, `orders/${order.id}`), { code: v }) },
  { name: "phone1", val: order.phone1 || order.phone, fn: v => update(ref(db, `orders/${order.id}`), { phone1: v }) },
  { name: "phone2", val: order.phone2, fn: v => update(ref(db, `orders/${order.id}`), { phone2: v }) },
  { name: "city", city: true },
  { name: "area", area: true },
  { name: "address", val: order.address, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { address: v }) },
  { name: "price", val: order.price, fn: v => update(ref(db, `orders/${order.id}`), { price: v }) },
  { name: "quantity", val: order.quantity, fn: v => update(ref(db, `orders/${order.id}`), { quantity: v }) },
  {
    name: "productName",
    val: order.productName || order.product,
    customRender: "tagsInput",
    fn: v => update(ref(db, `orders/${order.id}`), { productName: v })
  },
  { name: "notes", val: order.notes, textarea: true, fn: v => update(ref(db, `orders/${order.id}`), { notes: v }) },
  { name: "receiptNum", val: order.receiptNum, fn: v => update(ref(db, `orders/${order.id}`), { receiptNum: v }) },
  {
    name: "status",
    val: order.status || "",
dropdown: ["Ù…Ø«Ø¨Øª", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", "Ø±ÙØ¶"],
fn: async (newStatus) => {
  console.log("ğŸ§  Ù…Ø­Ø§ÙˆÙ„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰:", newStatus);

  // âœ… Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©: Ù„Ø§ ØªØ³ÙˆÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­Ø©
  if (!newStatus || newStatus.trim() === "" || newStatus.trim() === "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") {
    console.warn("âš ï¸ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
    return;
  }

  const userName = currentUser;
  const orderRef = ref(db, `orders/${order.id}`);
  const snap = await get(orderRef);
  const existing = snap.exists() ? snap.val() : {};

  const historyEntry = { status: newStatus, by: userName, at: new Date().toISOString() };

  const updates = {
    status: newStatus,
    updatedBy: userName,
    updatedAt: new Date().toISOString(),
    statusHistory: [...(existing.statusHistory || []), historyEntry],
  };

  // âœ… ÙÙ‚Ø· Ø£ÙˆÙ„ Ù…Ù† ÙŠØ«Ø¨Øª Ø£Ùˆ ÙŠØ±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ ÙŠÙØ³Ø¬Ù„ Ø¨Ø§Ø³Ù…Ù‡
 const s = (existing.status || "").trim();
if ((newStatus === "Ù…Ø«Ø¨Øª" || newStatus === "Ø±ÙØ¶") && !existing.fixedBy)
{
    updates.fixedBy =
      existing.fixedBy ||
      sessionStorage.getItem("userName") ||
      localStorage.getItem("userName") ||
      currentUser ||
      "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    updates.fixedAt = existing.fixedAt || new Date().toISOString();
  }

  if (["Ù…Ø«Ø¨Øª", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"].includes(newStatus))
    await ensureOrderDetailsSaved(order.id);

  await update(orderRef, updates);
  console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${newStatus}`);

  if (["Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹"].includes(newStatus)) {
    console.log("ğŸš€ ØªÙ†ÙÙŠØ° ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„:", newStatus);
    await adjustStockOnStatusChange(order.id, newStatus);
  }

  const st = (newStatus || "").trim();
  const shouldHide =
    (currentStatus === "" && st !== "") ||
    (currentStatus !== "" && st !== currentStatus);
  if (shouldHide) tr.remove();
}


  },
  { name: "orderDate", val: order.orderDate || "-", readonly: true },
  { name: "advertiser", val: order.advertiser, fn: v => update(ref(db, `orders/${order.id}`), { advertiser: v }) }
];

function createProductTagsCell(productName) {
  const td = document.createElement("td");
  if (!productName) {
    td.textContent = "-";
    return td;
  }

  const products = productName.split("ØŒ").map(p => p.trim());
  products.forEach(name => {
    const tag = document.createElement("span");
    tag.textContent = name;
    tag.style.cssText = `
      display: inline-block;
      background: #043B64;
      color: white;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      margin: 2px;
      white-space: nowrap;
    `;
    td.appendChild(tag);
  });
  return td;
}
fields.forEach(f => {
  let td;

  // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§Ù†Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
  if (f.customRender === "tagsInput") {
    td = createTagsDropdownCell(order.id, order.productName || "", allProducts, async (newVal, cellElement) => {
      const orderRef = ref(db, `orders/${order.id}`);
      const snap = await get(orderRef);
      const existing = snap.exists() ? snap.val() : {};
      const updates = { productName: newVal.trim() };

      // ğŸŸ¢ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£Ùˆ Ø§Ù„ØµÙ
      const tdElement = cellElement || td;
      const row = tdElement ? tdElement.closest("tr") : null;
      const cleanName = newVal.trim();

      // ğŸ”´ Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      if (!allProducts.includes(cleanName)) {
        tdElement.style.backgroundColor = "#ffcccc"; // Ø®Ù„ÙŠØ© Ø­Ù…Ø±Ø§Ø¡
      } else {
        tdElement.style.backgroundColor = ""; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„ÙˆÙ†
      }

      // ğŸ§© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
      if (!existing.productsDetailed || !Array.isArray(existing.productsDetailed) || existing.productsDetailed.length === 0) {
        updates.productsDetailed = [{ name: newVal, qty: existing.quantity || 1 }];
      } else {
        existing.productsDetailed[0].name = newVal;
        updates.productsDetailed = existing.productsDetailed;
      }

      await update(orderRef, updates);
      console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ "${newVal}"`);
    });

    // ğŸ” Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„ÙŠØ© Ø¥Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†
    const currentName = (order.productName || "").trim();
    if (currentName && !allProducts.includes(currentName)) {
      td.style.backgroundColor = "#ffcccc"; // Ø®Ù„ÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    }

  } else {
    // âœ… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰
    td = document.createElement("td");
    if (f.readonly) td.textContent = f.val || "-";
    else if (f.textarea) td.appendChild(createTextarea(f.val, f.fn));
    else if (f.dropdown) td.appendChild(createDropdown(f.dropdown, f.val, f.fn));
    else if (f.city) {
      const cityDropdown = createDropdown(allCities, order.city || "", val => update(ref(db, `orders/${order.id}`), { city: val, area: "" }));
      td.appendChild(cityDropdown);
    } else if (f.area) {
      const areaDropdown = createDropdown(areas, order.area || "", val => update(ref(db, `orders/${order.id}`), { area: val }));
      td.appendChild(areaDropdown);
    } else td.appendChild(createEditableInput(f.val, f.fn, f.name || "", order.id));
  }

  tr.appendChild(td);
});



// âœ… Ø£Ø¶Ù Ø§Ù„ØµÙ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ø§Ù„Ø£Ø­Ø¯Ø« Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
ordersBody.appendChild(tr);

      });
    }

// âœ… Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ Ø®ÙÙŠÙ ÙˆØ³Ø±ÙŠØ¹
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    runSearch();
  }
});

// âœ… Ø²Ø± Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ
const searchBtn = document.createElement("button");
searchBtn.textContent = "ğŸ” Ø¨Ø­Ø«";
searchBtn.style = `
  margin-right:10px;
  padding:8px 15px;
  background:#043B64;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
`;
searchBtn.addEventListener("click", runSearch);
document.querySelector(".search-bar").appendChild(searchBtn);

function runSearch() {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) {
    renderOrders(allOrders); // Ø¥Ø°Ø§ ÙØ§Ø±Øº â†’ Ø±Ø¬Ù‘Ø¹ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    return;
  }

  const filtered = allOrders.filter(o => {
    const code = String(o.code || "").toLowerCase();
    const phone1 = String(o.phone1 || "").toLowerCase();
    const product = String(o.productName || "").toLowerCase();
    const receipt = String(o.receiptNum || "").toLowerCase();

    return (
      code.includes(q) ||
      phone1.includes(q) ||
      product.includes(q) ||
      receipt.includes(q)
    );
  });

  renderOrders(filtered.slice(0, 300));
}


// âœ… Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…Ø³Ø­ Ø§Ù„Ù†Øµ ØªÙ…Ø§Ù…Ù‹Ø§ØŒ ØªØ±Ø¬Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù‡Ø§ ÙÙˆØ±Ù‹Ø§
searchInput.addEventListener("input", () => {
  if (searchInput.value.trim() === "") {
renderOrdersPaginated(allOrders);
  }
});





// ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
// ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© + Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
document.getElementById("deleteDuplicates").addEventListener("click", async () => {

  if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŸ")) return;

  const ordersRef = ref(db, "orders");
  const snap = await get(ordersRef);

  if (!snap.exists()) {
    alert("ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.");
    return;
  }

  const data = snap.val();
  const seen = {};     
  const duplicates = [];  

  for (const [id, order] of Object.entries(data)) {

    const phone = (order.phone1 || order.phone || "").trim();
    const status = (order.status || "").trim();

    // ğŸ¯ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø°Ù Ø¹Ù„ÙŠÙ‡Ù†
    const isTarget =
      !status || status === "" || status === "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" || status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©";

    if (!isTarget || !phone) continue;

    if (!seen[phone]) {
      seen[phone] = id;   // Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯
    } else {
      duplicates.push(id); // Ù…ÙƒØ±Ø±
    }
  }

  // ğŸ”¥ Ù…Ø³Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
  const updates = {};
  duplicates.forEach(id => {
    updates[`orders/${id}`] = null;
  });

  await update(ref(db), updates);

  alert(`ğŸ—‘ ØªÙ… Ø­Ø°Ù ${duplicates.length} Ø·Ù„Ø¨ Ù…ÙƒØ±Ø± (Ø¬Ø¯ÙŠØ¯ + Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©).`);
});





    document.getElementById("backBtn").addEventListener("click", () => window.location.href = "dashboard.html");



// ğŸšš Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ù‘Ø«Ø©)
// ğŸšš Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ· (Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© ÙˆÙ…Ø¬Ø±Ø¨Ø©)
// ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰ (Ù†Ø³Ø®Ø© Ø£ØµÙ„ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©)
document.getElementById("sendToWaseet").addEventListener("click", async () => {
  // ğŸŸ© Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px",
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  const showMsg = (text, color = "#043B64") => {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  };

  try {
    showMsg("â³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·...");

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "#b30000");
      return;
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ© ÙÙ‚Ø·
    const confirmedOrders = allOrders.filter(o => (o.status || "").trim() === "Ù…Ø«Ø¨Øª");
    if (confirmedOrders.length === 0) {
      showMsg("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ø¨ØªØ© Ø­Ø§Ù„ÙŠØ§Ù‹.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    let sentCount = 0, failedCount = 0;
    showMsg(`ğŸš€ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${confirmedOrders.length} Ø·Ù„Ø¨...`);

    // Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø­Ø¯Ø§Ù‹ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±
    for (const order of confirmedOrders) {
      try {
        const cityMatch = waseetCities.find(c => c.city_name === order.city);
        const regionMatch = waseetRegions.find(r => r.region_name === order.area);
        const cityId = cityMatch ? cityMatch.id : "";
        const regionId = regionMatch ? regionMatch.id : "";

        if (!cityId || !regionId) {
          failedCount++;
          continue;
        }

        const payload = {
          token,
          client_name: order.code || "Ø²Ø¨ÙˆÙ†",
          client_mobile: normalizePhone(order.phone1 || ""),
          client_mobile2: order.phone2 ? normalizePhone(order.phone2) : "",
          city_id: cityId,
          region_id: regionId,
          location: order.address || "",
          type_name: order.productName || "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
          items_number: order.quantity?.toString() || "1",
          price: order.price?.toString() || "0",
          package_size: "1",
          merchant_notes: order.notes || "",
          replacement: 0,
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆØ³ÙŠØ· (Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø³ÙŠØ±ÙØ±Ùƒ Ø§Ù„Ø®Ø§Øµ)
        const response = await fetch("https://almurad.onrender.com/api/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        console.log("ğŸ“¬ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙˆØ³ÙŠØ·:", data);

        if (data.status === true && data.data?.qr_id) {
          await update(ref(db, `orders/${order.id}`), {
            status: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²",
            receiptNum: data.data.qr_id.toString(),
            waseet_link: data.data.qr_link,
          });
          sentCount++;
        } else {
          failedCount++;
        }
      } catch (err) {
        failedCount++;
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨:", err);
      }
    }

    showMsg(`âœ… ØªÙ… Ø±ÙØ¹ ${sentCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ âŒ ÙØ´Ù„ ${failedCount}.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 4000);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", err);
    showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.", "#b30000");
  }
});



// ğŸ”¢ Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
function normalizePhone(phone) {
  const arabicToEnglish = {
    'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
    'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
  };
  let cleaned = phone.replace(/[^\dÙ -Ù©]/g, '');
  cleaned = cleaned.split('').map(c => arabicToEnglish[c] || c).join('');
  if (cleaned.startsWith("0")) return "+964" + cleaned.slice(1);
  if (cleaned.startsWith("7")) return "+964" + cleaned;
  if (!cleaned.startsWith("+964")) return "+964" + cleaned;
  return cleaned;
}
// ğŸ”½ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ³ÙŠØ·
const commandsBtn = document.getElementById("commandsBtn");
const commandsMenu = document.getElementById("commandsMenu");

commandsBtn.addEventListener("click", () => {
  commandsMenu.classList.toggle("show");
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
window.addEventListener("click", (e) => {
  if (!commandsBtn.contains(e.target)) commandsMenu.classList.remove("show");
});

function debugOrderFailure(orderId, order, waseetStatus) {
  console.group(`ğŸš« ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${orderId}`);

  // ğŸ›¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… ?. Ø­ØªÙ‰ Ù„Ø§ ÙŠØµÙŠØ± Ø®Ø·Ø£ Ø¥Ø°Ø§ order = null
  console.log("ğŸ“Œ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:", orderId);
  console.log("ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:", order?.phone1 || "âŒ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  console.log("ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬:", order?.productName || "âŒ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  console.log("ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:", order?.status || "âŒ ÙØ§Ø±ØºØ©");
  console.log("ğŸšš Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ³ÙŠØ·:", waseetStatus || "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
  console.log("ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„:", order?.receiptNum || "âŒ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  // ğŸ›¡ ØªØ´Ø®ÙŠØµ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„ Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ order Ù…Ø¨Ø§Ø´Ø±Ø©
  if (!order) {
    console.warn("âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (receiptNum ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚)");
  } else {
    if (!order.receiptNum) console.warn("âš ï¸ Ù…Ø§ÙƒÙˆ Ø±Ù‚Ù… ÙˆØµÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨");
    if (!order.productName) console.warn("âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙØ§Ø±Øº Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨");
    if (!order.phone1) console.warn("âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙØ§Ø±Øº Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨");
  }

  if (!waseetStatus) console.warn("âš ï¸ Ø§Ù„ÙˆØ³ÙŠØ· Ø±Ø¬Ù‘Ø¹ Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ©");

  console.groupEnd();
}


// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ· (Bulk - ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©)
document.getElementById("updateStatuses").addEventListener("click", async () => {
  // ğŸŸ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  let statusBar = document.getElementById("statusBar");
  if (!statusBar) {
    statusBar = document.createElement("div");
    statusBar.id = "statusBar";
    Object.assign(statusBar.style, {
      position: "fixed",
      top: "0",
      right: "0",
      left: "0",
      padding: "12px",
      textAlign: "center",
      backgroundColor: "#043B64",
      color: "white",
      fontSize: "15px", 
      fontWeight: "bold",
      zIndex: "999999",
      transition: "0.4s ease"
    });
    document.body.appendChild(statusBar);
  }
  function showMsg(text, color = "#043B64") {
    statusBar.textContent = text;
    statusBar.style.backgroundColor = color;
    statusBar.style.display = "block";
  }

  try {
    showMsg("â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·...");

    // ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
    const loginResponse = await fetch("https://almurad.onrender.com/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: "ramadan@almurad",
        password: "ramadan1998@"
      })
    });

    const loginData = await loginResponse.json();
    const token = loginData.data?.token;
    if (!token) {
      showMsg("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·", "#b30000");
      return;
    }

    // ğŸŸ  Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙ‚Ø·
    const allowedToCheck = ["Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„", "Ø±Ø§Ø¬Ø¹"];

    // ğŸ§© Ø§Ù„Ù…Ø§Ø¨ÙŠÙ†Ú¯ Ø¨ÙŠÙ† Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙˆØ³ÙŠØ· ÙˆØ­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    const statusMapping = {
      "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø²Ø¨ÙˆÙ†": "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
      "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„",
      "Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±": "Ø±Ø§Ø¬Ø¹",
      "ØªÙ… Ø§Ù„Ø§Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±": "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹",
      "ÙÙŠ Ù…ÙˆÙ‚Ø¹ ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„"
    };

    // ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø·
    const ordersToUpdate = allOrders.filter(
      o => allowedToCheck.includes((o.status || "").trim()) && o.receiptNum
    );

    if (ordersToUpdate.length === 0) {
      showMsg("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ«.", "#28a745");
      setTimeout(() => (statusBar.style.display = "none"), 2500);
      return;
    }

    showMsg(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ${ordersToUpdate.length} Ø·Ù„Ø¨ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©...`);

    // ğŸ§¾ ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    const allIds = ordersToUpdate.map(o => o.receiptNum).join(",");

    // ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±
    const response = await fetch("https://almurad.onrender.com/api/get-orders-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, ids: allIds })
    });

    const data = await response.json();

    if (!data.status || !data.data) {
      showMsg("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ³ÙŠØ·.", "#b30000");
      return;
    }

    let updatedCount = 0;
for (const orderData of data.data) {
  const apiStatus = (orderData.status || "").trim();
  
  const mappedStatus = statusMapping[apiStatus] || null;
  

  // ğŸ” Ø¥Ø°Ø§ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ³ÙŠØ· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø§Ø¨ÙŠÙ†Ú¯
  if (!mappedStatus) {
    debugOrderFailure(orderData.id, null, apiStatus);
    continue;
  }

const targetOrder = allOrders.find(o =>
  String(o.receiptNum || "").replace(/\s+/g, "") ===
  String(orderData.id || "").replace(/\s+/g, "")
);


if (!targetOrder) {
  console.warn("âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø¨Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ ÙÙ‚Ø·:", orderData.id);
  continue; // Ù†ÙƒÙ…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø§ Ù†Ø³ÙˆÙŠ Ø´ÙŠ
}


  // ğŸŸ¢ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
  await update(ref(db, `orders/${targetOrder.id}`), {
    status: mappedStatus
  });
  updatedCount++;

  // ğŸ§© Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¥Ø°Ø§ ÙŠØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ â€œÙ‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„â€
  if (mappedStatus === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„" || mappedStatus === "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¬Ø¹") {
    await adjustStockOnStatusChange(targetOrder.id, mappedStatus);
  }

  // ğŸŒŸ ÙÙ‚Ø· Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯
  if (apiStatus === "ÙÙŠ Ù…ÙˆÙ‚Ø¹ ÙØ±Ø² Ø¨ØºØ¯Ø§Ø¯") {
    await update(ref(db, `orders/${targetOrder.id}`), {
      notes:
        (targetOrder.notes || "") +
        (targetOrder.notes ? " | " : "") +
        "ØªØ­ÙˆÙ„Øª Ù…Ù† Ù…ÙˆÙ‚Ø¹ ÙØ±Ø²"
    });
  }
}


    showMsg(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`, "#28a745");
    setTimeout(() => (statusBar.style.display = "none"), 3000);
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª:", err);
    showMsg("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª.", "#b30000");
  }
});
// âœ… Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
function openOrderDetailsInline(order) {
  const overlay = document.createElement("div");
  Object.assign(overlay.style, {
    position: "fixed",
    top: "0", left: "0", right: "0", bottom: "0",
    background: "rgba(0,0,0,0.4)",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    zIndex: "999999"
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "white",
    borderRadius: "10px",
    padding: "20px",
    width: "90%",
    maxWidth: "600px",
    maxHeight: "90%",
    overflowY: "auto",
    direction: "rtl",
    textAlign: "right"
  });

  box.innerHTML = `
    <h3 style="text-align:center;color:#043B64;margin-top:0;">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
    <p><b>Ø§Ù„ÙƒÙˆØ¯:</b> ${order.code || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${order.productName || "-"}</p>
    <p><b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> ${order.city || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${order.area || "-"}</p>
    <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${order.address || "-"}</p>
    <p><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${order.price || "-"}</p>
    <p><b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${order.quantity || "-"}</p>
    <p><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${order.notes || "-"}</p>
    <p><b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> ${order.phone1 || "-"}</p>
    <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${order.status || "-"}</p>
    <p><b>Ø§Ù„Ù…Ø¹Ù„Ù†:</b> ${order.advertiser || "-"}</p>
    <div style="text-align:center;margin-top:20px;">
      <button id="closeOrderModal" style="background:#043B64;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("closeOrderModal").addEventListener("click", () => overlay.remove());
}


// âœ… Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const currentStatusName = decodeURIComponent(urlParams.get("status") || "");
  const pageStatusTitle = document.getElementById("pageStatusTitle");

  if (pageStatusTitle) {
    if (currentStatusName) {
      pageStatusTitle.textContent = `ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ${currentStatusName}`;
    } else {
      pageStatusTitle.textContent = "ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©";
    }
  }
});

// ğŸ§© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¶Ø¹ Ø³Ø§Ø¨Ù‚ Ù†Ø±Ø¬Ø¹ Ù„Ù‡
document.addEventListener("DOMContentLoaded", () => {
  const restoreScroll = localStorage.getItem("restoreScrollAfterReturn");
  if (restoreScroll) {
    window.scrollTo(0, parseInt(restoreScroll));
    localStorage.removeItem("restoreScrollAfterReturn");
  }
});
// âœ… ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("loadMoreBtn");
  if (btn) {
    btn.style.display = "block"; // ğŸ”¹ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø²Ø± Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    btn.addEventListener("click", () => {
      renderNextOrders();
      if (currentIndex >= currentOrders.length) btn.style.display = "none"; // ğŸ”¹ ÙŠØ®ÙÙŠ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ Ø®Ù„ØµØª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    });
  }
});

// ğŸ§  Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
window.historyStack = [];
window.redoStack = [];

// âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„
window.recordChange = function (orderId, field, oldVal, newVal) {
  if (oldVal === newVal) return;
  historyStack.push({ orderId, field, oldVal, newVal });
  redoStack = [];
  console.log(`ğŸ•˜ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„: ${field} Ù…Ù† "${oldVal}" Ø¥Ù„Ù‰ "${newVal}"`);
};

// âœ… Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ±Ø§Ø¬Ø¹
window.undoChange = async function () {
  const last = historyStack.pop();
  if (!last) return showNotification("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡", "#043B64");

  const { orderId, field, oldVal } = last;
  const dbPath = `orders/${orderId}`;
  if (!field || field.trim() === "") {
  console.error("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.");
  return;
}

  await update(ref(db, dbPath), { [field]: oldVal });
  redoStack.push(last);
  showNotification(`â†©ï¸ ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† ØªØ¹Ø¯ÙŠÙ„ ${field}`, "#043B64");
};

window.redoChange = async function () {
  const last = redoStack.pop();
  if (!last) return showNotification("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ø¥Ø¹Ø§Ø¯ØªÙ‡", "#043B64");

  const { orderId, field, newVal } = last;
  if (!field || field.trim() === "") {
    console.error("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù„Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.");
    return;
  }

  const dbPath = `orders/${orderId}`;
  await update(ref(db, dbPath), { [field]: newVal });
  historyStack.push(last);
  showNotification(`â†ªï¸ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¯ÙŠÙ„ ${field}`, "#FF6B2D");
};


// âŒ¨ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key === "z") window.undoChange();
  if (e.ctrlKey && e.key === "y") window.redoChange();
});


</script>

  <!-- âœ… Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ù†Ø³ÙˆØ®Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„) -->
  <div id="detailsModal" style="display:none;">
    <iframe id="detailsFrame" style="
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      border:none;
      z-index:999999;
    "></iframe>
  </div>
<!-- âœ… Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§Ù„Ø¶Ø¨Ø·) -->
<script>
function showNewOrderNotification(count = 1) {
  const oldBar = document.getElementById("newOrderBar");
  if (oldBar) oldBar.remove();

  const bar = document.createElement("div");
  bar.id = "newOrderBar";
  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;animation:fadeInUp 0.4s ease">
      <span style="font-size:28px;background:#fff;color:#28a745;border-radius:50%;
      width:46px;height:46px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 10px rgba(255,255,255,0.3)">ğŸ’µ</span>
      <div>
        <div style="font-weight:bold;font-size:16px;">ÙˆØµÙ„ ${count} Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯${count>1?"Ø§Øª":""}!</div>
        <div style="font-size:13px;opacity:0.9;">ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù† Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      </div>
    </div>
  `;
  Object.assign(bar.style, {
    position: "fixed",
    bottom: "25px",
    right: "25px",
    background: "linear-gradient(135deg,#28a745,#20c997)",
    color: "white",
    padding: "14px 22px",
    borderRadius: "16px",
    fontFamily: "Tajawal, sans-serif",
    boxShadow: "0 8px 25px rgba(0,0,0,0.3)",
    zIndex: "999999",
    cursor: "pointer",
    opacity: "1",
    transition: "all 0.6s ease"
  });
  document.body.appendChild(bar);

  // ğŸµ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­
  if (window.soundAllowed) {
    const audio = new Audio("cash-register-kaching.mp3");
    audio.volume = 1.0;
    audio.play().catch(err => console.warn("ğŸ”‡ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err));
  }

  bar.addEventListener("mouseenter",()=>bar.style.transform="scale(1.05)");
  bar.addEventListener("mouseleave",()=>bar.style.transform="scale(1)");

  setTimeout(()=>{
    bar.style.opacity="0";
    bar.style.transform="translateY(20px)";
    setTimeout(()=>bar.remove(),600);
  },6000);

  const style=document.createElement("style");
  style.textContent=`
    @keyframes fadeInUp {
      from {opacity:0;transform:translateY(40px);}
      to {opacity:1;transform:translateY(0);}
    }`;
  document.head.appendChild(style);
}
// âŒ Ù„Ø§ ØªØ´ØªØºÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù†ÙØ³Ù‡Ø§
if (window.location.pathname.includes("orders.html")) {
  console.log("â¸ï¸ ØªØ¹Ø·ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±");
} else {

// âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
import("https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js").then(async ({ initializeApp }) => {
  const { getDatabase, ref, onValue } = await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js");
  const app = initializeApp({
    apiKey: "AIzaSyDtEJYJrmyP45qS2da8Cuc6y6Jv5VD0Uhc",
    authDomain: "almurad-system.firebaseapp.com",
    databaseURL: "https://almurad-system-default-rtdb.firebaseio.com/",
    projectId: "almurad-system",
    storageBucket: "almurad-system.appspot.com",
    messagingSenderId: "911755824405",
    appId: "1:911755824405:web:2bfbd18ddcf038ca48ad1c"
  });

  const db = getDatabase(app);
const ordersCountRef = ref(db, "orders");
  let previousCount = 0;

  // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶
onValue(ordersCountRef, (snapshot) => {
  if (!snapshot.exists()) return;
  const newCount = Object.keys(snapshot.val()).length;

  // Ù†ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ù…Ù† Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø¹Ø¯Ø¯ÙŠ (Ù…Ø§ Ù†Ù„Ù…Ø³ Ø§Ù„Ø·Ù„Ø¨Ø§Øª)
  if (previousCount && newCount > previousCount) {
    const diff = newCount - previousCount;
    showNewOrderNotification(diff);
  }

  previousCount = newCount;
}, { onlyOnce: false });

});

// âœ… ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† Ø§Ù„ØµÙˆØª Ø¨Ø¯ÙˆÙ† ØªØ´ØºÙŠÙ„ Ù…Ù„Ù
document.addEventListener("touchstart", function enableSoundOnce() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const source = ctx.createBufferSource();
    source.connect(ctx.destination);
  } catch (e) {
    console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯:", e);
  }
  window.soundAllowed = true;
  console.log("ğŸ”‡ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† Ø§Ù„ØµÙˆØª Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØµÙˆØª ÙØ¹Ù„ÙŠ");
  document.removeEventListener("touchstart", enableSoundOnce);
}, { once: true });
// âœ… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
window.showNotification = function (message, color = "#043B64") {
  const existing = document.querySelector(".notification");
  if (existing) existing.remove();

  const note = document.createElement("div");
  note.className = "notification";
  note.textContent = message;
  note.style.background = color;
  document.body.appendChild(note);

  // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¯Ø±ÙŠØ¬ÙŠ
  setTimeout(() => note.classList.add("show"), 100);

  // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
  setTimeout(() => {
    note.classList.remove("show");
    setTimeout(() => note.remove(), 400);
  }, 3000);
};
}


// ===============================
// ğŸ”ğŸ” Ù†Ø¸Ø§Ù… ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³
// ===============================
const tableContainer = document.querySelector(".table-container");
const table = tableContainer.querySelector("table");

let zoomLevel = 1; // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
const maxZoom = 2.5;
const minZoom = 0.2;

function applyZoom() {
  table.style.transform = `scale(${zoomLevel})`;
  table.style.transformOrigin = "top right";
}



// ğŸ” ØªÙƒØ¨ÙŠØ±
document.getElementById("zoomInBtn").addEventListener("click", () => {
  zoomLevel = Math.min(zoomLevel + 0.1, maxZoom);
  applyZoom();
});

// ğŸ” ØªØµØºÙŠØ±
document.getElementById("zoomOutBtn").addEventListener("click", () => {
  zoomLevel = Math.max(zoomLevel - 0.1, minZoom);
  applyZoom();
});


</script>

</body>
</html>